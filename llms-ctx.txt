FILE: _proc/00_db_host.html.md

# ğŸ  Multi-Tenant Setup


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

The **Host Database** is the backbone of a multi-tenant architecture. It
answers the critical questions:

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 26%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <strong>Who is this person?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td>Identity &amp; authentication</td>
</tr>
<tr>
<td>ğŸ¢ <strong>Where is their data?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td>Database routing</td>
</tr>
<tr>
<td>ğŸ”‘ <strong>What can they access?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td>Access control</td>
</tr>
<tr>
<td>ğŸ’³ <strong>Are they paying?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td>Billing status</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>What happened?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td>Security audit trail</td>
</tr>
<tr>
<td>âš™ï¸ <strong>Background work?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td>Async operations</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚         ğŸ  HOST DATABASE            â”‚
                        â”‚  (Single source of truth)           â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚  ğŸ‘¤ GlobalUser    â†’ Identity        â”‚
                        â”‚  ğŸ¢ TenantCatalog â†’ DB Routing      â”‚
                        â”‚  ğŸ”‘ Membership    â†’ Access Control  â”‚
                        â”‚  ğŸ’³ Subscription  â†’ Billing         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ—„ï¸ Tenant A   â”‚   â”‚ ğŸ—„ï¸ Tenant B   â”‚   â”‚ ğŸ—„ï¸ Tenant C   â”‚
        â”‚   Database    â”‚   â”‚   Database    â”‚   â”‚   Database    â”‚
        â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** User authenticates once â†’ Host routes to correct
tenant â†’ Tenant data is isolated

## ğŸ› ï¸ Utilities

Helper functions used throughout the host database operations.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### gen_id

>  gen_id ()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### timestamp

>  timestamp ()

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#timestamp"><code>timestamp()</code></a></td>
<td>ğŸ• Returns current UTC time in ISO format</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#gen_id"><code>gen_id()</code></a></td>
<td>ğŸ†” Generates a unique 32-character hex ID</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ“¦ Core Models

These dataclasses define the host database schema. Each model maps to a
table with the `core_` or `sys_` prefix.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L53"
target="_blank" style="float:right; font-size:smaller">source</a>

### SystemJob

>  SystemJob ()

*Maintenance: Provisioning & Cleanups*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L47"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostAuditLog

>  HostAuditLog ()

*Security: Who changed the system?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L40"
target="_blank" style="float:right; font-size:smaller">source</a>

### Subscription

>  Subscription ()

*Billing: Are they allowed to use the app?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L34"
target="_blank" style="float:right; font-size:smaller">source</a>

### Membership

>  Membership ()

*Router: Which tenants can they access?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L29"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantCatalog

>  TenantCatalog ()

*Registry: Where is the database?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L23"
target="_blank" style="float:right; font-size:smaller">source</a>

### GlobalUser

>  GlobalUser ()

*Identity: Who is this person?*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td><code>core_users</code></td>
<td><code>id</code></td>
<td>OAuth identity, email, optional password hash, Stripe customer
ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td><code>core_tenants</code></td>
<td><code>id</code></td>
<td>Maps tenant ID to database URL, tracks plan tier and status</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td><code>core_memberships</code></td>
<td><code>id</code></td>
<td>Links users to tenants with roles (<code>owner</code>,
<code>admin</code>, <code>member</code>)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td><code>core_subscriptions</code></td>
<td><code>id</code></td>
<td>Stripe subscription state for billing enforcement</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td><code>sys_audit_logs</code></td>
<td><code>id</code></td>
<td>Immutable security log for compliance</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td><code>sys_jobs</code></td>
<td><code>id</code></td>
<td>Background task queue for provisioning, cleanup</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”Œ HostDatabase Singleton

The
[`HostDatabase`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase)
class provides a **singleton** connection manager for the host database.

âœ… **Why Singleton?** - Single connection pool shared across the
application - Consistent transaction management - Easy dependency
injection for testing

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Application Start                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  HostDatabase.from_env() â”‚  â† Reads DB_* env vars
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Creates tables if    â”‚
             â”‚   they don't exist     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Returns singleton     â”‚  â† Same instance everywhere
             â”‚  instance              â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase

>  HostDatabase (db_url:str=None)

*Singleton connection manager for the host database.*

### ğŸ”§ Methods

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from_env()</code></td>
<td>ğŸ­ Factory method - creates instance from environment variables</td>
</tr>
<tr>
<td><code>commit()</code></td>
<td>âœ… Commit the current database transaction</td>
</tr>
<tr>
<td><code>rollback()</code></td>
<td>â†©ï¸ï¸ Rollback the current transaction on error</td>
</tr>
<tr>
<td><code>reset_instance()</code></td>
<td>ğŸ§ª Reset singleton (testing only)</td>
</tr>
</tbody>
</table>

#### ğŸŒ Environment Variables for `from_env()`

<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_TYPE</code></td>
<td><code>POSTGRESQL</code></td>
<td>Database type (<code>POSTGRESQL</code> or <code>SQLITE</code>)</td>
</tr>
<tr>
<td><code>DB_USER</code></td>
<td><code>postgres</code></td>
<td>Database username</td>
</tr>
<tr>
<td><code>DB_PASS</code></td>
<td><em>(required)</em></td>
<td>Database password</td>
</tr>
<tr>
<td><code>DB_HOST</code></td>
<td><code>localhost</code></td>
<td>Database host</td>
</tr>
<tr>
<td><code>DB_PORT</code></td>
<td><code>5432</code></td>
<td>Database port</td>
</tr>
<tr>
<td><code>DB_NAME</code></td>
<td><code>app_host</code></td>
<td>Database name</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L95"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.from_env

>  HostDatabase.from_env ()

*Create HostDatabase from DB\_* environment variables.\*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L114"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.commit

>  HostDatabase.commit ()

*Commit current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L118"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.rollback

>  HostDatabase.rollback ()

*Rollback current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L123"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.reset_instance

>  HostDatabase.reset_instance ()

*Reset singleton instance (testing only).*

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_host import HostDatabase, GlobalUser, gen_id, timestamp

# Initialize singleton from environment
host_db = HostDatabase.from_env()

# Create a user
user = GlobalUser(
    id=gen_id(),
    email="user@example.com",
    oauth_id="google_123",
    created_at=timestamp()
)
host_db.global_users.insert(user)
host_db.commit()

# Query users
all_users = host_db.global_users()
```

ğŸ’¡ **Tip:** The singleton ensures you always get the same connection, so
you can call
[`HostDatabase.from_env()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase.from_env)
anywhere in your app.


========================================

FILE: _proc/01_db_tenant.html.md

# ğŸ—„ï¸ Tenant Databases


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

Each tenant gets their own **isolated database** containing:

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td>Local user profiles linked to global identity</td>
</tr>
<tr>
<td>ğŸ” <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td>Fine-grained resource permissions</td>
</tr>
<tr>
<td>âš™ï¸ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td>Tenant-wide configuration</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      ğŸ  HOST DATABASE                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
    â”‚  â”‚ TenantCatalog â”‚ â”€â”€â–º Maps tenant_id â†’ database URL           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚  get_or_create_tenant_db(tenant_id)
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ğŸ—„ï¸ TENANT DATABASE                           â”‚
    â”‚                    (Isolated per tenant)                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ‘¤ TenantUser      â†’ Local profile (links to GlobalUser.id)   â”‚
    â”‚  ğŸ” TenantPermission â†’ Resource-level access control           â”‚
    â”‚  âš™ï¸ TenantSettings   â†’ Timezone, currency, feature flags       â”‚
    â”‚  ğŸª WebhookEvent     â†’ Idempotent webhook processing           â”‚
    â”‚  ğŸ”‘ WebhookSecret    â†’ HMAC secrets per webhook source         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ“Š [Your App Tables] â†’ Transactions, budgets, etc.            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** Tenant data is completely isolated â†’ No cross-tenant
data leakage possible

## ğŸ”Œ Tenant Connection

> âš ï¸ **Naming Convention**: Use **underscores** (not hyphens) in
> `tenant_id` values.
>
> Database names are derived from `tenant_id` (e.g., `tenant_acme_001` â†’
> `t_tenant_acme_001_db`). PostgreSQL and SQLite identifiers work best
> with alphanumeric characters and underscores.
>
> âœ… Good: `tenant_acme_001`, `tenant_finxplorer_prod` âŒ Avoid:
> `tenant-acme-001`, `tenant.finxplorer.prod`

``` python
from nbdev.showdoc import show_doc
```

[`get_or_create_tenant_db()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#get_or_create_tenant_db)
handles the full lifecycle:

1.  ğŸ” **Check** if tenant exists in host database
2.  ğŸ—„ï¸ **Create** physical database if new (PostgreSQL)
3.  ğŸ“ **Register** tenant in
    [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog)
4.  ğŸ”Œ **Return** connection to tenant database

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tenant_id</code></td>
<td>Unique tenant identifier (from <a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a>)</td>
</tr>
<tr>
<td><code>tenant_name</code></td>
<td>Optional display name (defaults to tenant_id)</td>
</tr>
</tbody>
</table>

**Returns:** `Database` connection to the tenantâ€™s isolated database

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_or_create_tenant_db

>  get_or_create_tenant_db (tenant_id:str, tenant_name:str=None)

*Get or create a tenant database connection by tenant ID.*

------------------------------------------------------------------------

## ğŸ“¦ Core Tenant Models

These models provide the infrastructure every tenant needs. Your
app-specific models (transactions, budgets, etc.) build on top of these.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L109"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantSettings

>  TenantSettings ()

*Tenant-wide configuration and feature flags.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L100"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantPermission

>  TenantPermission ()

*Fine-grained resource permission for a tenant user.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L91"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantUser

>  TenantUser ()

*Local user profile linked to GlobalUser in host database.*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td><code>core_tenant_users</code></td>
<td><code>id</code></td>
<td>Links to <code>GlobalUser.id</code>, stores local role &amp;
preferences</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td><code>core_permissions</code></td>
<td><code>id</code></td>
<td>Resource + action permissions (RBAC)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td><code>core_settings</code></td>
<td><code>id</code></td>
<td>Timezone, currency, feature flags</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”§ Schema Initialization

[`init_tenant_core_schema()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#init_tenant_core_schema)
creates all infrastructure tables in a tenant database:

    tenant_db = get_or_create_tenant_db("tenant_abc")
    tables = init_tenant_core_schema(tenant_db)

    # Access tables via returned dict
    tables['tenant_users'].insert(user)
    tables['settings'].insert(settings)

**Returns:** Dictionary of table accessors for all core models

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L119"
target="_blank" style="float:right; font-size:smaller">source</a>

### init_tenant_core_schema

>  init_tenant_core_schema (tenant_db:fastsql.core.Database)

*Create all core tenant tables and return table accessors.*

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_tenant import get_or_create_tenant_db, init_tenant_core_schema, TenantUser
from fh_saas.db_host import gen_id, timestamp

# Get or create tenant database
tenant_db = get_or_create_tenant_db("tenant_abc123", "Acme Corp")

# Initialize core schema
tables = init_tenant_core_schema(tenant_db)

# Add a tenant user (linked to GlobalUser.id)
user = TenantUser(
    id="global_user_xyz",  # Must match GlobalUser.id
    display_name="John Doe",
    local_role="admin",
    created_at=timestamp()
)
tables['tenant_users'].insert(user)
tenant_db.conn.commit()
```

ğŸ’¡ **Tip:** The `id` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
**must match** the `GlobalUser.id` from the host database to maintain
identity linking.

------------------------------------------------------------------------

## ğŸ” Role-Based Access Control (RBAC)

Every tenant has a **three-tier role system** for controlling access:

### Role Hierarchy

<table>
<thead>
<tr>
<th>Role</th>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin</code></td>
<td>3</td>
<td>Full access to all resources and settings</td>
</tr>
<tr>
<td><code>editor</code></td>
<td>2</td>
<td>Can view and modify data, but not settings</td>
</tr>
<tr>
<td><code>viewer</code></td>
<td>1</td>
<td>Read-only access to data</td>
</tr>
</tbody>
</table>

### Role Assignment Rules

1.  **Tenant owner** (from host `Membership.role='owner'`) â†’
    automatically gets `admin` role
2.  **Other users** â†’ assigned explicitly by admin via
    `TenantUser.local_role`
3.  **No defaults** â†’ admins must explicitly assign roles when inviting
    users

### TenantUser.local_role

The `local_role` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
stores the userâ€™s role within the tenant:

``` python
# Example: Admin adds a new user as editor
new_user = TenantUser(
    id=global_user_id,      # Must match GlobalUser.id
    display_name="Jane Doe",
    local_role="editor",    # Assigned by admin
    created_at=timestamp()
)
tables['tenant_users'].insert(new_user)
```

### Fine-Grained Permissions (Optional)

For advanced use cases, the `core_permissions` table allows
resource-level control:

``` python
# Example: Grant user edit access to transactions only
permission = TenantPermission(
    id=gen_id(),
    user_id=tenant_user.id,
    resource="transactions",
    action="edit",
    granted=True,
    created_at=timestamp()
)
tables['permissions'].insert(permission)
```

<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>resource</code></td>
<td>What the permission applies to (e.g., â€œtransactionsâ€,
â€œbudgetsâ€)</td>
</tr>
<tr>
<td><code>action</code></td>
<td>What action is allowed (e.g., â€œviewâ€, â€œeditâ€, â€œdeleteâ€)</td>
</tr>
<tr>
<td><code>granted</code></td>
<td>True = allowed, False = explicitly denied</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Tip:** Most apps only need the `local_role` field. Use
> `core_permissions` when you need per-resource control (e.g., â€œUser X
> can view transactions but not budgetsâ€).


========================================

FILE: _proc/15_utils_db.html.md

# ğŸ—„ï¸ Table Management


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table"><code>register_table</code></a></td>
<td>Create table from dataclass model</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables"><code>register_tables</code></a></td>
<td>Create multiple tables atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table"><code>drop_table</code></a></td>
<td>Drop table if exists</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index"><code>create_index</code></a></td>
<td>Create index with dialect-specific SQL</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index"><code>drop_index</code></a></td>
<td>Drop index if exists</td>
</tr>
<tr>
<td><code>list_tables</code></td>
<td>List all tables in database</td>
</tr>
<tr>
<td><code>list_indexes</code></td>
<td>List indexes for a table</td>
</tr>
</tbody>
</table>

## ğŸ“‹ Table Registration

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table"><code>register_table</code></a></td>
<td>Create single table from dataclass</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables"><code>register_tables</code></a></td>
<td>Create multiple tables atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table"><code>drop_table</code></a></td>
<td>Drop table if exists</td>
</tr>
</tbody>
</table>

**Example:**

``` python
class Transaction:
    id: str
    amount: float
    date: str
    category: str = None

tenant_db = get_or_create_tenant_db("tenant_123")
transactions = register_table(tenant_db, Transaction, "transactions")

# Use table object for CRUD
transactions.insert(Transaction(id="t1", amount=100.0, date="2024-01-01"))
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### register_table

>  register_table (tenant_db:fastsql.core.Database, model_class:Type,
>                      table_name:str, pk:str='id')

*Create a table from a dataclass model if it doesnâ€™t exist (atomic).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### register_tables

>  register_tables (tenant_db:fastsql.core.Database,
>                       models:List[Tuple[Type,str,str]])

*Create multiple tables atomically (all succeed or all rollback).*

**Parameters:** - `models`: List of tuples
`[(ModelClass, table_name, pk), ...]`

**Returns:** Dict mapping table names to table objects
`{table_name: table_object}`

**Example:**

``` python
class Transaction:
    id: str; amount: float; date: str

class Connection:
    id: str; provider: str; status: str

tables = register_tables(tenant_db, [
    (Transaction, "transactions", "id"),
    (Connection, "connections", "id"),
])

tables["transactions"].insert(...)
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### drop_table

>  drop_table (tenant_db:fastsql.core.Database, table_name:str)

*Drop a table if it exists (atomic operation).*

## ğŸ“‡ Index Management

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index"><code>create_index</code></a></td>
<td>Create index with dialect-specific SQL</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_indexes"><code>create_indexes</code></a></td>
<td>Create multiple indexes atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index"><code>drop_index</code></a></td>
<td>Drop index if exists</td>
</tr>
</tbody>
</table>

**Parameters for
[`create_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index):**

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>table_name</code></td>
<td>Name of the table</td>
</tr>
<tr>
<td><code>columns</code></td>
<td>List of column names to index</td>
</tr>
<tr>
<td><code>unique</code></td>
<td>If True, creates UNIQUE index (default: False)</td>
</tr>
<tr>
<td><code>index_name</code></td>
<td>Custom name (auto-generates <code>idx_{table}_{cols}</code> if
None)</td>
</tr>
</tbody>
</table>

**Example:**

``` python
# Simple index
create_index(tenant_db, "transactions", ["date"])

# Composite unique index
create_index(tenant_db, "transactions", ["account_id", "external_id"], unique=True)

# Custom name
create_index(tenant_db, "transactions", ["category"], index_name="idx_txn_cat")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L61"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_index

>  create_index (tenant_db:fastsql.core.Database, table_name:str,
>                    columns:List[str], unique:bool=False, index_name:str=None)

*Create an index on a table if it doesnâ€™t exist (atomic operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L83"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_indexes

>  create_indexes (tenant_db:fastsql.core.Database,
>                      indexes:List[Tuple[str,List[str],bool,Optional[str]]])

*Create multiple indexes atomically (all succeed or all rollback).*

**Parameters:** - `indexes`: List of tuples
`[(table_name, columns, unique, index_name), ...]` - `index_name` can be
`None` for auto-generated names

**Example:**

``` python
create_indexes(tenant_db, [
    ("transactions", ["date"], False, None),
    ("transactions", ["account_id", "external_id"], True, "idx_txn_unique"),
    ("connections", ["provider"], False, None),
])
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L107"
target="_blank" style="float:right; font-size:smaller">source</a>

### drop_index

>  drop_index (tenant_db:fastsql.core.Database, index_name:str,
>                  table_name:str=None)

*Drop an index if it exists (atomic operation).*

## ğŸ” Schema Introspection

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#table_exists"><code>table_exists</code></a></td>
<td>Check if a table exists</td>
</tr>
</tbody>
</table>

**Example:**

``` python
if not table_exists(tenant_db, "transactions"):
    transactions = register_table(tenant_db, Transaction, "transactions")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L127"
target="_blank" style="float:right; font-size:smaller">source</a>

### table_exists

>  table_exists (tenant_db:fastsql.core.Database, table_name:str)

*Check if a table exists in the database.*

## Usage Example

Complete workflow: Define dataclass models â†’ Get tenant DB â†’ Register
tables â†’ Create indexes


========================================

FILE: _proc/04_utils_auth.html.md

# ğŸ” Authentication


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ›¡ï¸ Beforeware</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware"><code>create_auth_beforeware</code></a></td>
<td>Protect routes, auto-setup tenant DB</td>
</tr>
<tr>
<td>ğŸ”‘ OAuth Client</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client"><code>get_google_oauth_client</code></a></td>
<td>Initialize Google OAuth</td>
</tr>
<tr>
<td>ğŸ”’ CSRF</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state"><code>generate_oauth_state</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state"><code>verify_oauth_state</code></a></td>
<td>Prevent session hijacking</td>
</tr>
<tr>
<td>ğŸ‘¤ Users</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user"><code>create_or_get_global_user</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership"><code>get_user_membership</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership"><code>verify_membership</code></a></td>
<td>User &amp; membership management</td>
</tr>
<tr>
<td>ğŸ—ï¸ Provisioning</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user"><code>provision_new_user</code></a></td>
<td>Auto-create tenant for new users</td>
</tr>
<tr>
<td>ğŸ“‹ Session</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session"><code>create_user_session</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user"><code>get_current_user</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session"><code>clear_session</code></a></td>
<td>Session management</td>
</tr>
<tr>
<td>ğŸš¦ Routing</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login"><code>route_user_after_login</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access"><code>require_tenant_access</code></a></td>
<td>Authorization &amp; routing</td>
</tr>
<tr>
<td>ğŸŒ Handlers</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request"><code>handle_login_request</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback"><code>handle_oauth_callback</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout"><code>handle_logout</code></a></td>
<td>Route implementations</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    OAuth Authentication Flow                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. User clicks "Login with Google"                             â”‚
    â”‚  2. Generate CSRF state token â†’ store in session                â”‚
    â”‚  3. Redirect to Google OAuth                                    â”‚
    â”‚  4. Google authenticates â†’ redirects with code + state          â”‚
    â”‚  5. Verify CSRF state matches session                           â”‚
    â”‚  6. Exchange code for user info                                 â”‚
    â”‚  7. Create/get GlobalUser in host DB                            â”‚
    â”‚  8. Check membership OR auto-provision new tenant               â”‚
    â”‚  9. Create session â†’ redirect to dashboard                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       Tenant Model                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Many Users â†’ One Tenant (many-to-one)                          â”‚
    â”‚  Each user belongs to exactly ONE tenant                        â”‚
    â”‚  Each tenant can have MANY users                                â”‚
    â”‚  New users auto-create their own tenant                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Security Features

<table>
<thead>
<tr>
<th>Feature</th>
<th>Protection</th>
</tr>
</thead>
<tbody>
<tr>
<td>CSRF State Token</td>
<td>Prevents session hijacking attacks</td>
</tr>
<tr>
<td>Membership Validation</td>
<td>Ensures cross-tenant isolation</td>
</tr>
<tr>
<td>Audit Logging</td>
<td>Tracks all authentication events</td>
</tr>
</tbody>
</table>

### Token Expiry

<table>
<thead>
<tr>
<th>Token Type</th>
<th>Expiry</th>
<th>Current Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Google OAuth</td>
<td>1 hour</td>
<td>User must re-login</td>
</tr>
<tr>
<td>Session</td>
<td>Configurable</td>
<td>Starlette signed cookie</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Future**: Implement refresh token flow for seamless
> re-authentication

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

## ğŸ­ Role-Based Access Control

Control access based on user roles within the tenant.

### Role Hierarchy

<table>
<thead>
<tr>
<th>Role</th>
<th>Level</th>
<th>Automatic For</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin</code></td>
<td>3</td>
<td>Tenant owners</td>
</tr>
<tr>
<td><code>editor</code></td>
<td>2</td>
<td>â€”</td>
</tr>
<tr>
<td><code>viewer</code></td>
<td>1</td>
<td>â€”</td>
</tr>
</tbody>
</table>

### Key Functions

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#has_min_role"><code>has_min_role</code></a></td>
<td>Check if user meets minimum role requirement</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_role"><code>require_role</code></a></td>
<td>Route decorator for role-based protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_role"><code>get_user_role</code></a></td>
<td>Derive effective role from session + tenant DB</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L46"
target="_blank" style="float:right; font-size:smaller">source</a>

### has_min_role

>  has_min_role (user:dict, required_role:str)

*Check if user meets the minimum role requirement.*

Args: user: User dict with â€˜roleâ€™ field (from request.state.user)
required_role: Minimum role needed (â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™)

Returns: True if userâ€™s role \>= required_role in hierarchy

Example: \>\>\> user = {â€˜roleâ€™: â€˜editorâ€™} \>\>\> has_min_role(user,
â€˜viewerâ€™) \# True - editor \> viewer \>\>\> has_min_role(user, â€˜adminâ€™)
\# False - editor \< admin

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L67"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_role

>  get_user_role (session:dict, tenant_db:fastsql.core.Database=None)

*Derive effective role from session and tenant database.*

Rules: 1. Tenant owner (session\[â€˜tenant_roleâ€™\] == â€˜ownerâ€™) â†’ â€˜adminâ€™
2. System admin â†’ â€˜adminâ€™ 3. Otherwise â†’ lookup TenantUser.local_role
from tenant DB 4. Fallback â†’ None (user must be explicitly assigned a
role)

Args: session: User session dict tenant_db: Tenant database connection
(optional)

Returns: Effective role string: â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™, or None

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L112"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_role

>  require_role (min_role:str)

*Decorator to protect routes with minimum role requirement.*

Args: min_role: Minimum role required (â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™)

Returns: Decorator that checks request.state.user\[â€˜roleâ€™\] Returns 403
Forbidden if user lacks required role

Example: \>\>\> @app.get(â€˜/admin/settingsâ€™) \>\>\>
@require_role(â€˜adminâ€™) \>\>\> def admin_settings(request): â€¦ return
â€œAdmin only contentâ€

    >>> @app.get('/reports')  
    >>> @require_role('viewer')  # All authenticated users
    >>> def view_reports(request):
    ...     return "Reports"

### Usage in Routes

``` python
from fh_saas.utils_auth import require_role, has_min_role

# Option 1: Decorator for route-level protection
@app.get('/admin/users')
@require_role('admin')
def manage_users(request):
    return "Admin-only user management"

@app.get('/dashboard')
@require_role('viewer')  # All roles can access
def dashboard(request):
    return "Dashboard for all users"

# Option 2: Inline check for conditional logic
@app.get('/data')
def view_data(request):
    user = request.state.user
    
    if has_min_role(user, 'admin'):
        return "All data with admin controls"
    elif has_min_role(user, 'editor'):
        return "Data with edit buttons"
    else:
        return "Read-only data view"
```

### Role Derivation Flow

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Role Derivation (in beforeware)              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. Check session['tenant_role']                                â”‚
    â”‚     â””â”€â”€ If 'owner' â†’ effective role = 'admin'                  â”‚
    â”‚                                                                 â”‚
    â”‚  2. Check session['is_sys_admin']                               â”‚
    â”‚     â””â”€â”€ If True â†’ effective role = 'admin'                     â”‚
    â”‚                                                                 â”‚
    â”‚  3. Lookup TenantUser.local_role in tenant DB                   â”‚
    â”‚     â””â”€â”€ Returns assigned role or None                          â”‚
    â”‚                                                                 â”‚
    â”‚  4. Attach to request.state.user['role']                        â”‚
    â”‚     â””â”€â”€ Used by require_role() and has_min_role()              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ›¡ï¸ Auth Beforeware

Protect routes by checking for authenticated sessions with auto tenant
DB setup.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware"><code>create_auth_beforeware</code></a></td>
<td>Factory to create route protection middleware</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Pass to FastHTMLâ€™s `before=` parameter for app-wide
> authentication

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L180"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_auth_beforeware

>  create_auth_beforeware (redirect_path:str='/login',
>                              session_key:str='user_id', skip:list[str]=None,
>                              include_defaults:bool=True,
>                              setup_tenant_db:bool=True, schema_init:Callable[[
>                              fastsql.core.Database],dict[str,Any]]=None)

*Create Beforeware that checks for authenticated session and sets up
request.state.*

Args: redirect_path: Where to redirect unauthenticated users
session_key: Session key for user ID skip: List of regex patterns to
skip auth include_defaults: Include default skip patterns
setup_tenant_db: Auto-setup tenant database on request.state
schema_init: Optional callback to initialize tables dict. Signature:
(tenant_db: Database) -\> dict\[str, Table\] Result stored in
request.state.tables

Returns: Beforeware instance for FastHTML apps

Sets on request.state: - user: dict with user_id, email, tenant_id,
role, is_owner - tenant_id: str - tenant_db: Database connection -
tables: dict of Table objects (if schema_init provided)

Example: \>\>\> def get_app_tables(db): â€¦ return {â€˜usersâ€™:
db.create(User, pk=â€˜idâ€™)} \>\>\> beforeware =
create_auth_beforeware(schema_init=get_app_tables) \>\>\> \# In routes:
request.state.user\[â€˜roleâ€™\], request.state.tables\[â€˜usersâ€™\]

------------------------------------------------------------------------

## ğŸ”‘ OAuth Client

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client"><code>get_google_oauth_client</code></a></td>
<td>Initialize Google OAuth client from env vars</td>
</tr>
</tbody>
</table>

> âš ï¸ **Required env vars**: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L260"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_google_oauth_client

>  get_google_oauth_client ()

*Initialize Google OAuth client with credentials from environment.*

------------------------------------------------------------------------

## ğŸ”’ CSRF Protection

Prevent session hijacking via state token validation.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state"><code>generate_oauth_state</code></a></td>
<td>Create random UUID for CSRF protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state"><code>verify_oauth_state</code></a></td>
<td>Validate callback state matches session</td>
</tr>
</tbody>
</table>

### Attack Without CSRF Protection

    1. Attacker initiates OAuth â†’ gets auth code
    2. Attacker sends victim: yourapp.com/auth/callback?code=ATTACKER_CODE
    3. Victim clicks â†’ session created for attacker's account
    4. Victim enters data â†’ attacker sees it all

> ğŸ›¡ï¸ **Solution**: State token generated at login, verified at callback

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L276"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_oauth_state

>  verify_oauth_state (session:dict, callback_state:str)

*Verify OAuth callback state matches stored session state (CSRF
protection).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L271"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_oauth_state

>  generate_oauth_state ()

*Generate cryptographically secure random state token for CSRF
protection.*

------------------------------------------------------------------------

## ğŸ‘¤ User Management

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user"><code>create_or_get_global_user</code></a></td>
<td>Create or retrieve user from host DB</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership"><code>get_user_membership</code></a></td>
<td>Get userâ€™s active tenant membership</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership"><code>verify_membership</code></a></td>
<td>Validate user has access to tenant</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L328"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_membership

>  verify_membership (host_db:fh_saas.db_host.HostDatabase, user_id:str,
>                         tenant_id:str)

*Verify user has active membership for specific tenant.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L320"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_membership

>  get_user_membership (host_db:fh_saas.db_host.HostDatabase, user_id:str)

*Get single active membership for user.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L289"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_or_get_global_user

>  create_or_get_global_user (host_db:fh_saas.db_host.HostDatabase,
>                                 oauth_id:str, email:str, oauth_info:dict=None)

*Create or retrieve GlobalUser from host database.*

------------------------------------------------------------------------

## ğŸ—ï¸ Auto-Provisioning

Create tenant infrastructure for first-time users.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user"><code>provision_new_user</code></a></td>
<td>Create tenant DB, catalog entry, membership, and TenantUser</td>
</tr>
</tbody>
</table>

### Provisioning Steps

    1. Create physical tenant database (PostgreSQL/SQLite)
    2. Register tenant in host catalog
    3. Create membership (user â†’ tenant, role='owner')
    4. Create TenantUser profile (local_role='admin')
    5. Initialize core tenant schema
    6. Log audit event

> ğŸ’¡ **Future**: Insert payment screen before step 1

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L336"
target="_blank" style="float:right; font-size:smaller">source</a>

### provision_new_user

>  provision_new_user (host_db:fh_saas.db_host.HostDatabase,
>                          global_user:fh_saas.db_host.GlobalUser)

*Auto-provision new tenant for first-time user.*

------------------------------------------------------------------------

## ğŸ“‹ Session Management

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session"><code>create_user_session</code></a></td>
<td>Populate session after successful OAuth</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user"><code>get_current_user</code></a></td>
<td>Extract user info from session</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session"><code>clear_session</code></a></td>
<td>Clear all session data (logout)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L428"
target="_blank" style="float:right; font-size:smaller">source</a>

### clear_session

>  clear_session (session:dict)

*Clear all session data (logout).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L405"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_current_user

>  get_current_user (session:dict)

*Extract current user info from session.*

Returns: dict with keys: user_id, email, tenant_id, tenant_role,
is_sys_admin

Note: The â€˜roleâ€™ and â€˜is_ownerâ€™ fields are added by
create_auth_beforeware after deriving the effective role from
TenantUser.local_role. Access via request.state.user\[â€˜roleâ€™\] in
routes.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L395"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_user_session

>  create_user_session (session:dict,
>                           global_user:fh_saas.db_host.GlobalUser,
>                           membership:fh_saas.db_host.Membership)

*Create authenticated session after successful OAuth login.*

------------------------------------------------------------------------

## ğŸš¦ Route Helpers

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login"><code>route_user_after_login</code></a></td>
<td>Determine redirect URL based on user type</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access"><code>require_tenant_access</code></a></td>
<td>Get tenant DB with membership validation</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L442"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_tenant_access

>  require_tenant_access (request_or_session)

*Get tenant database with membership validation.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L433"
target="_blank" style="float:right; font-size:smaller">source</a>

### route_user_after_login

>  route_user_after_login (global_user:fh_saas.db_host.GlobalUser,
>                              membership:fh_saas.db_host.Membership=None)

*Determine redirect URL based on user type and membership.*

## ğŸŒ OAuth Route Handlers

Complete OAuth 2.0 flow handlers:

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request"><code>handle_login_request</code></a></td>
<td>Initiate OAuth with CSRF protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback"><code>handle_oauth_callback</code></a></td>
<td>Process provider response</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout"><code>handle_logout</code></a></td>
<td>Clear session and redirect</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L524"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_logout

>  handle_logout (session)

*Clear session and redirect to login page.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L480"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_oauth_callback

>  handle_oauth_callback (code:str, state:str, request, session)

*Complete OAuth flow: CSRF verify â†’ user info â†’ provision â†’ session â†’
redirect.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L464"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_login_request

>  handle_login_request (request, session)

*Generate Google OAuth URL with CSRF state protection.*


========================================

FILE: _proc/06_utils_log.html.md

# ğŸ“Š Logging


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging</code></a></td>
<td>One-time setup at app startup</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ“‹ Environment Variables

<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FH_SAAS_LOG_LEVEL</code></td>
<td>WARNING</td>
<td>DEBUG, INFO, WARNING, ERROR</td>
</tr>
<tr>
<td><code>FH_SAAS_LOG_FILE</code></td>
<td>(none)</td>
<td>Path to log file (optional)</td>
</tr>
</tbody>
</table>

## âš™ï¸ configure_logging

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_log.py#L15"
target="_blank" style="float:right; font-size:smaller">source</a>

### configure_logging

>  configure_logging (log_file:str=None, level:str=None,
>                         max_bytes:int=10000000, backup_count:int=5)

*Configure logging for all fh_saas modules - call once at app startup.*

## ğŸ“– Usage Examples

### 1. App Startup (call once in main.py)

``` python
from fh_saas.utils_log import configure_logging

# Option A: Use environment variables (recommended for production)
# Set FH_SAAS_LOG_LEVEL=INFO and FH_SAAS_LOG_FILE=./logs/app.log in .env
configure_logging()

# Option B: Explicit - console only
configure_logging(level='INFO')

# Option C: Console + rotating file
configure_logging(level='INFO', log_file='./logs/app.log')
```

### 2. In Any fh_saas Module (already done)

Every module in fh_saas declares a logger at the top:

``` python
# fh_saas/utils_oauth.py
import logging
logger = logging.getLogger(__name__)

def handle_login_request(request, session):
    logger.debug('Login request initiated')
    # ... do work ...
    logger.info(f'OAuth complete, redirecting to {redirect_url}')
```

### 3. Where Do Logs Go?

<table>
<colgroup>
<col style="width: 48%" />
<col style="width: 31%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>Configuration</th>
<th>Console</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging()</code></a></td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>configure_logging(log_file='app.log')</code></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>No <a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging()</code></a>
call</td>
<td>âŒ silent</td>
<td>âŒ</td>
</tr>
</tbody>
</table>

### 4. Log Levels

<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 44%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Level</th>
<th>When to Use</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DEBUG</code></td>
<td>Detailed diagnostic</td>
<td><code>logger.debug('Checking user session')</code></td>
</tr>
<tr>
<td><code>INFO</code></td>
<td>Normal operations</td>
<td><code>logger.info('User logged in')</code></td>
</tr>
<tr>
<td><code>WARNING</code></td>
<td>Unexpected but not failing</td>
<td><code>logger.warning('Token expiring soon')</code></td>
</tr>
<tr>
<td><code>ERROR</code></td>
<td>Operation failed</td>
<td><code>logger.error('Auth failed', exc_info=True)</code></td>
</tr>
</tbody>
</table>

### 5. Real Example from fh_saas

``` python
# In your FastHTML app
from fasthtml.common import *
from fh_saas.utils_log import configure_logging
from fh_saas.utils_oauth import handle_login_request, handle_oauth_callback

# Configure logging ONCE at startup
configure_logging(level='INFO', log_file='./logs/app.log')

app = FastHTML()

@app.get('/login')
def login(request, session):
    return handle_login_request(request, session)  # Logs automatically

@app.get('/auth/callback') 
def callback(code: str, state: str, request, session):
    return handle_oauth_callback(code, state, request, session)  # Logs automatically
```

Output in console and file:

    2026-01-10 14:30:00 | fh_saas.utils_oauth | DEBUG | Login request initiated
    2026-01-10 14:30:05 | fh_saas.utils_oauth | DEBUG | OAuth callback received
    2026-01-10 14:30:05 | fh_saas.utils_oauth | INFO | OAuth complete, redirecting to /dashboard


========================================

FILE: _proc/07_utils_api.html.md

# ğŸŒ HTTP Client


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 36%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ”„ Client</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient"><code>AsyncAPIClient</code></a></td>
<td>Async HTTP with retry</td>
</tr>
<tr>
<td>ğŸ”‘ Auth</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth"><code>bearer_token_auth</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth"><code>api_key_auth</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth"><code>oauth_token_auth</code></a></td>
<td>Auth header generators</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Retry Logic Flow                             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Request â†’ Response                                             â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Status 429 or 500+ â†’ Retry (exponential: 2s, 4s, 8s)          â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Status 400-499 (except 429) â†’ Fail immediately                â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Network error â†’ Retry                                          â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Max 3 attempts â†’ Raise exception                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ”„ AsyncAPIClient

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient"><code>AsyncAPIClient</code></a></td>
<td>Async HTTP client with retry</td>
</tr>
<tr>
<td><code>.request()</code></td>
<td>Execute HTTP request with retry</td>
</tr>
<tr>
<td><code>.get_json()</code></td>
<td>GET request returning JSON</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L28"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient

>  AsyncAPIClient (base_url:str, auth_headers:dict=None, timeout:int=30)

*Async HTTP client with retry logic for external API integrations.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L31"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.\_\_init\_\_

>  AsyncAPIClient.__init__ (base_url:str, auth_headers:dict=None,
>                               timeout:int=30)

*Initialize client with base URL, optional auth headers, and timeout.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L63"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.request

>  AsyncAPIClient.request (method:str, endpoint:str, params:dict=None,
>                              json:dict=None, headers:dict=None)

*Execute HTTP request with automatic retry on 429/500+ errors.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.get_json

>  AsyncAPIClient.get_json (endpoint:str, params:dict=None)

*Convenience GET that returns parsed JSON.*

## ğŸ”‘ Auth Helpers

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth"><code>bearer_token_auth</code></a></td>
<td>Bearer token header</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth"><code>api_key_auth</code></a></td>
<td>API key header (customizable)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth"><code>oauth_token_auth</code></a></td>
<td>OAuth 2.0 access token</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L97"
target="_blank" style="float:right; font-size:smaller">source</a>

### bearer_token_auth

>  bearer_token_auth (token:str)

*Generate Bearer token authentication header.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### api_key_auth

>  api_key_auth (api_key:str, header_name:str='X-API-Key')

*Generate API key header with customizable header name.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L107"
target="_blank" style="float:right; font-size:smaller">source</a>

### oauth_token_auth

>  oauth_token_auth (access_token:str)

*Generate OAuth 2.0 access token header (alias for bearer_token_auth).*


========================================

FILE: _proc/08_utils_graphql.html.md

# ğŸ”® GraphQL Client


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_graphql.html#graphqlclient"><code>GraphQLClient</code></a></td>
<td>GraphQL client with async generator pagination</td>
</tr>
<tr>
<td><code>.execute_query()</code></td>
<td>Execute single query</td>
</tr>
<tr>
<td><code>.execute_mutation()</code></td>
<td>Execute mutation</td>
</tr>
<tr>
<td><code>.fetch_pages_generator()</code></td>
<td>Stream paginated data</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Streaming Pagination Flow                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Page 1: query($cursor: null) â†’ yield [batch] â†’ process        â”‚
    â”‚  Page 2: query($cursor: xyz)  â†’ yield [batch] â†’ process        â”‚
    â”‚  Page N: query($cursor: abc)  â†’ yield [batch] â†’ process        â”‚
    â”‚                                                                 â”‚
    â”‚  âš ï¸ CRITICAL: Never accumulates full dataset in memory         â”‚
    â”‚  âœ… Memory: O(page_size) not O(total_records)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ”® GraphQLClient

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.execute_query()</code></td>
<td>Execute single GraphQL query</td>
</tr>
<tr>
<td><code>.execute_mutation()</code></td>
<td>Execute GraphQL mutation</td>
</tr>
<tr>
<td><code>.fetch_pages_generator()</code></td>
<td>Async generator for paginated data</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

### Usage Example

``` python
from fh_saas.utils_api import AsyncAPIClient, bearer_token_auth
from fh_saas.utils_graphql import GraphQLClient

async with AsyncAPIClient(
    'https://api.example.com/graphql',
    auth_headers=bearer_token_auth('TOKEN')
) as http_client:
    
    client = GraphQLClient(http_client)
    
    # Single query
    result = await client.execute_query(
        query='{ users { id name } }'
    )
    
    # Paginated streaming (memory-efficient)
    async for batch in client.fetch_pages_generator(
        query_template='''
            query($cursor: String) {
                users(after: $cursor, first: 1000) {
                    nodes { id name email }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        variables={'cursor': None},
        items_path=['data', 'users', 'nodes'],
        cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
        has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
    ):
        print(f"Processing batch of {len(batch)} records")
        # Process batch immediately - never load full dataset
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L18"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient

>  GraphQLClient (api_client:fh_saas.utils_api.AsyncAPIClient,
>                     endpoint:str='')

*GraphQL client with streaming pagination for memory-efficient data
fetching.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>api_client</td>
<td>AsyncAPIClient</td>
<td></td>
<td>Initialized AsyncAPIClient instance</td>
</tr>
<tr>
<td>endpoint</td>
<td>str</td>
<td></td>
<td>GraphQL endpoint path (default: â€™â€™ for base URL)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.\_\_init\_\_

>  GraphQLClient.__init__ (api_client:fh_saas.utils_api.AsyncAPIClient,
>                              endpoint:str='')

*Initialize self. See help(type(self)) for accurate signature.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>api_client</td>
<td>AsyncAPIClient</td>
<td></td>
<td>Initialized AsyncAPIClient instance</td>
</tr>
<tr>
<td>endpoint</td>
<td>str</td>
<td></td>
<td>GraphQL endpoint path (default: â€™â€™ for base URL)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L29"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.execute_query

>  GraphQLClient.execute_query (query:str, variables:dict=None)

*Execute a single GraphQL query and return the JSON response.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>query</td>
<td>str</td>
<td></td>
<td>GraphQL query string</td>
</tr>
<tr>
<td>variables</td>
<td>dict</td>
<td>None</td>
<td>Query variables</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L54"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.execute_mutation

>  GraphQLClient.execute_mutation (mutation:str, variables:dict=None)

*Execute a GraphQL mutation (alias for execute_query).*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>mutation</td>
<td>str</td>
<td></td>
<td>GraphQL mutation string</td>
</tr>
<tr>
<td>variables</td>
<td>dict</td>
<td>None</td>
<td>Mutation variables</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.fetch_pages_generator

>  GraphQLClient.fetch_pages_generator (query_template:str, variables:dict,
>                                           items_path:list[str],
>                                           cursor_path:list[str],
>                                           has_next_path:list[str]=None,
>                                           cursor_var:str='cursor')

*Stream paginated GraphQL data page-by-page using async generator.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>query_template</td>
<td>str</td>
<td></td>
<td>GraphQL query with $variables placeholders</td>
</tr>
<tr>
<td>variables</td>
<td>dict</td>
<td></td>
<td>Initial variables (must include cursor key)</td>
</tr>
<tr>
<td>items_path</td>
<td>list</td>
<td></td>
<td>JSONPath to list of items (e.g., [â€˜dataâ€™, â€˜usersâ€™, â€˜nodesâ€™])</td>
</tr>
<tr>
<td>cursor_path</td>
<td>list</td>
<td></td>
<td>JSONPath to next cursor (e.g., [â€˜dataâ€™, â€˜usersâ€™, â€˜pageInfoâ€™,
â€˜endCursorâ€™])</td>
</tr>
<tr>
<td>has_next_path</td>
<td>list</td>
<td>None</td>
<td>Optional path to hasNextPage boolean (if None, checks cursor !=
None)</td>
</tr>
<tr>
<td>cursor_var</td>
<td>str</td>
<td>cursor</td>
<td>Variable name for cursor in query (default: â€˜cursorâ€™)</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>AsyncGenerator</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

### Streaming Pagination Details

**Why use generators?** For large datasets (millions of rows),
accumulating all data in memory causes OOM errors. The async generator
yields batches instead.

**Parameters:**

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>query_template</code></td>
<td>GraphQL query with <code>$cursor</code> variable</td>
</tr>
<tr>
<td><code>variables</code></td>
<td>Initial variables dict (e.g., <code>{'cursor': None}</code>)</td>
</tr>
<tr>
<td><code>items_path</code></td>
<td>Path to data list in response (e.g.,
<code>['data', 'users', 'nodes']</code>)</td>
</tr>
<tr>
<td><code>cursor_path</code></td>
<td>Path to next cursor (e.g.,
<code>['data', 'users', 'pageInfo', 'endCursor']</code>)</td>
</tr>
<tr>
<td><code>has_next_path</code></td>
<td>Optional path to <code>hasNextPage</code> flag</td>
</tr>
<tr>
<td><code>cursor_var</code></td>
<td>Cursor variable name in query (default: <code>'cursor'</code>)</td>
</tr>
</tbody>
</table>

**Example with database insert:**

``` python
async for batch in client.fetch_pages_generator(
    query_template='''
        query($cursor: String) {
            users(after: $cursor, first: 1000) {
                nodes { id name }
                pageInfo { hasNextPage endCursor }
            }
        }
    ''',
    variables={'cursor': None},
    items_path=['data', 'users', 'nodes'],
    cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
    has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
):
    # Process each batch immediately
    df = pl.DataFrame(batch)
    df.write_database('staging_table', connection=conn)
```


========================================

FILE: _proc/14_utils_webhook.html.md

# ğŸª Webhooks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 signature verification</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Prevent duplicate processing</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Webhook Processing Flow                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Request â†’ Verify Signature â†’ Check Idempotency â†’ Log Event    â”‚
    â”‚     â†“           âœ…              âœ… (not duplicate)              â”‚
    â”‚  Execute Handler â†’ Update Status â†’ Return Response              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ” Signature Verification

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 with timing-safe comparison</td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import *
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

>  verify_webhook_signature (payload:str, signature:str,
>                                secret:Optional[str]=None)

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>payload</td>
<td>str</td>
<td></td>
<td>Raw request body as string</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Signature from header (format: â€œsha256=<hex>â€)</td>
</tr>
<tr>
<td>secret</td>
<td>Optional</td>
<td>None</td>
<td>Secret key, defaults to WEBHOOK_SECRET env var</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ”„ Idempotency

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Check if event already processed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

>  check_idempotency (db:fastsql.core.Database, idempotency_key:str)

*Check if webhook event already processed. Returns True if duplicate.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td>Unique key for this webhook event</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ“ Event Logging

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#update_webhook_status"><code>update_webhook_status</code></a></td>
<td>Update status after processing</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

>  log_webhook_event (db:fastsql.core.Database, webhook_id:str, source:str,
>                         event_type:str, payload:Dict[str,Any], signature:str,
>                         idempotency_key:str, status:str='pending')

*Log webhook event to database*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Unique webhook ID</td>
</tr>
<tr>
<td>source</td>
<td>str</td>
<td></td>
<td>Source system (e.g., â€œstripeâ€, â€œgithubâ€)</td>
</tr>
<tr>
<td>event_type</td>
<td>str</td>
<td></td>
<td>Event type (e.g., â€œpayment.successâ€)</td>
</tr>
<tr>
<td>payload</td>
<td>Dict</td>
<td></td>
<td>Full webhook payload</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Request signature</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td></td>
<td>Idempotency key</td>
</tr>
<tr>
<td>status</td>
<td>str</td>
<td>pending</td>
<td>Status: pending, processing, completed, failed</td>
</tr>
</tbody>
</table>

## Update Webhook Status

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

>  update_webhook_status (db:fastsql.core.Database, webhook_id:str,
>                             status:str, error_message:Optional[str]=None)

*Update webhook event status and processed timestamp*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Webhook ID to update</td>
</tr>
<tr>
<td>status</td>
<td>str</td>
<td></td>
<td>New status</td>
</tr>
<tr>
<td>error_message</td>
<td>Optional</td>
<td>None</td>
<td>Optional error message</td>
</tr>
</tbody>
</table>

## âš¡ Process Webhook

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

>  process_webhook (db:fastsql.core.Database, webhook_id:str, source:str,
>                       event_type:str, payload:Dict[str,Any], signature:str,
>                       idempotency_key:str, raw_body:str, handler:Callable,
>                       secret:Optional[str]=None)

*Process webhook with verification, idempotency, and custom handler
execution*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Unique webhook ID</td>
</tr>
<tr>
<td>source</td>
<td>str</td>
<td></td>
<td>Source system</td>
</tr>
<tr>
<td>event_type</td>
<td>str</td>
<td></td>
<td>Event type</td>
</tr>
<tr>
<td>payload</td>
<td>Dict</td>
<td></td>
<td>Webhook payload</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Request signature</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td></td>
<td>Idempotency key</td>
</tr>
<tr>
<td>raw_body</td>
<td>str</td>
<td></td>
<td>Raw request body for signature verification</td>
</tr>
<tr>
<td>handler</td>
<td>Callable</td>
<td></td>
<td>App-specific webhook handler function</td>
</tr>
<tr>
<td>secret</td>
<td>Optional</td>
<td>None</td>
<td>Optional webhook secret</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

>  verify_webhook_signature (payload:str, signature:str,
>                                secret:Optional[str]=None)

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>payload</td>
<td>str</td>
<td></td>
<td>Raw request body as string</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Signature from header (format: â€œsha256=<hex>â€)</td>
</tr>
<tr>
<td>secret</td>
<td>Optional</td>
<td>None</td>
<td>Secret key, defaults to WEBHOOK_SECRET env var</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

>  check_idempotency (db:fastsql.core.Database, idempotency_key:str)

*Check if webhook event already processed. Returns True if duplicate.*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td>Unique key for this webhook event</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>bool</strong></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

>  log_webhook_event (db:fastsql.core.Database, webhook_id:str, source:str,
>                         event_type:str, payload:Dict[str,Any], signature:str,
>                         idempotency_key:str, status:str='pending')

*Log webhook event to database*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Unique webhook ID</td>
</tr>
<tr>
<td>source</td>
<td>str</td>
<td></td>
<td>Source system (e.g., â€œstripeâ€, â€œgithubâ€)</td>
</tr>
<tr>
<td>event_type</td>
<td>str</td>
<td></td>
<td>Event type (e.g., â€œpayment.successâ€)</td>
</tr>
<tr>
<td>payload</td>
<td>Dict</td>
<td></td>
<td>Full webhook payload</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Request signature</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td></td>
<td>Idempotency key</td>
</tr>
<tr>
<td>status</td>
<td>str</td>
<td>pending</td>
<td>Status: pending, processing, completed, failed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

>  update_webhook_status (db:fastsql.core.Database, webhook_id:str,
>                             status:str, error_message:Optional[str]=None)

*Update webhook event status and processed timestamp*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Webhook ID to update</td>
</tr>
<tr>
<td>status</td>
<td>str</td>
<td></td>
<td>New status</td>
</tr>
<tr>
<td>error_message</td>
<td>Optional</td>
<td>None</td>
<td>Optional error message</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

>  process_webhook (db:fastsql.core.Database, webhook_id:str, source:str,
>                       event_type:str, payload:Dict[str,Any], signature:str,
>                       idempotency_key:str, raw_body:str, handler:Callable,
>                       secret:Optional[str]=None)

*Process webhook with verification, idempotency, and custom handler
execution*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database connection</td>
</tr>
<tr>
<td>webhook_id</td>
<td>str</td>
<td></td>
<td>Unique webhook ID</td>
</tr>
<tr>
<td>source</td>
<td>str</td>
<td></td>
<td>Source system</td>
</tr>
<tr>
<td>event_type</td>
<td>str</td>
<td></td>
<td>Event type</td>
</tr>
<tr>
<td>payload</td>
<td>Dict</td>
<td></td>
<td>Webhook payload</td>
</tr>
<tr>
<td>signature</td>
<td>str</td>
<td></td>
<td>Request signature</td>
</tr>
<tr>
<td>idempotency_key</td>
<td>str</td>
<td></td>
<td>Idempotency key</td>
</tr>
<tr>
<td>raw_body</td>
<td>str</td>
<td></td>
<td>Raw request body for signature verification</td>
</tr>
<tr>
<td>handler</td>
<td>Callable</td>
<td></td>
<td>App-specific webhook handler function</td>
</tr>
<tr>
<td>secret</td>
<td>Optional</td>
<td>None</td>
<td>Optional webhook secret</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_webhook_request

>  handle_webhook_request (request, db:fastsql.core.Database, source:str,
>                              handler:Callable,
>                              signature_header:str='X-Webhook-Signature',
>                              idempotency_header:str='X-Idempotency-Key',
>                              event_type_field:str='type',
>                              secret:Optional[str]=None)

*FastHTML route handler for webhook requests.*

Example: @app.post(â€˜/webhooks/stripeâ€™) async def
stripe_webhook(request): return await handle_webhook_request(
request=request, db=get_tenant_db(request), source=â€˜stripeâ€™,
handler=handle_stripe_event, signature_header=â€˜X-Stripe-Signatureâ€™,
run_in_background=True )

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>request</td>
<td></td>
<td></td>
<td>FastHTML request object</td>
</tr>
<tr>
<td>db</td>
<td>Database</td>
<td></td>
<td>Tenant database instance</td>
</tr>
<tr>
<td>source</td>
<td>str</td>
<td></td>
<td>Webhook source identifier</td>
</tr>
<tr>
<td>handler</td>
<td>Callable</td>
<td></td>
<td>App-specific handler function</td>
</tr>
<tr>
<td>signature_header</td>
<td>str</td>
<td>X-Webhook-Signature</td>
<td>Header containing signature</td>
</tr>
<tr>
<td>idempotency_header</td>
<td>str</td>
<td>X-Idempotency-Key</td>
<td>Header containing idempotency key</td>
</tr>
<tr>
<td>event_type_field</td>
<td>str</td>
<td>type</td>
<td>Field in payload containing event type</td>
</tr>
<tr>
<td>secret</td>
<td>Optional</td>
<td>None</td>
<td>Optional webhook secret</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>tuple</strong></td>
<td></td>
<td><strong>Returns (response_dict, status_code)</strong></td>
</tr>
</tbody>
</table>


========================================

FILE: _proc/02_utils_sql.html.md

# ğŸ—ƒï¸ SQL Helpers


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

This module provides a **batteries-included SQL toolkit** for building
database-heavy applications:

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ” Query Registry</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id"><code>run_id</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params"><code>validate_params</code></a></td>
<td>Execute queries by ID from centralized registries</td>
</tr>
<tr>
<td>â• Insert-Only</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only"><code>bulk_insert_only</code></a></td>
<td>Insert new records, skip conflicts</td>
</tr>
<tr>
<td>ğŸ”„ Upsert</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert"><code>bulk_upsert</code></a></td>
<td>Insert or update existing records</td>
</tr>
<tr>
<td>ğŸ“ CRUD</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id"><code>get_by_id</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record"><code>update_record</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record"><code>delete_record</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete"><code>bulk_delete</code></a></td>
<td>Standard database operations</td>
</tr>
<tr>
<td>ğŸ”§ Utilities</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql"><code>paginate_sql</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Transaction management &amp; helpers</td>
</tr>
<tr>
<td>ğŸ’° Money</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents"><code>to_cents</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents"><code>from_cents</code></a></td>
<td>Currency conversion for <code>int</code>-only storage</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     SQL Utilities Layer                         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ” Query Registry        â”‚  Execute queries by ID              â”‚
    â”‚  â• Insert Operations     â”‚  insert_only, bulk_insert_only      â”‚
    â”‚  ğŸ”„ Upsert Operations     â”‚  upsert, bulk_upsert                â”‚
    â”‚  ğŸ“ CRUD Operations       â”‚  get, update, delete (single/bulk)  â”‚
    â”‚  ğŸ”§ Utilities             â”‚  transactions, pagination, batching â”‚
    â”‚  ğŸ’° Money Helpers         â”‚  cents â†” dollars conversion         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  DB_TYPE Detection: PostgreSQL / SQLite (auto-switch syntax)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              fastsql Database Connection                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Conflict Handling

<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 38%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr>
<th>Operation</th>
<th>On Conflict</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a></td>
<td><strong>Skip</strong> (DO NOTHING)</td>
<td>Append-only logs, idempotent imports</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td><strong>Update</strong> existing</td>
<td>Sync external data, refresh caches</td>
</tr>
</tbody>
</table>

### Performance Tips

<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 46%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single record</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td>Simple, immediate</td>
</tr>
<tr>
<td>10+ records</td>
<td><code>bulk_*</code> variants</td>
<td>10-100x faster</td>
</tr>
<tr>
<td>100+ records</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Commits per batch, memory-safe</td>
</tr>
<tr>
<td>Multi-table changes</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a></td>
<td>All-or-nothing commits</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ” Database Type Detection

Automatically detects PostgreSQL vs SQLite from `DB_TYPE` environment
variable to generate appropriate SQL syntax.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L24"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_db_type

>  get_db_type ()

*Get database type from environment variable*

------------------------------------------------------------------------

## ğŸ¯ Query Registry

Execute queries by ID from a centralized registry with automatic
parameter validation.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id"><code>run_id</code></a></td>
<td>Execute a registered query by its ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params"><code>validate_params</code></a></td>
<td>Ensure all <code>:param</code> placeholders have values</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L42"
target="_blank" style="float:right; font-size:smaller">source</a>

### run_id

>  run_id (db:fastsql.core.Database, registry:Dict[str,str], query_id:str,
>              params:Optional[Dict[str,Any]]=None)

*Execute a query by ID from a query registry.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### validate_params

>  validate_params (sql:str, params:Dict[str,Any])

*Validate that all required parameters are provided*

------------------------------------------------------------------------

## â• Insert-Only

Insert new records **only if they donâ€™t exist** â€” conflicts are silently
skipped.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 26%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Records</th>
<th>SQL Generated</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a></td>
<td>Single</td>
<td><code>ON CONFLICT DO NOTHING</code> (PG) /
<code>INSERT OR IGNORE</code> (SQLite)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only"><code>bulk_insert_only</code></a></td>
<td>Multiple</td>
<td>Same, with batch execution</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Idempotent imports, append-only audit logs, webhook
> deduplication

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L95"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_insert_only

>  bulk_insert_only (db:fastsql.core.Database, table_name:str,
>                        records:List[Dict[str,Any]], conflict_cols:List[str],
>                        auto_commit:bool=True)

*Insert multiple records, skipping conflicts (optimized batch
operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L64"
target="_blank" style="float:right; font-size:smaller">source</a>

### insert_only

>  insert_only (db:fastsql.core.Database, table_name:str,
>                   record:Dict[str,Any], conflict_cols:List[str],
>                   auto_commit:bool=True)

*Insert a single record only if it doesnâ€™t exist (ignores conflicts).*

------------------------------------------------------------------------

## ğŸ”„ Upsert

Insert new records **or update existing ones** on conflict.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 26%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Records</th>
<th>SQL Generated</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td>Single</td>
<td><code>ON CONFLICT DO UPDATE</code> (PG) /
<code>INSERT OR REPLACE</code> (SQLite)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert"><code>bulk_upsert</code></a></td>
<td>Multiple</td>
<td>Same, with batch execution</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Syncing external API data, refreshing caches, user
> settings

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L166"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_upsert

>  bulk_upsert (db:fastsql.core.Database, table_name:str,
>                   records:List[Dict[str,Any]], conflict_cols:List[str],
>                   update_cols:Optional[List[str]]=None, auto_commit:bool=True)

*Insert or update multiple records (optimized batch operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L129"
target="_blank" style="float:right; font-size:smaller">source</a>

### upsert

>  upsert (db:fastsql.core.Database, table_name:str, record:Dict[str,Any],
>              conflict_cols:List[str], update_cols:Optional[List[str]]=None,
>              auto_commit:bool=True)

*Insert a record or update if it exists (upsert).*

------------------------------------------------------------------------

## ğŸ“ CRUD

Standard Create, Read, Update, Delete operations.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id"><code>get_by_id</code></a></td>
<td><strong>Read</strong></td>
<td>Fetch single record by primary key</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record"><code>update_record</code></a></td>
<td><strong>Update</strong></td>
<td>Modify record fields by ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record"><code>delete_record</code></a></td>
<td><strong>Delete</strong></td>
<td>Remove single record by ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete"><code>bulk_delete</code></a></td>
<td><strong>Delete</strong></td>
<td>Remove multiple records by ID list</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L251"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_delete

>  bulk_delete (db:fastsql.core.Database, table_name:str, id_list:List[Any],
>                   id_col:str='id', auto_commit:bool=True)

*Delete multiple records by ID list.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L237"
target="_blank" style="float:right; font-size:smaller">source</a>

### delete_record

>  delete_record (db:fastsql.core.Database, table_name:str, id_value:Any,
>                     id_col:str='id', auto_commit:bool=True)

*Delete a single record by ID.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L216"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_record

>  update_record (db:fastsql.core.Database, table_name:str, id_value:Any,
>                     id_col:str='id', auto_commit:bool=True, **updates)

*Update a single record by ID.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L206"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_by_id

>  get_by_id (db:fastsql.core.Database, table_name:str, id_value:Any,
>                 id_col:str='id')

*Get a single record by ID.*

------------------------------------------------------------------------

## ğŸ”§ Utilities

Transaction management, pagination, and batch processing.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a></td>
<td>Context manager for atomic operations</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql"><code>paginate_sql</code></a></td>
<td>Add LIMIT/OFFSET to queries</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Process large lists in memory-safe chunks</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L289"
target="_blank" style="float:right; font-size:smaller">source</a>

### batch_execute

>  batch_execute (db:fastsql.core.Database, operation_func, items:List[Any],
>                     batch_size:int=100)

*Execute an operation on items in batches with commits after each
batch.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L284"
target="_blank" style="float:right; font-size:smaller">source</a>

### paginate_sql

>  paginate_sql (sql:str, page:int, page_size:int)

*Add LIMIT/OFFSET pagination to a SQL query.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L275"
target="_blank" style="float:right; font-size:smaller">source</a>

### with_transaction

>  with_transaction (db:fastsql.core.Database)

*Context manager for safe transaction handling with auto-rollback on
error.*

------------------------------------------------------------------------

## ğŸ’° Money Helpers

Convert between dollar amounts and integer cents for database storage.

> âš ï¸ **Why cents?** fastsql only supports `int` and `str` types â€”
> storing money as cents avoids floating-point precision issues.

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Direction</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents"><code>to_cents</code></a></td>
<td><code>"$150.00"</code> â†’ <code>15000</code></td>
<td>Store in DB</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents"><code>from_cents</code></a></td>
<td><code>15000</code> â†’ <code>"$150.00"</code></td>
<td>Display to user</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L303"
target="_blank" style="float:right; font-size:smaller">source</a>

### to_cents

>  to_cents (dollars:str|float|None)

*Convert dollar amount to integer cents for database storage.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L313"
target="_blank" style="float:right; font-size:smaller">source</a>

### from_cents

>  from_cents (cents:int|None)

*Convert integer cents to formatted dollar string for display.*


========================================

FILE: _proc/03_utils_bgtsk.html.md

# âš¡ Background Tasks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 40%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Components</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ“¦ Model</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#tenantjob"><code>TenantJob</code></a></td>
<td>Tenant-level job record with retry support</td>
</tr>
<tr>
<td>âš¡ Manager</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#backgroundtaskmanager"><code>BackgroundTaskManager</code></a></td>
<td>Submit, execute, and track background tasks</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    FastHTML Route                               â”‚
    â”‚  return response, bg_task  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                    â”‚
                                  â–¼                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 BackgroundTaskManager                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  submit()           â†’ Create job + return BackgroundTask        â”‚
    â”‚  _execute_with_retry() â†’ Run with auto-retry on failure         â”‚
    â”‚  get_job()          â†’ Check job status                          â”‚
    â”‚  list_jobs()        â†’ Query jobs by type/status                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Retry Logic: 2^n seconds backoff (2s, 4s, 8s)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Tenant Database                              â”‚
    â”‚                    â””â”€â”€ tenant_jobs table                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Job Status Flow

    pending â†’ running â†’ completed
        â†‘        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ failed (after max retries)

### Usage Pattern

``` python
# In your FastHTML route
manager = BackgroundTaskManager(tenant_db)
job_id, bg_task = manager.submit("sync_data", my_sync_func, user_id="123")
return response, bg_task  # Starlette runs bg_task after response
```

------------------------------------------------------------------------

## ğŸ“¦ TenantJob Model

Tracks background jobs at the tenant level with retry support.

<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>str</td>
<td>Unique job identifier</td>
</tr>
<tr>
<td><code>job_type</code></td>
<td>str</td>
<td>Job category (e.g., â€œsyncâ€, â€œemailâ€)</td>
</tr>
<tr>
<td><code>status</code></td>
<td>str</td>
<td><code>pending</code> / <code>running</code> / <code>completed</code>
/ <code>failed</code></td>
</tr>
<tr>
<td><code>payload</code></td>
<td>str</td>
<td>JSON kwargs passed to task function</td>
</tr>
<tr>
<td><code>result</code></td>
<td>str</td>
<td>JSON result on completion</td>
</tr>
<tr>
<td><code>error_log</code></td>
<td>str</td>
<td>Stack trace on failure</td>
</tr>
<tr>
<td><code>retry_count</code></td>
<td>int</td>
<td>Current retry attempt</td>
</tr>
<tr>
<td><code>max_retries</code></td>
<td>int</td>
<td>Max attempts before marking failed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L26"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantJob

>  TenantJob ()

*Tenant-level background job with retry support.*

------------------------------------------------------------------------

## âš¡ BackgroundTaskManager

Submit and track background tasks with automatic retry logic.

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>submit</code></td>
<td>Create job and return BackgroundTask for Starlette</td>
</tr>
<tr>
<td><code>get_job</code></td>
<td>Get job status and details by ID</td>
</tr>
<tr>
<td><code>list_jobs</code></td>
<td>Query jobs with optional type/status filters</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Long-running operations like syncing data, sending
> emails, or processing uploads

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L41"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager

>  BackgroundTaskManager (db:fastsql.core.Database)

*Lightweight background task manager for tenant-level operations.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L103"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.list_jobs

>  BackgroundTaskManager.list_jobs (job_type:Optional[str]=None,
>                                       status:Optional[str]=None,
>                                       limit:int=100)

*List jobs with optional filtering.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L99"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.get_job

>  BackgroundTaskManager.get_job (job_id:str)

*Get job status and details.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.submit

>  BackgroundTaskManager.submit (job_type:str, task_func:Callable,
>                                    max_retries:int=3, **task_kwargs)

*Submit a new background task for execution.*


========================================

FILE: _proc/09_utils_polars_mapper.html.md

# ğŸ»â€â„ï¸ Data Transforms


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert"><code>map_and_upsert</code></a></td>
<td>Bulk JSONâ†’DB upsert via staging table</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#apply_schema"><code>apply_schema</code></a></td>
<td>Type conversions (dates, booleans, numbers)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Staging Table Pattern                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. df.write_database(staging_table) â†’ fast bulk INSERT        â”‚
    â”‚  2. INSERT ... ON CONFLICT SELECT FROM staging â†’ vectorized    â”‚
    â”‚  3. DROP TABLE staging â†’ cleanup                                â”‚
    â”‚                                                                 â”‚
    â”‚  âš¡ 10-100x faster than row-by-row upserts                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ“¥ Map & Upsert

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame from JSON</td>
</tr>
<tr>
<td><code>table_name</code></td>
<td>Target database table (must exist)</td>
</tr>
<tr>
<td><code>key_col</code></td>
<td>Primary key for ON CONFLICT resolution</td>
</tr>
<tr>
<td><code>db_uri</code></td>
<td>Database connection string</td>
</tr>
<tr>
<td><code>column_map</code></td>
<td>Optional rename map <code>{json_col: db_col}</code></td>
</tr>
<tr>
<td><code>unnest_cols</code></td>
<td>Optional list of nested columns to flatten</td>
</tr>
</tbody>
</table>

**Staging Table Pattern (10-100x faster than row-by-row):** 1. Write to
temporary staging table (fast bulk insert) 2. Execute
`INSERT ... ON CONFLICT` (database-native, vectorized) 3. Drop staging
table (cleanup)

**Example:**

``` python
import polars as pl

# JSON from API
json_data = [
    {'user_id_val': 1, 'ABC_1': 'Alice', 'extra': 'ignore'},
    {'user_id_val': 2, 'ABC_1': 'Bob', 'extra': 'ignore'}
]

df = pl.DataFrame(json_data)

map_and_upsert(
    df=df,
    table_name='users',
    key_col='user_id',
    db_uri='sqlite:///app.db',
    column_map={'user_id_val': 'user_id', 'ABC_1': 'name'}
)
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### map_and_upsert

>  map_and_upsert (df:polars.dataframe.frame.DataFrame, table_name:str,
>                      key_col:str, db_uri:str, column_map:dict=None,
>                      unnest_cols:list[str]=None)

*Map JSON data to database columns and upsert using staging table
pattern.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>df</td>
<td>DataFrame</td>
<td></td>
<td>The raw Polars DataFrame from JSON</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td></td>
<td>Target database table name</td>
</tr>
<tr>
<td>key_col</td>
<td>str</td>
<td></td>
<td>Primary key column for conflict resolution</td>
</tr>
<tr>
<td>db_uri</td>
<td>str</td>
<td></td>
<td>SQLAlchemy connection string (e.g., â€˜sqlite:///db.dbâ€™ or
â€˜postgresql://â€¦â€™)</td>
</tr>
<tr>
<td>column_map</td>
<td>dict</td>
<td>None</td>
<td>Optional rename map {json_key: db_col}</td>
</tr>
<tr>
<td>unnest_cols</td>
<td>list</td>
<td>None</td>
<td>List of Struct columns to flatten</td>
</tr>
</tbody>
</table>

## ğŸ”§ Schema Transformations

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Dict mapping column names to Polars dtypes</td>
</tr>
</tbody>
</table>

**Supported conversions:**

<table>
<thead>
<tr>
<th>Type</th>
<th>Handling</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pl.Date</code></td>
<td>Parses <code>YYYY-MM-DD</code> strings</td>
</tr>
<tr>
<td><code>pl.Datetime</code></td>
<td>Parses datetime strings</td>
</tr>
<tr>
<td><code>pl.Boolean</code></td>
<td>Converts <code>"true"</code>/<code>"false"</code> strings</td>
</tr>
<tr>
<td>Other</td>
<td>Uses <code>cast()</code> (works for numeric types)</td>
</tr>
</tbody>
</table>

**Example:**

``` python
df = pl.DataFrame({
    'created_at': ['2024-01-15', '2024-01-16'],
    'is_active': ['true', 'false'],
    'amount': ['123.45', '678.90']
})

df = apply_schema(df, {
    'created_at': pl.Date,
    'is_active': pl.Boolean,
    'amount': pl.Float64
})
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L104"
target="_blank" style="float:right; font-size:smaller">source</a>

### apply_schema

>  apply_schema (df:polars.dataframe.frame.DataFrame, type_map:dict)

*Apply explicit type conversions to DataFrame columns.*

<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 38%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>df</td>
<td>DataFrame</td>
<td>Input DataFrame</td>
</tr>
<tr>
<td>type_map</td>
<td>dict</td>
<td>Column name -&gt; Polars dtype (e.g., {â€˜created_atâ€™: pl.Date,
â€˜is_activeâ€™: pl.Boolean})</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>DataFrame</strong></td>
<td></td>
</tr>
</tbody>
</table>


========================================

FILE: _proc/10_utils_sync.html.md

# ğŸ”„ API â†’ DB Sync


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_external_data"><code>sync_external_data</code></a></td>
<td>Full sync: API â†’ Transform â†’ DB</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_incremental"><code>sync_incremental</code></a></td>
<td>Incremental sync since timestamp</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    End-to-End Sync Pipeline                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  GraphQL API â”€â”€â–¶ Streaming Pages â”€â”€â–¶ Polars Transform â”€â”€â–¶ DB  â”‚
    â”‚       â”‚                â”‚                    â”‚                   â”‚
    â”‚  fetch_pages      yield batch         map_and_upsert           â”‚
    â”‚  generator        (memory safe)        (staging pattern)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ”„ Full Sync

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>client</code></td>
<td>GraphQL client instance</td>
</tr>
<tr>
<td><code>query_template</code></td>
<td>GraphQL query with pagination</td>
</tr>
<tr>
<td><code>variables</code></td>
<td>Query variables</td>
</tr>
<tr>
<td><code>items_path</code></td>
<td>JSONPath to data items</td>
</tr>
<tr>
<td><code>cursor_path</code></td>
<td>JSONPath to cursor</td>
</tr>
<tr>
<td><code>table_name</code></td>
<td>Target table name</td>
</tr>
<tr>
<td><code>key_col</code></td>
<td>Primary key column</td>
</tr>
<tr>
<td><code>db_uri</code></td>
<td>Database connection string</td>
</tr>
<tr>
<td><code>column_map</code></td>
<td>Optional column renaming</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Optional type conversions</td>
</tr>
<tr>
<td><code>has_next_path</code></td>
<td>Optional hasNextPage path</td>
</tr>
</tbody>
</table>

**Returns:** `{'total_records': 10000, 'batches': 10}`

**Example:**

``` python
from fh_saas.utils_api import AsyncAPIClient, bearer_token_auth
from fh_saas.utils_graphql import GraphQLClient
import polars as pl

async with AsyncAPIClient(
    'https://api.example.com/graphql',
    auth_headers=bearer_token_auth('TOKEN')
) as api_client:
    
    client = GraphQLClient(api_client)
    
    stats = await sync_external_data(
        client=client,
        query_template='''
            query($cursor: String) {
                users(after: $cursor, first: 1000) {
                    nodes { user_id_val name_str email_addr }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        variables={'cursor': None},
        items_path=['data', 'users', 'nodes'],
        cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
        has_next_path=['data', 'users', 'pageInfo', 'hasNextPage'],
        table_name='users',
        key_col='user_id',
        db_uri='sqlite:///app.db',
        column_map={
            'user_id_val': 'user_id',
            'name_str': 'name',
            'email_addr': 'email'
        },
        type_map={'user_id': pl.Int64}
    )
    
    print(f"Synced {stats['total_records']} records")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sync.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### sync_external_data

>  sync_external_data (client:fh_saas.utils_graphql.GraphQLClient,
>                          query_template:str, variables:dict,
>                          items_path:list[str], cursor_path:list[str],
>                          table_name:str, key_col:str, db_uri:str,
>                          column_map:dict=None, type_map:dict=None,
>                          has_next_path:list[str]=None, batch_size:int=5000)

*Sync external data from GraphQL API to database (streaming,
memory-efficient).*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>client</td>
<td>GraphQLClient</td>
<td></td>
<td>Initialized GraphQL client</td>
</tr>
<tr>
<td>query_template</td>
<td>str</td>
<td></td>
<td>GraphQL query with $cursor variable</td>
</tr>
<tr>
<td>variables</td>
<td>dict</td>
<td></td>
<td>Initial variables (e.g., {â€˜cursorâ€™: None})</td>
</tr>
<tr>
<td>items_path</td>
<td>list</td>
<td></td>
<td>Path to data list in response</td>
</tr>
<tr>
<td>cursor_path</td>
<td>list</td>
<td></td>
<td>Path to next cursor</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td></td>
<td>Target database table</td>
</tr>
<tr>
<td>key_col</td>
<td>str</td>
<td></td>
<td>Primary key for upsert</td>
</tr>
<tr>
<td>db_uri</td>
<td>str</td>
<td></td>
<td>Database connection string</td>
</tr>
<tr>
<td>column_map</td>
<td>dict</td>
<td>None</td>
<td>Optional column renaming</td>
</tr>
<tr>
<td>type_map</td>
<td>dict</td>
<td>None</td>
<td>Optional type conversions</td>
</tr>
<tr>
<td>has_next_path</td>
<td>list</td>
<td>None</td>
<td>Optional hasNextPage path</td>
</tr>
<tr>
<td>batch_size</td>
<td>int</td>
<td>5000</td>
<td>Max rows per batch (pagination page size)</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## â±ï¸ Incremental Sync

Syncs only records updated after `last_sync_time`.

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>last_sync_time</code></td>
<td>ISO timestamp (e.g., <code>'2024-01-15T10:00:00Z'</code>)</td>
</tr>
<tr>
<td><em>(others)</em></td>
<td>Same as <a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_external_data"><code>sync_external_data</code></a></td>
</tr>
</tbody>
</table>

**Returns:**
`{'total_records': 100, 'batches': 2, 'last_sync_time': '2024-01-16T10:00:00Z'}`

**Example:**

``` python
# Query with $last_sync filter
query = '''
    query($cursor: String, $last_sync: DateTime!) {
        users(after: $cursor, where: {updated_at: {_gt: $last_sync}}) {
            nodes { id name updated_at }
            pageInfo { hasNextPage endCursor }
        }
    }
'''

stats = await sync_incremental(
    client=client,
    query_template=query,
    last_sync_time='2024-01-15T10:00:00Z',
    items_path=['data', 'users', 'nodes'],
    cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
    table_name='users',
    key_col='id',
    db_uri='sqlite:///app.db'
)
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sync.py#L75"
target="_blank" style="float:right; font-size:smaller">source</a>

### sync_incremental

>  sync_incremental (client:fh_saas.utils_graphql.GraphQLClient,
>                        query_template:str, last_sync_time:str,
>                        items_path:list[str], cursor_path:list[str],
>                        table_name:str, key_col:str, db_uri:str,
>                        column_map:dict=None, type_map:dict=None,
>                        has_next_path:list[str]=None)

*Incremental sync: fetch only records updated after last sync
timestamp.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>client</td>
<td>GraphQLClient</td>
<td></td>
<td>Initialized GraphQL client</td>
</tr>
<tr>
<td>query_template</td>
<td>str</td>
<td></td>
<td>GraphQL query with $cursor and $last_sync variables</td>
</tr>
<tr>
<td>last_sync_time</td>
<td>str</td>
<td></td>
<td>ISO timestamp (e.g., â€˜2024-01-15T10:00:00Zâ€™)</td>
</tr>
<tr>
<td>items_path</td>
<td>list</td>
<td></td>
<td>Path to data list</td>
</tr>
<tr>
<td>cursor_path</td>
<td>list</td>
<td></td>
<td>Path to cursor</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td></td>
<td>Target table</td>
</tr>
<tr>
<td>key_col</td>
<td>str</td>
<td></td>
<td>Primary key</td>
</tr>
<tr>
<td>db_uri</td>
<td>str</td>
<td></td>
<td>Database connection</td>
</tr>
<tr>
<td>column_map</td>
<td>dict</td>
<td>None</td>
<td>Optional column map</td>
</tr>
<tr>
<td>type_map</td>
<td>dict</td>
<td>None</td>
<td>Optional type map</td>
</tr>
<tr>
<td>has_next_path</td>
<td>list</td>
<td>None</td>
<td>Optional hasNextPage path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>


========================================

FILE: _proc/05_utils_email.html.md

# ğŸ“§ Email Sending


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 36%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>âš™ï¸ Config</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config"><code>get_smtp_config</code></a></td>
<td>Load SMTP settings from env</td>
</tr>
<tr>
<td>ğŸ“ Templates</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path"><code>get_template_path</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template"><code>load_template</code></a></td>
<td>Manage markdown templates</td>
</tr>
<tr>
<td>âœ‰ï¸ Sending</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email"><code>send_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Core send functions</td>
</tr>
<tr>
<td>ğŸ Convenience</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email"><code>send_welcome_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email"><code>send_invitation_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email"><code>send_password_reset_email</code></a></td>
<td>Pre-built templates</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Email Sending Flow                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. Load SMTP config from environment variables                 â”‚
    â”‚  2. Load markdown template from templates/ directory            â”‚
    â”‚  3. Substitute template variables (user_name, etc.)             â”‚
    â”‚  4. Convert markdown to HTML via markdown_merge                 â”‚
    â”‚  5. Send via SMTP (Azure, SendGrid, AWS SES, etc.)             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“‹ Environment Variables

<table>
<thead>
<tr>
<th>Variable</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SMTP_HOST</code></td>
<td>âœ…</td>
<td>-</td>
<td>SMTP server hostname</td>
</tr>
<tr>
<td><code>SMTP_PORT</code></td>
<td>âŒ</td>
<td>587</td>
<td>SMTP server port</td>
</tr>
<tr>
<td><code>SMTP_USER</code></td>
<td>âœ…</td>
<td>-</td>
<td>Auth username</td>
</tr>
<tr>
<td><code>SMTP_PASSWORD</code></td>
<td>âœ…</td>
<td>-</td>
<td>Auth password</td>
</tr>
<tr>
<td><code>SMTP_MAIL_FROM</code></td>
<td>âœ…</td>
<td>-</td>
<td>Sender email</td>
</tr>
<tr>
<td><code>SMTP_STARTTLS</code></td>
<td>âŒ</td>
<td>True</td>
<td>Use STARTTLS</td>
</tr>
<tr>
<td><code>SMTP_SSL</code></td>
<td>âŒ</td>
<td>False</td>
<td>Use SSL (disables TLS)</td>
</tr>
</tbody>
</table>

## âš™ï¸ SMTP Configuration

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config"><code>get_smtp_config</code></a></td>
<td>Load SMTP config from environment vars</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_smtp_config

>  get_smtp_config ()

*Load SMTP configuration from environment variables.*

## ğŸ“ Template Management

**Built-in Templates:**  
We ship 3 production-ready markdown templates: - `welcome.md` - New user
onboarding - `invitation.md` - Invite users to tenant  
- `password_reset.md` - Password recovery

**Custom Templates:**  
You can provide your own templates by passing `custom_template_path` to
any email function.

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path"><code>get_template_path</code></a></td>
<td>Resolve path to template file (built-in or custom)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template"><code>load_template</code></a></td>
<td>Read template content as string</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L82"
target="_blank" style="float:right; font-size:smaller">source</a>

### load_template

>  load_template (template_name:str,
>                     custom_template_path:Union[str,pathlib._local.Path,NoneTyp
>                     e]=None)

*Load markdown email template as string.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>template_name</td>
<td>str</td>
<td></td>
<td>Template basename (e.g., â€˜welcomeâ€™)</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom path overrides package templates</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L58"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_template_path

>  get_template_path (template_name:str,
>                         custom_template_path:Union[str,pathlib._local.Path,Non
>                         eType]=None)

*Get absolute path to email template file.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>template_name</td>
<td>str</td>
<td></td>
<td>Template basename (e.g., â€˜welcomeâ€™, â€˜invitationâ€™)</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom path overrides package templates</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Path</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## âœ‰ï¸ Email Sending

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email"><code>send_email</code></a></td>
<td>Send single email with template</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Send to multiple recipients</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L91"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_email

>  send_email (to_email:str, to_name:str, subject:str, template_name:str,
>                  template_vars:Dict[str,str], test:bool=False,
>                  smtp_config:Optional[Dict[str,Any]]=None, custom_template_pat
>                  h:Union[str,pathlib._local.Path,NoneType]=None)

*Send single email using markdown template with variable substitution.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>to_email</td>
<td>str</td>
<td></td>
<td>Recipient email address</td>
</tr>
<tr>
<td>to_name</td>
<td>str</td>
<td></td>
<td>Recipient display name</td>
</tr>
<tr>
<td>subject</td>
<td>str</td>
<td></td>
<td>Email subject line</td>
</tr>
<tr>
<td>template_name</td>
<td>str</td>
<td></td>
<td>Template name: â€˜welcomeâ€™, â€˜invitationâ€™, â€˜password_resetâ€™</td>
</tr>
<tr>
<td>template_vars</td>
<td>Dict</td>
<td></td>
<td>Variables to substitute in template</td>
</tr>
<tr>
<td>test</td>
<td>bool</td>
<td>False</td>
<td>If True, prints email instead of sending</td>
</tr>
<tr>
<td>smtp_config</td>
<td>Optional</td>
<td>None</td>
<td>Custom SMTP config (defaults to env vars)</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom template path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ“¦ Batch Sending

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Send personalized emails to multiple recipients</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L170"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_batch_emails

>  send_batch_emails (recipients:List[Dict[str,str]], subject:str,
>                         template_name:str,
>                         template_vars_list:List[Dict[str,str]],
>                         test:bool=False, pause:float=0.2,
>                         smtp_config:Optional[Dict[str,Any]]=None, custom_templ
>                         ate_path:Union[str,pathlib._local.Path,NoneType]=None)

*Send personalized emails to multiple recipients.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>recipients</td>
<td>List</td>
<td></td>
<td>List of dicts with â€˜emailâ€™ and â€˜nameâ€™ keys</td>
</tr>
<tr>
<td>subject</td>
<td>str</td>
<td></td>
<td>Email subject line</td>
</tr>
<tr>
<td>template_name</td>
<td>str</td>
<td></td>
<td>Template name: â€˜welcomeâ€™, â€˜invitationâ€™, â€˜password_resetâ€™</td>
</tr>
<tr>
<td>template_vars_list</td>
<td>List</td>
<td></td>
<td>List of variable dicts, one per recipient</td>
</tr>
<tr>
<td>test</td>
<td>bool</td>
<td>False</td>
<td>If True, prints emails instead of sending</td>
</tr>
<tr>
<td>pause</td>
<td>float</td>
<td>0.2</td>
<td>Seconds between emails (rate limiting)</td>
</tr>
<tr>
<td>smtp_config</td>
<td>Optional</td>
<td>None</td>
<td>Custom SMTP config</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom template path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>List</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ Convenience Functions

Pre-built functions for common email types. All support
`custom_template_path` for using your own templates.

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 34%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Template</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email"><code>send_welcome_email</code></a></td>
<td><code>welcome.md</code></td>
<td>New user onboarding</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email"><code>send_invitation_email</code></a></td>
<td><code>invitation.md</code></td>
<td>Invite to tenant</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email"><code>send_password_reset_email</code></a></td>
<td><code>password_reset.md</code></td>
<td>Password recovery</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L254"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_welcome_email

>  send_welcome_email (to_email:str, to_name:str, user_name:str,
>                          tenant_name:str, dashboard_url:str, test:bool=False, 
>                          custom_template_path:Union[str,pathlib._local.Path,No
>                          neType]=None)

*Send welcome email to new user. Template vars: {user_name},
{tenant_name}, {dashboard_url}, {to_email}*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>to_email</td>
<td>str</td>
<td></td>
<td>Recipient email address</td>
</tr>
<tr>
<td>to_name</td>
<td>str</td>
<td></td>
<td>Recipient display name</td>
</tr>
<tr>
<td>user_name</td>
<td>str</td>
<td></td>
<td>Userâ€™s name for personalization</td>
</tr>
<tr>
<td>tenant_name</td>
<td>str</td>
<td></td>
<td>Tenant/organization name</td>
</tr>
<tr>
<td>dashboard_url</td>
<td>str</td>
<td></td>
<td>URL to userâ€™s dashboard</td>
</tr>
<tr>
<td>test</td>
<td>bool</td>
<td>False</td>
<td>If True, prints email instead of sending</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom welcome.md template path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L280"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_invitation_email

>  send_invitation_email (to_email:str, to_name:str, inviter_name:str,
>                             tenant_name:str, invitation_url:str,
>                             test:bool=False, custom_template_path:Union[str,pa
>                             thlib._local.Path,NoneType]=None)

*Send invitation email. Template vars: {inviter_name}, {tenant_name},
{invitation_url}, {to_email}*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>to_email</td>
<td>str</td>
<td></td>
<td>Recipient email address</td>
</tr>
<tr>
<td>to_name</td>
<td>str</td>
<td></td>
<td>Recipient display name</td>
</tr>
<tr>
<td>inviter_name</td>
<td>str</td>
<td></td>
<td>Name of person sending invitation</td>
</tr>
<tr>
<td>tenant_name</td>
<td>str</td>
<td></td>
<td>Tenant/organization name</td>
</tr>
<tr>
<td>invitation_url</td>
<td>str</td>
<td></td>
<td>URL to accept invitation</td>
</tr>
<tr>
<td>test</td>
<td>bool</td>
<td>False</td>
<td>If True, prints email instead of sending</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom invitation.md template path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L306"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_password_reset_email

>  send_password_reset_email (to_email:str, to_name:str, user_name:str,
>                                 reset_url:str, test:bool=False, custom_templat
>                                 e_path:Union[str,pathlib._local.Path,NoneType]
>                                 =None)

*Send password reset email. Template vars: {user_name}, {reset_url},
{to_email}*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>to_email</td>
<td>str</td>
<td></td>
<td>Recipient email address</td>
</tr>
<tr>
<td>to_name</td>
<td>str</td>
<td></td>
<td>Recipient display name</td>
</tr>
<tr>
<td>user_name</td>
<td>str</td>
<td></td>
<td>Userâ€™s name for personalization</td>
</tr>
<tr>
<td>reset_url</td>
<td>str</td>
<td></td>
<td>Secure password reset URL</td>
</tr>
<tr>
<td>test</td>
<td>bool</td>
<td>False</td>
<td>If True, prints email instead of sending</td>
</tr>
<tr>
<td>custom_template_path</td>
<td>Union</td>
<td>None</td>
<td>Custom password_reset.md template path</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ“ Template Customization

### Built-in Templates

The package ships with 3 production-ready templates in
`fh_saas/templates/`:

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Template</th>
<th>Variables</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>welcome.md</code></td>
<td><code>{user_name}</code>, <code>{tenant_name}</code>,
<code>{dashboard_url}</code>, <code>{to_email}</code></td>
</tr>
<tr>
<td><code>invitation.md</code></td>
<td><code>{inviter_name}</code>, <code>{tenant_name}</code>,
<code>{invitation_url}</code>, <code>{to_email}</code></td>
</tr>
<tr>
<td><code>password_reset.md</code></td>
<td><code>{user_name}</code>, <code>{reset_url}</code>,
<code>{to_email}</code></td>
</tr>
</tbody>
</table>

### Creating Custom Templates

1.  Copy a built-in template as a starting point
2.  Modify the markdown and keep variable names in `{brackets}`
3.  Pass `custom_template_path='/path/to/template.md'` to any function

Templates use **markdown_merge** format - standard markdown with
`{variable}` placeholders.


========================================

FILE: _proc/11_utils_blog.html.md

# ğŸ“ Blog Publishing


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Class</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#postloader"><code>PostLoader</code></a></td>
<td>Load markdown posts from filesystem</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#markdownengine"><code>MarkdownEngine</code></a></td>
<td>Render markdown to SEO-friendly HTML</td>
</tr>
</tbody>
</table>

## ğŸ“‚ PostLoader

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.load_posts()</code></td>
<td>Load all posts sorted by date</td>
</tr>
<tr>
<td><code>.get_post()</code></td>
<td>Get single post by slug</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L34"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader

>  PostLoader (posts_dir:str)

*Load and parse markdown blog posts from filesystem*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>posts_dir</td>
<td>str</td>
<td>Directory containing .md files</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L41"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader.load_posts

>  PostLoader.load_posts ()

*Load all markdown posts from directory.*

Returns list of post dicts sorted by date (newest first). Each post
contains: title, date, slug, body, categories, author, series.

Example: \`\`\`python loader = PostLoader(â€˜blog/postsâ€™) posts =
loader.load_posts()

    for post in posts:
        print(f"{post['title']} - {post['slug']}")
    ```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader.get_post

>  PostLoader.get_post (slug:str)

*Get single post by slug.*

Example:
`python     post = loader.get_post('bg0010')     if post:         print(post['title'])`

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>slug</td>
<td>str</td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Optional</strong></td>
<td><strong>URL slug (e.g., â€˜my-postâ€™)</strong></td>
</tr>
</tbody>
</table>

## ğŸ¨ MarkdownEngine

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.render()</code></td>
<td>Convert markdown to HTML</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L96"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine

>  MarkdownEngine ()

*Render markdown to HTML with SEO extensions*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L117"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine.render

>  MarkdownEngine.render (content:str)

*Convert markdown to HTML.*

        Returns HTML string with proper semantic tags for SEO.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Hello

This is **bold**.â€™) print(html) \#
<h1>

Hello
</h1>

<p>

This is <strong>bold</strong>.
</p>

            ```

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>content</td>
<td>str</td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td><strong>Markdown content</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L133"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine.get_toc

>  MarkdownEngine.get_toc ()

*Get table of contents HTML from last render.*

        Must call render() first. Returns empty string if no headings.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Title

## Section 1

## Section 2â€™)

            toc = engine.get_toc()
            print(toc)  # <ul><li><a href="#section-1">Section 1</a>...</li></ul>
            ```

## FastHTML Integration Example

Basic pattern for server-side rendering with FastHTML:

``` python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog')
def blog_index():
    posts = loader.load_posts()
    return Titled('Blog',
        *[Article(
            H2(A(p['title'], href=f"/blog/{p['slug']}")),
            P(p['description']),
            Small(p['date'].strftime('%Y-%m-%d') if p['date'] else '')
        ) for p in posts]
    )

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    html_content = engine.render(post['body'])
    toc = engine.get_toc()
    
    return Titled(post['title'],
        Article(
            NotStr(toc),  # Table of contents
            NotStr(html_content)  # Rendered markdown
        )
    )
```


========================================

FILE: _proc/12_utils_seo.html.md

# ğŸ” SEO & Sitemaps


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags"><code>generate_head_tags</code></a></td>
<td>Meta tags for social sharing</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml"><code>generate_sitemap_xml</code></a></td>
<td>XML sitemap for crawlers</td>
</tr>
<tr>
<td><code>generate_json_ld</code></td>
<td>Structured data (Article schema)</td>
</tr>
</tbody>
</table>

## ğŸ·ï¸ Meta Tags

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags"><code>generate_head_tags</code></a></td>
<td>OpenGraph, Twitter Card, canonical</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L16"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_head_tags

>  generate_head_tags (title:str, description:str, url:str,
>                          image_url:Optional[str]=None,
>                          article_published:Optional[datetime.datetime]=None,
>                          article_modified:Optional[datetime.datetime]=None,
>                          author:Optional[str]=None)

*Generate meta tags for SEO.*

Returns list of (tag_name, attributes_dict) tuples for FastHTML
components. Includes standard, OpenGraph, and Twitter Card tags.

Example: \`\`\`python from fasthtml.common import \*

    tags = generate_head_tags(
        title='My Blog Post',
        description='Learn about Python',
        url='https://example.com/blog/my-post',
        image_url='https://example.com/image.jpg'
    )

    # Use in FastHTML app
    @app.get('/blog/my-post')
    def post():
        return Html(
            Head(
                *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
                  for tag, attrs in tags]
            ),
            Body('...')
        )
    ```

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td>str</td>
<td></td>
<td>Page title</td>
</tr>
<tr>
<td>description</td>
<td>str</td>
<td></td>
<td>Page description (150-160 chars optimal)</td>
</tr>
<tr>
<td>url</td>
<td>str</td>
<td></td>
<td>Canonical URL</td>
</tr>
<tr>
<td>image_url</td>
<td>Optional</td>
<td>None</td>
<td>OpenGraph image URL</td>
</tr>
<tr>
<td>article_published</td>
<td>Optional</td>
<td>None</td>
<td>Publication date</td>
</tr>
<tr>
<td>article_modified</td>
<td>Optional</td>
<td>None</td>
<td>Last modified date</td>
</tr>
<tr>
<td>author</td>
<td>Optional</td>
<td>None</td>
<td>Author name</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>List</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## ğŸ—ºï¸ Sitemap

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml"><code>generate_sitemap_xml</code></a></td>
<td>XML sitemap for search crawlers</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L103"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_sitemap_xml

>  generate_sitemap_xml (posts:List[Dict], base_url:str,
>                            blog_path:str='/blog')

*Generate XML sitemap for blog posts.*

Returns sitemap XML string with proper structure and lastmod dates.

Example: \`\`\`python from fasthtml.common import \* from
fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/sitemap.xml')
    def sitemap():
        posts = loader.load_posts()
        xml = generate_sitemap_xml(
            posts=posts,
            base_url='https://example.com',
            blog_path='/blog'
        )
        return Response(xml, media_type='application/xml')
    ```

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>posts</td>
<td>List</td>
<td></td>
<td>List of posts from PostLoader</td>
</tr>
<tr>
<td>base_url</td>
<td>str</td>
<td></td>
<td>Base URL (e.g., â€˜https://example.comâ€™)</td>
</tr>
<tr>
<td>blog_path</td>
<td>str</td>
<td>/blog</td>
<td>Blog path prefix</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## rss feed generator

Generate RSS 2.0 feed for blog subscribers.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L162"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_rss_xml

>  generate_rss_xml (posts:List[Dict], blog_title:str, blog_description:str,
>                        base_url:str, blog_path:str='/blog')

*Generate RSS 2.0 feed for blog posts.*

Returns RSS XML string for feed readers (Feedly, etc.).

Example: \`\`\`python from fasthtml.common import \* from
fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/rss.xml')
    def rss():
        posts = loader.load_posts()[:20]  # Latest 20 posts
        xml = generate_rss_xml(
            posts=posts,
            blog_title='My Blog',
            blog_description='Tech tutorials and insights',
            base_url='https://example.com'
        )
        return Response(xml, media_type='application/xml')
    ```

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>posts</td>
<td>List</td>
<td></td>
<td>List of posts from PostLoader</td>
</tr>
<tr>
<td>blog_title</td>
<td>str</td>
<td></td>
<td>Blog title</td>
</tr>
<tr>
<td>blog_description</td>
<td>str</td>
<td></td>
<td>Blog description</td>
</tr>
<tr>
<td>base_url</td>
<td>str</td>
<td></td>
<td>Base URL</td>
</tr>
<tr>
<td>blog_path</td>
<td>str</td>
<td>/blog</td>
<td>Blog path prefix</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>str</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## FastHTML Integration Example

Complete SEO setup with FastHTML:

``` python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine
from fh_saas.utils_seo import generate_head_tags, generate_sitemap_xml, generate_rss_xml

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    # Generate SEO tags
    tags = generate_head_tags(
        title=post['title'],
        description=post['description'] or post['body'][:160],
        url=f"https://example.com/blog/{slug}",
        image_url=post.get('image'),
        article_published=post['date'],
        author=post.get('author')
    )
    
    # Render markdown
    html_content = engine.render(post['body'])
    
    return Html(
        Head(
            Title(post['title']),
            *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
              for tag, attrs in tags]
        ),
        Body(
            Article(NotStr(html_content))
        )
    )

@app.get('/sitemap.xml')
def sitemap():
    posts = loader.load_posts()
    xml = generate_sitemap_xml(posts, 'https://example.com')
    return Response(xml, media_type='application/xml')

@app.get('/rss.xml')
def rss():
    posts = loader.load_posts()[:20]
    xml = generate_rss_xml(
        posts=posts,
        blog_title='My Blog',
        blog_description='Tech tutorials',
        base_url='https://example.com'
    )
    return Response(xml, media_type='application/xml')
```


========================================

FILE: _proc/13_utils_workflow.html.md

# ğŸ”§ Workflow Engine


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Class</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_workflow.html#workflow"><code>Workflow</code></a></td>
<td>Execute callable steps sequentially</td>
</tr>
</tbody>
</table>

## ğŸ”§ Workflow Class

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Workflow(steps)</code></td>
<td>Initialize with list of callables</td>
</tr>
<tr>
<td><code>.execute()</code></td>
<td>Run all steps sequentially</td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import *
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L13"
target="_blank" style="float:right; font-size:smaller">source</a>

### Workflow

>  Workflow (steps:List[Callable])

*Execute a list of callables sequentially. Minimal wrapper for code
readability.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### Workflow.execute

>  Workflow.execute ()

*Execute all steps in order*


========================================

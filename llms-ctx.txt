FILE: _proc/00_db_host.html.md

---
description: The central registry for multi-tenant SaaS applications - managing users,
  tenants, and access control.
output-file: db_host.html
title: "\U0001F3E0 Multi-Tenant Setup"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

The **Host Database** is the backbone of a multi-tenant architecture. It answers the critical questions:

| Question | Model | Purpose |
|----------|-------|---------|
| ğŸ‘¤ **Who is this person?** | [`GlobalUser`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser) | Identity & authentication |
| ğŸ¢ **Where is their data?** | [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog) | Database routing |
| ğŸ”‘ **What can they access?** | [`Membership`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership) | Access control |
| ğŸ’³ **Are they paying?** | [`Subscription`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription) | Billing status |
| ğŸ“‹ **What happened?** | [`HostAuditLog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog) | Security audit trail |
| âš™ï¸ **Background work?** | [`SystemJob`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob) | Async operations |

---

## ğŸ—ï¸ Architecture

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         ğŸ  HOST DATABASE            â”‚
                    â”‚  (Single source of truth)           â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚  ğŸ‘¤ GlobalUser    â†’ Identity        â”‚
                    â”‚  ğŸ¢ TenantCatalog â†’ DB Routing      â”‚
                    â”‚  ğŸ”‘ Membership    â†’ Access Control  â”‚
                    â”‚  ğŸ’³ Subscription  â†’ Billing         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ—„ï¸ Tenant A   â”‚   â”‚ ğŸ—„ï¸ Tenant B   â”‚   â”‚ ğŸ—„ï¸ Tenant C   â”‚
    â”‚   Database    â”‚   â”‚   Database    â”‚   â”‚   Database    â”‚
    â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Principle:** User authenticates once â†’ Host routes to correct tenant â†’ Tenant data is isolated

## ğŸ› ï¸ Utilities

Helper functions used throughout the host database operations.

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L20){target="_blank" style="float:right; font-size:smaller"}

### gen_id

>      gen_id ()


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L19){target="_blank" style="float:right; font-size:smaller"}

### timestamp

>      timestamp ()


| Function | Description |
|----------|-------------|
| [`timestamp()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#timestamp) | ğŸ• Returns current UTC time in ISO format |
| [`gen_id()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#gen_id) | ğŸ†” Generates a unique 32-character hex ID |

---

## ğŸ“¦ Core Models

These dataclasses define the host database schema. Each model maps to a table with the `core_` or `sys_` prefix.

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L53){target="_blank" style="float:right; font-size:smaller"}

### SystemJob

>      SystemJob ()

*Maintenance: Provisioning & Cleanups*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L47){target="_blank" style="float:right; font-size:smaller"}

### HostAuditLog

>      HostAuditLog ()

*Security: Who changed the system?*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L40){target="_blank" style="float:right; font-size:smaller"}

### Subscription

>      Subscription ()

*Billing: Are they allowed to use the app?*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L34){target="_blank" style="float:right; font-size:smaller"}

### Membership

>      Membership ()

*Router: Which tenants can they access?*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L29){target="_blank" style="float:right; font-size:smaller"}

### TenantCatalog

>      TenantCatalog ()

*Registry: Where is the database?*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L23){target="_blank" style="float:right; font-size:smaller"}

### GlobalUser

>      GlobalUser ()

*Identity: Who is this person?*


### ğŸ“ Model Details

| Model | Table Name | Primary Key | Description |
|-------|------------|-------------|-------------|
| [`GlobalUser`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser) | `core_users` | `id` | OAuth identity, email, optional password hash, Stripe customer ID |
| [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog) | `core_tenants` | `id` | Maps tenant ID to database URL, tracks plan tier and status |
| [`Membership`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership) | `core_memberships` | `id` | Links users to tenants with roles (`owner`, `admin`, `member`) |
| [`Subscription`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription) | `core_subscriptions` | `id` | Stripe subscription state for billing enforcement |
| [`HostAuditLog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog) | `sys_audit_logs` | `id` | Immutable security log for compliance |
| [`SystemJob`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob) | `sys_jobs` | `id` | Background task queue for provisioning, cleanup |

---

## ğŸ”Œ HostDatabase Singleton

The [`HostDatabase`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase) class provides a **singleton** connection manager for the host database. 

âœ… **Why Singleton?**
- Single connection pool shared across the application
- Consistent transaction management
- Easy dependency injection for testing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Start                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  HostDatabase.from_env() â”‚  â† Reads DB_* env vars
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Creates tables if    â”‚
         â”‚   they don't exist     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Returns singleton     â”‚  â† Same instance everywhere
         â”‚  instance              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L62){target="_blank" style="float:right; font-size:smaller"}

### HostDatabase

>      HostDatabase (db_url:str=None)

*Singleton connection manager for the host database.*


### ğŸ”§ Methods

| Method | Description |
|--------|-------------|
| `from_env()` | ğŸ­ Factory method - creates instance from environment variables |
| `commit()` | âœ… Commit the current database transaction |
| `rollback()` | â†©ï¸ Rollback the current transaction on error |
| `reset_instance()` | ğŸ§ª Reset singleton (testing only) |

#### ğŸŒ Environment Variables for `from_env()`

| Variable | Default | Description |
|----------|---------|-------------|
| `DB_TYPE` | `POSTGRESQL` | Database type (`POSTGRESQL` or `SQLITE`) |
| `DB_USER` | `postgres` | Database username |
| `DB_PASS` | *(required)* | Database password |
| `DB_HOST` | `localhost` | Database host |
| `DB_PORT` | `5432` | Database port |
| `DB_NAME` | `app_host` | Database name |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L95){target="_blank" style="float:right; font-size:smaller"}

### HostDatabase.from_env

>      HostDatabase.from_env ()

*Create HostDatabase from DB_* environment variables.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L114){target="_blank" style="float:right; font-size:smaller"}

### HostDatabase.commit

>      HostDatabase.commit ()

*Commit current transaction.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L118){target="_blank" style="float:right; font-size:smaller"}

### HostDatabase.rollback

>      HostDatabase.rollback ()

*Rollback current transaction.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L123){target="_blank" style="float:right; font-size:smaller"}

### HostDatabase.reset_instance

>      HostDatabase.reset_instance ()

*Reset singleton instance (testing only).*


---

## ğŸš€ Quick Start

```python
from fh_saas.db_host import HostDatabase, GlobalUser, gen_id, timestamp

# Initialize singleton from environment
host_db = HostDatabase.from_env()

# Create a user
user = GlobalUser(
    id=gen_id(),
    email="user@example.com",
    oauth_id="google_123",
    created_at=timestamp()
)
host_db.global_users.insert(user)
host_db.commit()

# Query users
all_users = host_db.global_users()
```

ğŸ’¡ **Tip:** The singleton ensures you always get the same connection, so you can call [`HostDatabase.from_env()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase.from_env) anywhere in your app.



========================================

FILE: _proc/01_db_tenant.html.md

---
description: Isolated per-tenant data storage with user profiles, permissions, and
  settings.
output-file: db_tenant.html
title: "\U0001F5C4\uFE0F Tenant Databases"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

Each tenant gets their own **isolated database** containing:

| Model | Purpose |
|-------|---------|
| ğŸ‘¤ [`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser) | Local user profiles linked to global identity |
| ğŸ” [`TenantPermission`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission) | Fine-grained resource permissions |
| âš™ï¸ [`TenantSettings`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings) | Tenant-wide configuration |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ğŸ  HOST DATABASE                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ TenantCatalog â”‚ â”€â”€â–º Maps tenant_id â†’ database URL           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚  get_or_create_tenant_db(tenant_id)
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ—„ï¸ TENANT DATABASE                           â”‚
â”‚                    (Isolated per tenant)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ TenantUser      â†’ Local profile (links to GlobalUser.id)   â”‚
â”‚  ğŸ” TenantPermission â†’ Resource-level access control           â”‚
â”‚  âš™ï¸ TenantSettings   â†’ Timezone, currency, feature flags       â”‚
â”‚  ğŸª WebhookEvent     â†’ Idempotent webhook processing           â”‚
â”‚  ğŸ”‘ WebhookSecret    â†’ HMAC secrets per webhook source         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š [Your App Tables] â†’ Transactions, budgets, etc.            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Principle:** Tenant data is completely isolated â†’ No cross-tenant data leakage possible

## ğŸ”Œ Tenant Connection

::: {#81b63cfc .cell}
``` {.python .cell-code}
from nbdev.showdoc import show_doc
```
:::


[`get_or_create_tenant_db()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#get_or_create_tenant_db) handles the full lifecycle:

1. ğŸ” **Check** if tenant exists in host database
2. ğŸ—„ï¸ **Create** physical database if new (PostgreSQL)
3. ğŸ“ **Register** tenant in [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog)
4. ğŸ”Œ **Return** connection to tenant database

| Parameter | Description |
|-----------|-------------|
| `tenant_id` | Unique tenant identifier (from [`Membership`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership)) |
| `tenant_name` | Optional display name (defaults to tenant_id) |

**Returns:** `Database` connection to the tenant's isolated database

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L20){target="_blank" style="float:right; font-size:smaller"}

### get_or_create_tenant_db

>      get_or_create_tenant_db (tenant_id:str, tenant_name:str=None)

*Get or create a tenant database connection by tenant ID.*


---

## ğŸ“¦ Core Tenant Models

These models provide the infrastructure every tenant needs. Your app-specific models (transactions, budgets, etc.) build on top of these.

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L109){target="_blank" style="float:right; font-size:smaller"}

### TenantSettings

>      TenantSettings ()

*Tenant-wide configuration and feature flags.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L100){target="_blank" style="float:right; font-size:smaller"}

### TenantPermission

>      TenantPermission ()

*Fine-grained resource permission for a tenant user.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L91){target="_blank" style="float:right; font-size:smaller"}

### TenantUser

>      TenantUser ()

*Local user profile linked to GlobalUser in host database.*


### ğŸ“ Model Details

| Model | Table Name | Primary Key | Description |
|-------|------------|-------------|-------------|
| [`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser) | `core_tenant_users` | `id` | Links to `GlobalUser.id`, stores local role & preferences |
| [`TenantPermission`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission) | `core_permissions` | `id` | Resource + action permissions (RBAC) |
| [`TenantSettings`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings) | `core_settings` | `id` | Timezone, currency, feature flags |

---

## ğŸ”§ Schema Initialization

[`init_tenant_core_schema()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#init_tenant_core_schema) creates all infrastructure tables in a tenant database:

```
tenant_db = get_or_create_tenant_db("tenant_abc")
tables = init_tenant_core_schema(tenant_db)

# Access tables via returned dict
tables['tenant_users'].insert(user)
tables['settings'].insert(settings)
```

**Returns:** Dictionary of table accessors for all core models

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L119){target="_blank" style="float:right; font-size:smaller"}

### init_tenant_core_schema

>      init_tenant_core_schema (tenant_db:fastsql.core.Database)

*Create all core tenant tables and return table accessors.*


---

## ğŸš€ Quick Start

```python
from fh_saas.db_tenant import get_or_create_tenant_db, init_tenant_core_schema, TenantUser
from fh_saas.db_host import gen_id, timestamp

# Get or create tenant database
tenant_db = get_or_create_tenant_db("tenant_abc123", "Acme Corp")

# Initialize core schema
tables = init_tenant_core_schema(tenant_db)

# Add a tenant user (linked to GlobalUser.id)
user = TenantUser(
    id="global_user_xyz",  # Must match GlobalUser.id
    display_name="John Doe",
    local_role="admin",
    created_at=timestamp()
)
tables['tenant_users'].insert(user)
tenant_db.conn.commit()
```

ğŸ’¡ **Tip:** The `id` field in [`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser) **must match** the `GlobalUser.id` from the host database to maintain identity linking.



========================================

FILE: _proc/15_utils_db.html.md

---
description: Atomic table and index management utilities for tenant databases.
output-file: utils_db.html
title: "\U0001F5C4\uFE0F Table Management"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`register_table`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table) | Create table from dataclass model |
| [`register_tables`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables) | Create multiple tables atomically |
| [`drop_table`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table) | Drop table if exists |
| [`create_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index) | Create index with dialect-specific SQL |
| [`drop_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index) | Drop index if exists |
| `list_tables` | List all tables in database |
| `list_indexes` | List indexes for a table |

## ğŸ“‹ Table Registration

| Function | Purpose |
|----------|---------|
| [`register_table`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table) | Create single table from dataclass |
| [`register_tables`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables) | Create multiple tables atomically |
| [`drop_table`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table) | Drop table if exists |

**Example:**

```python
class Transaction:
    id: str
    amount: float
    date: str
    category: str = None

tenant_db = get_or_create_tenant_db("tenant_123")
transactions = register_table(tenant_db, Transaction, "transactions")

# Use table object for CRUD
transactions.insert(Transaction(id="t1", amount=100.0, date="2024-01-01"))
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L21){target="_blank" style="float:right; font-size:smaller"}

### register_table

>      register_table (tenant_db:fastsql.core.Database, model_class:Type,
>                      table_name:str, pk:str='id')

*Create a table from a dataclass model if it doesn't exist (atomic).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L33){target="_blank" style="float:right; font-size:smaller"}

### register_tables

>      register_tables (tenant_db:fastsql.core.Database,
>                       models:List[Tuple[Type,str,str]])

*Create multiple tables atomically (all succeed or all rollback).*


**Parameters:**
- `models`: List of tuples `[(ModelClass, table_name, pk), ...]`

**Returns:** Dict mapping table names to table objects `{table_name: table_object}`

**Example:**

```python
class Transaction:
    id: str; amount: float; date: str

class Connection:
    id: str; provider: str; status: str

tables = register_tables(tenant_db, [
    (Transaction, "transactions", "id"),
    (Connection, "connections", "id"),
])

tables["transactions"].insert(...)
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L49){target="_blank" style="float:right; font-size:smaller"}

### drop_table

>      drop_table (tenant_db:fastsql.core.Database, table_name:str)

*Drop a table if it exists (atomic operation).*


## ğŸ“‡ Index Management

| Function | Purpose |
|----------|---------|
| [`create_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index) | Create index with dialect-specific SQL |
| [`create_indexes`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_indexes) | Create multiple indexes atomically |
| [`drop_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index) | Drop index if exists |

**Parameters for [`create_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index):**

| Parameter | Description |
|-----------|-------------|
| `table_name` | Name of the table |
| `columns` | List of column names to index |
| `unique` | If True, creates UNIQUE index (default: False) |
| `index_name` | Custom name (auto-generates `idx_{table}_{cols}` if None) |

**Example:**

```python
# Simple index
create_index(tenant_db, "transactions", ["date"])

# Composite unique index
create_index(tenant_db, "transactions", ["account_id", "external_id"], unique=True)

# Custom name
create_index(tenant_db, "transactions", ["category"], index_name="idx_txn_cat")
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L61){target="_blank" style="float:right; font-size:smaller"}

### create_index

>      create_index (tenant_db:fastsql.core.Database, table_name:str,
>                    columns:List[str], unique:bool=False, index_name:str=None)

*Create an index on a table if it doesn't exist (atomic operation).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L83){target="_blank" style="float:right; font-size:smaller"}

### create_indexes

>      create_indexes (tenant_db:fastsql.core.Database,
>                      indexes:List[Tuple[str,List[str],bool,Optional[str]]])

*Create multiple indexes atomically (all succeed or all rollback).*


**Parameters:**
- `indexes`: List of tuples `[(table_name, columns, unique, index_name), ...]`
- `index_name` can be `None` for auto-generated names

**Example:**

```python
create_indexes(tenant_db, [
    ("transactions", ["date"], False, None),
    ("transactions", ["account_id", "external_id"], True, "idx_txn_unique"),
    ("connections", ["provider"], False, None),
])
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L107){target="_blank" style="float:right; font-size:smaller"}

### drop_index

>      drop_index (tenant_db:fastsql.core.Database, index_name:str,
>                  table_name:str=None)

*Drop an index if it exists (atomic operation).*


## ğŸ” Schema Introspection

| Function | Purpose |
|----------|---------|
| [`table_exists`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#table_exists) | Check if a table exists |

**Example:**

```python
if not table_exists(tenant_db, "transactions"):
    transactions = register_table(tenant_db, Transaction, "transactions")
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L127){target="_blank" style="float:right; font-size:smaller"}

### table_exists

>      table_exists (tenant_db:fastsql.core.Database, table_name:str)

*Check if a table exists in the database.*


## Usage Example

Complete workflow: Define dataclass models â†’ Get tenant DB â†’ Register tables â†’ Create indexes



========================================

FILE: _proc/04_utils_auth.html.md

---
description: Multi-user tenant authentication with Google OAuth, CSRF protection,
  and automatic tenant provisioning.
output-file: utils_auth.html
title: "\U0001F510 Authentication"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Category | Functions | Purpose |
|----------|-----------|--------|
| ğŸ›¡ï¸ Beforeware | [`create_auth_beforeware`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware) | Protect routes, auto-setup tenant DB |
| ğŸ”‘ OAuth Client | [`get_google_oauth_client`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client) | Initialize Google OAuth |
| ğŸ”’ CSRF | [`generate_oauth_state`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state), [`verify_oauth_state`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state) | Prevent session hijacking |
| ğŸ‘¤ Users | [`create_or_get_global_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user), [`get_user_membership`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership), [`verify_membership`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership) | User & membership management |
| ğŸ—ï¸ Provisioning | [`provision_new_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user) | Auto-create tenant for new users |
| ğŸ“‹ Session | [`create_user_session`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session), [`get_current_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user), [`clear_session`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session) | Session management |
| ğŸš¦ Routing | [`route_user_after_login`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login), [`require_tenant_access`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access) | Authorization & routing |
| ğŸŒ Handlers | [`handle_login_request`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request), [`handle_oauth_callback`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback), [`handle_logout`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout) | Route implementations |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OAuth Authentication Flow                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. User clicks "Login with Google"                             â”‚
â”‚  2. Generate CSRF state token â†’ store in session                â”‚
â”‚  3. Redirect to Google OAuth                                    â”‚
â”‚  4. Google authenticates â†’ redirects with code + state          â”‚
â”‚  5. Verify CSRF state matches session                           â”‚
â”‚  6. Exchange code for user info                                 â”‚
â”‚  7. Create/get GlobalUser in host DB                            â”‚
â”‚  8. Check membership OR auto-provision new tenant               â”‚
â”‚  9. Create session â†’ redirect to dashboard                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Tenant Model                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Many Users â†’ One Tenant (many-to-one)                          â”‚
â”‚  Each user belongs to exactly ONE tenant                        â”‚
â”‚  Each tenant can have MANY users                                â”‚
â”‚  New users auto-create their own tenant                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Quick Reference

### Security Features

| Feature | Protection |
|---------|-----------|
| CSRF State Token | Prevents session hijacking attacks |
| Membership Validation | Ensures cross-tenant isolation |
| Audit Logging | Tracks all authentication events |

### Token Expiry

| Token Type | Expiry | Current Behavior |
|------------|--------|------------------|
| Google OAuth | 1 hour | User must re-login |
| Session | Configurable | Starlette signed cookie |

> ğŸ’¡ **Future**: Implement refresh token flow for seamless re-authentication

::: {#4c01a905 .cell}
``` {.python .cell-code}
from nbdev.showdoc import show_doc
```
:::


---

## ğŸ›¡ï¸ Auth Beforeware

Protect routes by checking for authenticated sessions with auto tenant DB setup.

| Function | Purpose |
|----------|--------|
| [`create_auth_beforeware`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware) | Factory to create route protection middleware |

> ğŸ’¡ **Use case**: Pass to FastHTML's `before=` parameter for app-wide authentication

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L51){target="_blank" style="float:right; font-size:smaller"}

### create_auth_beforeware

>      create_auth_beforeware (redirect_path:str='/login',
>                              session_key:str='user_id', skip:list[str]=None,
>                              include_defaults:bool=True,
>                              setup_tenant_db:bool=True)

*Create Beforeware that checks for authenticated session and sets up request.state.*


---

## ğŸ”‘ OAuth Client

| Function | Purpose |
|----------|--------|
| [`get_google_oauth_client`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client) | Initialize Google OAuth client from env vars |

> âš ï¸ **Required env vars**: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L92){target="_blank" style="float:right; font-size:smaller"}

### get_google_oauth_client

>      get_google_oauth_client ()

*Initialize Google OAuth client with credentials from environment.*


---

## ğŸ”’ CSRF Protection

Prevent session hijacking via state token validation.

| Function | Purpose |
|----------|--------|
| [`generate_oauth_state`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state) | Create random UUID for CSRF protection |
| [`verify_oauth_state`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state) | Validate callback state matches session |

### Attack Without CSRF Protection

```
1. Attacker initiates OAuth â†’ gets auth code
2. Attacker sends victim: yourapp.com/auth/callback?code=ATTACKER_CODE
3. Victim clicks â†’ session created for attacker's account
4. Victim enters data â†’ attacker sees it all
```

> ğŸ›¡ï¸ **Solution**: State token generated at login, verified at callback

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L108){target="_blank" style="float:right; font-size:smaller"}

### verify_oauth_state

>      verify_oauth_state (session:dict, callback_state:str)

*Verify OAuth callback state matches stored session state (CSRF protection).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L103){target="_blank" style="float:right; font-size:smaller"}

### generate_oauth_state

>      generate_oauth_state ()

*Generate cryptographically secure random state token for CSRF protection.*


---

## ğŸ‘¤ User Management

| Function | Purpose |
|----------|--------|
| [`create_or_get_global_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user) | Create or retrieve user from host DB |
| [`get_user_membership`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership) | Get user's active tenant membership |
| [`verify_membership`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership) | Validate user has access to tenant |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L160){target="_blank" style="float:right; font-size:smaller"}

### verify_membership

>      verify_membership (host_db:fh_saas.db_host.HostDatabase, user_id:str,
>                         tenant_id:str)

*Verify user has active membership for specific tenant.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L152){target="_blank" style="float:right; font-size:smaller"}

### get_user_membership

>      get_user_membership (host_db:fh_saas.db_host.HostDatabase, user_id:str)

*Get single active membership for user.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L121){target="_blank" style="float:right; font-size:smaller"}

### create_or_get_global_user

>      create_or_get_global_user (host_db:fh_saas.db_host.HostDatabase,
>                                 oauth_id:str, email:str, oauth_info:dict=None)

*Create or retrieve GlobalUser from host database.*


---

## ğŸ—ï¸ Auto-Provisioning

Create tenant infrastructure for first-time users.

| Function | Purpose |
|----------|--------|
| [`provision_new_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user) | Create tenant DB, catalog entry, membership, and TenantUser |

### Provisioning Steps

```
1. Create physical tenant database (PostgreSQL/SQLite)
2. Register tenant in host catalog
3. Create membership (user â†’ tenant, role='owner')
4. Create TenantUser profile (local_role='admin')
5. Initialize core tenant schema
6. Log audit event
```

> ğŸ’¡ **Future**: Insert payment screen before step 1

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L168){target="_blank" style="float:right; font-size:smaller"}

### provision_new_user

>      provision_new_user (host_db:fh_saas.db_host.HostDatabase,
>                          global_user:fh_saas.db_host.GlobalUser)

*Auto-provision new tenant for first-time user.*


---

## ğŸ“‹ Session Management

| Function | Purpose |
|----------|--------|
| [`create_user_session`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session) | Populate session after successful OAuth |
| [`get_current_user`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user) | Extract user info from session |
| [`clear_session`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session) | Clear all session data (logout) |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L251){target="_blank" style="float:right; font-size:smaller"}

### clear_session

>      clear_session (session:dict)

*Clear all session data (logout).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L237){target="_blank" style="float:right; font-size:smaller"}

### get_current_user

>      get_current_user (session:dict)

*Extract current user info from session.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L227){target="_blank" style="float:right; font-size:smaller"}

### create_user_session

>      create_user_session (session:dict,
>                           global_user:fh_saas.db_host.GlobalUser,
>                           membership:fh_saas.db_host.Membership)

*Create authenticated session after successful OAuth login.*


---

## ğŸš¦ Route Helpers

| Function | Purpose |
|----------|--------|
| [`route_user_after_login`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login) | Determine redirect URL based on user type |
| [`require_tenant_access`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access) | Get tenant DB with membership validation |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L265){target="_blank" style="float:right; font-size:smaller"}

### require_tenant_access

>      require_tenant_access (request_or_session)

*Get tenant database with membership validation.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L256){target="_blank" style="float:right; font-size:smaller"}

### route_user_after_login

>      route_user_after_login (global_user:fh_saas.db_host.GlobalUser,
>                              membership:fh_saas.db_host.Membership=None)

*Determine redirect URL based on user type and membership.*


## ğŸŒ OAuth Route Handlers

Complete OAuth 2.0 flow handlers:

| Function | Purpose |
|----------|---------|
| [`handle_login_request`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request) | Initiate OAuth with CSRF protection |
| [`handle_oauth_callback`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback) | Process provider response |
| [`handle_logout`](https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout) | Clear session and redirect |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L347){target="_blank" style="float:right; font-size:smaller"}

### handle_logout

>      handle_logout (session)

*Clear session and redirect to login page.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L303){target="_blank" style="float:right; font-size:smaller"}

### handle_oauth_callback

>      handle_oauth_callback (code:str, state:str, request, session)

*Complete OAuth flow: CSRF verify â†’ user info â†’ provision â†’ session â†’ redirect.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L287){target="_blank" style="float:right; font-size:smaller"}

### handle_login_request

>      handle_login_request (request, session)

*Generate Google OAuth URL with CSRF state protection.*




========================================

FILE: _proc/06_utils_log.html.md

---
description: One-time logging configuration for all fh_saas modules.
output-file: utils_log.html
title: "\U0001F4CA Logging"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`configure_logging`](https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging) | One-time setup at app startup |

---

## ğŸ“‹ Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `FH_SAAS_LOG_LEVEL` | WARNING | DEBUG, INFO, WARNING, ERROR |
| `FH_SAAS_LOG_FILE` | (none) | Path to log file (optional) |

## âš™ï¸ configure_logging

::: {#5220a577 .cell}
``` {.python .cell-code}
from nbdev.showdoc import show_doc
```
:::


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_log.py#L15){target="_blank" style="float:right; font-size:smaller"}

### configure_logging

>      configure_logging (log_file:str=None, level:str=None,
>                         max_bytes:int=10000000, backup_count:int=5)

*Configure logging for all fh_saas modules - call once at app startup.*


## ğŸ“– Usage Examples

### 1. App Startup (call once in main.py)

```python
from fh_saas.utils_log import configure_logging

# Option A: Use environment variables (recommended for production)
# Set FH_SAAS_LOG_LEVEL=INFO and FH_SAAS_LOG_FILE=./logs/app.log in .env
configure_logging()

# Option B: Explicit - console only
configure_logging(level='INFO')

# Option C: Console + rotating file
configure_logging(level='INFO', log_file='./logs/app.log')
```

### 2. In Any fh_saas Module (already done)

Every module in fh_saas declares a logger at the top:

```python
# fh_saas/utils_oauth.py
import logging
logger = logging.getLogger(__name__)

def handle_login_request(request, session):
    logger.debug('Login request initiated')
    # ... do work ...
    logger.info(f'OAuth complete, redirecting to {redirect_url}')
```

### 3. Where Do Logs Go?

| Configuration | Console | File |
|--------------|---------|------|
| [`configure_logging()`](https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging) | âœ… | âŒ |
| `configure_logging(log_file='app.log')` | âœ… | âœ… |
| No [`configure_logging()`](https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging) call | âŒ silent | âŒ |

### 4. Log Levels

| Level | When to Use | Example |
|-------|-------------|---------|
| `DEBUG` | Detailed diagnostic | `logger.debug('Checking user session')` |
| `INFO` | Normal operations | `logger.info('User logged in')` |
| `WARNING` | Unexpected but not failing | `logger.warning('Token expiring soon')` |
| `ERROR` | Operation failed | `logger.error('Auth failed', exc_info=True)` |

### 5. Real Example from fh_saas

```python
# In your FastHTML app
from fasthtml.common import *
from fh_saas.utils_log import configure_logging
from fh_saas.utils_oauth import handle_login_request, handle_oauth_callback

# Configure logging ONCE at startup
configure_logging(level='INFO', log_file='./logs/app.log')

app = FastHTML()

@app.get('/login')
def login(request, session):
    return handle_login_request(request, session)  # Logs automatically

@app.get('/auth/callback') 
def callback(code: str, state: str, request, session):
    return handle_oauth_callback(code, state, request, session)  # Logs automatically
```

Output in console and file:
```
2026-01-10 14:30:00 | fh_saas.utils_oauth | DEBUG | Login request initiated
2026-01-10 14:30:05 | fh_saas.utils_oauth | DEBUG | OAuth callback received
2026-01-10 14:30:05 | fh_saas.utils_oauth | INFO | OAuth complete, redirecting to /dashboard
```



========================================

FILE: _proc/07_utils_api.html.md

---
description: Async HTTP client with automatic retry logic and auth helpers.
output-file: utils_api.html
title: "\U0001F310 HTTP Client"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Category | Functions | Purpose |
|----------|-----------|---------|
| ğŸ”„ Client | [`AsyncAPIClient`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient) | Async HTTP with retry |
| ğŸ”‘ Auth | [`bearer_token_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth), [`api_key_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth), [`oauth_token_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth) | Auth header generators |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Retry Logic Flow                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Request â†’ Response                                             â”‚
â”‚     â†“                                                           â”‚
â”‚  Status 429 or 500+ â†’ Retry (exponential: 2s, 4s, 8s)          â”‚
â”‚     â†“                                                           â”‚
â”‚  Status 400-499 (except 429) â†’ Fail immediately                â”‚
â”‚     â†“                                                           â”‚
â”‚  Network error â†’ Retry                                          â”‚
â”‚     â†“                                                           â”‚
â”‚  Max 3 attempts â†’ Raise exception                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ AsyncAPIClient

| Method | Purpose |
|--------|---------|
| [`AsyncAPIClient`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient) | Async HTTP client with retry |
| `.request()` | Execute HTTP request with retry |
| `.get_json()` | GET request returning JSON |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L28){target="_blank" style="float:right; font-size:smaller"}

### AsyncAPIClient

>      AsyncAPIClient (base_url:str, auth_headers:dict=None, timeout:int=30)

*Async HTTP client with retry logic for external API integrations.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L31){target="_blank" style="float:right; font-size:smaller"}

### AsyncAPIClient.__init__

>      AsyncAPIClient.__init__ (base_url:str, auth_headers:dict=None,
>                               timeout:int=30)

*Initialize client with base URL, optional auth headers, and timeout.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L63){target="_blank" style="float:right; font-size:smaller"}

### AsyncAPIClient.request

>      AsyncAPIClient.request (method:str, endpoint:str, params:dict=None,
>                              json:dict=None, headers:dict=None)

*Execute HTTP request with automatic retry on 429/500+ errors.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L87){target="_blank" style="float:right; font-size:smaller"}

### AsyncAPIClient.get_json

>      AsyncAPIClient.get_json (endpoint:str, params:dict=None)

*Convenience GET that returns parsed JSON.*


## ğŸ”‘ Auth Helpers

| Function | Purpose |
|----------|---------|
| [`bearer_token_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth) | Bearer token header |
| [`api_key_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth) | API key header (customizable) |
| [`oauth_token_auth`](https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth) | OAuth 2.0 access token |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L97){target="_blank" style="float:right; font-size:smaller"}

### bearer_token_auth

>      bearer_token_auth (token:str)

*Generate Bearer token authentication header.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L102){target="_blank" style="float:right; font-size:smaller"}

### api_key_auth

>      api_key_auth (api_key:str, header_name:str='X-API-Key')

*Generate API key header with customizable header name.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L107){target="_blank" style="float:right; font-size:smaller"}

### oauth_token_auth

>      oauth_token_auth (access_token:str)

*Generate OAuth 2.0 access token header (alias for bearer_token_auth).*




========================================

FILE: _proc/08_utils_graphql.html.md

---
description: GraphQL client with streaming pagination for memory-efficient data fetching.
output-file: utils_graphql.html
title: "\U0001F52E GraphQL Client"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Method | Purpose |
|--------|---------|
| [`GraphQLClient`](https://abhisheksreesaila.github.io/fh-saas/utils_graphql.html#graphqlclient) | GraphQL client with async generator pagination |
| `.execute_query()` | Execute single query |
| `.execute_mutation()` | Execute mutation |
| `.fetch_pages_generator()` | Stream paginated data |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Streaming Pagination Flow                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Page 1: query($cursor: null) â†’ yield [batch] â†’ process        â”‚
â”‚  Page 2: query($cursor: xyz)  â†’ yield [batch] â†’ process        â”‚
â”‚  Page N: query($cursor: abc)  â†’ yield [batch] â†’ process        â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ CRITICAL: Never accumulates full dataset in memory         â”‚
â”‚  âœ… Memory: O(page_size) not O(total_records)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”® GraphQLClient

| Method | Purpose |
|--------|---------|
| `.execute_query()` | Execute single GraphQL query |
| `.execute_mutation()` | Execute GraphQL mutation |
| `.fetch_pages_generator()` | Async generator for paginated data |

---

### Usage Example

```python
from fh_saas.utils_api import AsyncAPIClient, bearer_token_auth
from fh_saas.utils_graphql import GraphQLClient

async with AsyncAPIClient(
    'https://api.example.com/graphql',
    auth_headers=bearer_token_auth('TOKEN')
) as http_client:
    
    client = GraphQLClient(http_client)
    
    # Single query
    result = await client.execute_query(
        query='{ users { id name } }'
    )
    
    # Paginated streaming (memory-efficient)
    async for batch in client.fetch_pages_generator(
        query_template='''
            query($cursor: String) {
                users(after: $cursor, first: 1000) {
                    nodes { id name email }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        variables={'cursor': None},
        items_path=['data', 'users', 'nodes'],
        cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
        has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
    ):
        print(f"Processing batch of {len(batch)} records")
        # Process batch immediately - never load full dataset
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L18){target="_blank" style="float:right; font-size:smaller"}

### GraphQLClient

>      GraphQLClient (api_client:fh_saas.utils_api.AsyncAPIClient,
>                     endpoint:str='')

*GraphQL client with streaming pagination for memory-efficient data fetching.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| api_client | AsyncAPIClient |  | Initialized AsyncAPIClient instance |
| endpoint | str |  | GraphQL endpoint path (default: '' for base URL) |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L21){target="_blank" style="float:right; font-size:smaller"}

### GraphQLClient.__init__

>      GraphQLClient.__init__ (api_client:fh_saas.utils_api.AsyncAPIClient,
>                              endpoint:str='')

*Initialize self.  See help(type(self)) for accurate signature.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| api_client | AsyncAPIClient |  | Initialized AsyncAPIClient instance |
| endpoint | str |  | GraphQL endpoint path (default: '' for base URL) |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L29){target="_blank" style="float:right; font-size:smaller"}

### GraphQLClient.execute_query

>      GraphQLClient.execute_query (query:str, variables:dict=None)

*Execute a single GraphQL query and return the JSON response.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| query | str |  | GraphQL query string |
| variables | dict | None | Query variables |
| **Returns** | **Dict** |  |  |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L54){target="_blank" style="float:right; font-size:smaller"}

### GraphQLClient.execute_mutation

>      GraphQLClient.execute_mutation (mutation:str, variables:dict=None)

*Execute a GraphQL mutation (alias for execute_query).*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| mutation | str |  | GraphQL mutation string |
| variables | dict | None | Mutation variables |
| **Returns** | **Dict** |  |  |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L62){target="_blank" style="float:right; font-size:smaller"}

### GraphQLClient.fetch_pages_generator

>      GraphQLClient.fetch_pages_generator (query_template:str, variables:dict,
>                                           items_path:list[str],
>                                           cursor_path:list[str],
>                                           has_next_path:list[str]=None,
>                                           cursor_var:str='cursor')

*Stream paginated GraphQL data page-by-page using async generator.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| query_template | str |  | GraphQL query with $variables placeholders |
| variables | dict |  | Initial variables (must include cursor key) |
| items_path | list |  | JSONPath to list of items (e.g., ['data', 'users', 'nodes']) |
| cursor_path | list |  | JSONPath to next cursor (e.g., ['data', 'users', 'pageInfo', 'endCursor']) |
| has_next_path | list | None | Optional path to hasNextPage boolean (if None, checks cursor != None) |
| cursor_var | str | cursor | Variable name for cursor in query (default: 'cursor') |
| **Returns** | **AsyncGenerator** |  |  |


### Streaming Pagination Details

**Why use generators?** For large datasets (millions of rows), accumulating all data in memory causes OOM errors. The async generator yields batches instead.

**Parameters:**

| Parameter | Description |
|-----------|-------------|
| `query_template` | GraphQL query with `$cursor` variable |
| `variables` | Initial variables dict (e.g., `{'cursor': None}`) |
| `items_path` | Path to data list in response (e.g., `['data', 'users', 'nodes']`) |
| `cursor_path` | Path to next cursor (e.g., `['data', 'users', 'pageInfo', 'endCursor']`) |
| `has_next_path` | Optional path to `hasNextPage` flag |
| `cursor_var` | Cursor variable name in query (default: `'cursor'`) |

**Example with database insert:**

```python
async for batch in client.fetch_pages_generator(
    query_template='''
        query($cursor: String) {
            users(after: $cursor, first: 1000) {
                nodes { id name }
                pageInfo { hasNextPage endCursor }
            }
        }
    ''',
    variables={'cursor': None},
    items_path=['data', 'users', 'nodes'],
    cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
    has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
):
    # Process each batch immediately
    df = pl.DataFrame(batch)
    df.write_database('staging_table', connection=conn)
```



========================================

FILE: _proc/14_utils_webhook.html.md

---
description: Process webhooks with signature verification, idempotency, and custom
  handlers.
output-file: utils_webhook.html
title: "\U0001FA9D Webhooks"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`verify_webhook_signature`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature) | HMAC-SHA256 signature verification |
| [`check_idempotency`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency) | Prevent duplicate processing |
| [`log_webhook_event`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event) | Persist event to database |
| [`process_webhook`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook) | Main orchestration function |
| [`handle_webhook_request`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request) | FastHTML route handler |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Webhook Processing Flow                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Request â†’ Verify Signature â†’ Check Idempotency â†’ Log Event    â”‚
â”‚     â†“           âœ…              âœ… (not duplicate)              â”‚
â”‚  Execute Handler â†’ Update Status â†’ Return Response              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Signature Verification

| Function | Purpose |
|----------|---------|
| [`verify_webhook_signature`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature) | HMAC-SHA256 with timing-safe comparison |

::: {#8dde5d59 .cell}
``` {.python .cell-code}
from nbdev.showdoc import *
```
:::


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25){target="_blank" style="float:right; font-size:smaller"}

### verify_webhook_signature

>      verify_webhook_signature (payload:str, signature:str,
>                                secret:Optional[str]=None)

*Verify HMAC-SHA256 signature for webhook payload. Returns True if valid.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| payload | str |  | Raw request body as string |
| signature | str |  | Signature from header (format: "sha256=<hex>") |
| secret | Optional | None | Secret key, defaults to WEBHOOK_SECRET env var |
| **Returns** | **bool** |  |  |


## ğŸ”„ Idempotency

| Function | Purpose |
|----------|---------|
| [`check_idempotency`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency) | Check if event already processed |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50){target="_blank" style="float:right; font-size:smaller"}

### check_idempotency

>      check_idempotency (db:fastsql.core.Database, idempotency_key:str)

*Check if webhook event already processed. Returns True if duplicate.*

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| db | Database | Tenant database connection |
| idempotency_key | str | Unique key for this webhook event |
| **Returns** | **bool** |  |


## ğŸ“ Event Logging

| Function | Purpose |
|----------|---------|
| [`log_webhook_event`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event) | Persist event to database |
| [`update_webhook_status`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#update_webhook_status) | Update status after processing |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62){target="_blank" style="float:right; font-size:smaller"}

### log_webhook_event

>      log_webhook_event (db:fastsql.core.Database, webhook_id:str, source:str,
>                         event_type:str, payload:Dict[str,Any], signature:str,
>                         idempotency_key:str, status:str='pending')

*Log webhook event to database*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Unique webhook ID |
| source | str |  | Source system (e.g., "stripe", "github") |
| event_type | str |  | Event type (e.g., "payment.success") |
| payload | Dict |  | Full webhook payload |
| signature | str |  | Request signature |
| idempotency_key | str |  | Idempotency key |
| status | str | pending | Status: pending, processing, completed, failed |


## Update Webhook Status

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85){target="_blank" style="float:right; font-size:smaller"}

### update_webhook_status

>      update_webhook_status (db:fastsql.core.Database, webhook_id:str,
>                             status:str, error_message:Optional[str]=None)

*Update webhook event status and processed timestamp*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Webhook ID to update |
| status | str |  | New status |
| error_message | Optional | None | Optional error message |


## âš¡ Process Webhook

| Function | Purpose |
|----------|---------|
| [`process_webhook`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook) | Main orchestration function |
| [`handle_webhook_request`](https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request) | FastHTML route handler |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102){target="_blank" style="float:right; font-size:smaller"}

### process_webhook

>      process_webhook (db:fastsql.core.Database, webhook_id:str, source:str,
>                       event_type:str, payload:Dict[str,Any], signature:str,
>                       idempotency_key:str, raw_body:str, handler:Callable,
>                       secret:Optional[str]=None)

*Process webhook with verification, idempotency, and custom handler execution*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Unique webhook ID |
| source | str |  | Source system |
| event_type | str |  | Event type |
| payload | Dict |  | Webhook payload |
| signature | str |  | Request signature |
| idempotency_key | str |  | Idempotency key |
| raw_body | str |  | Raw request body for signature verification |
| handler | Callable |  | App-specific webhook handler function |
| secret | Optional | None | Optional webhook secret |
| **Returns** | **Dict** |  |  |


::: {#6dd1a371 .cell}
``` {.python .cell-code}
from nbdev.showdoc import show_doc
```
:::


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25){target="_blank" style="float:right; font-size:smaller"}

### verify_webhook_signature

>      verify_webhook_signature (payload:str, signature:str,
>                                secret:Optional[str]=None)

*Verify HMAC-SHA256 signature for webhook payload. Returns True if valid.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| payload | str |  | Raw request body as string |
| signature | str |  | Signature from header (format: "sha256=<hex>") |
| secret | Optional | None | Secret key, defaults to WEBHOOK_SECRET env var |
| **Returns** | **bool** |  |  |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50){target="_blank" style="float:right; font-size:smaller"}

### check_idempotency

>      check_idempotency (db:fastsql.core.Database, idempotency_key:str)

*Check if webhook event already processed. Returns True if duplicate.*

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| db | Database | Tenant database connection |
| idempotency_key | str | Unique key for this webhook event |
| **Returns** | **bool** |  |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62){target="_blank" style="float:right; font-size:smaller"}

### log_webhook_event

>      log_webhook_event (db:fastsql.core.Database, webhook_id:str, source:str,
>                         event_type:str, payload:Dict[str,Any], signature:str,
>                         idempotency_key:str, status:str='pending')

*Log webhook event to database*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Unique webhook ID |
| source | str |  | Source system (e.g., "stripe", "github") |
| event_type | str |  | Event type (e.g., "payment.success") |
| payload | Dict |  | Full webhook payload |
| signature | str |  | Request signature |
| idempotency_key | str |  | Idempotency key |
| status | str | pending | Status: pending, processing, completed, failed |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85){target="_blank" style="float:right; font-size:smaller"}

### update_webhook_status

>      update_webhook_status (db:fastsql.core.Database, webhook_id:str,
>                             status:str, error_message:Optional[str]=None)

*Update webhook event status and processed timestamp*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Webhook ID to update |
| status | str |  | New status |
| error_message | Optional | None | Optional error message |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102){target="_blank" style="float:right; font-size:smaller"}

### process_webhook

>      process_webhook (db:fastsql.core.Database, webhook_id:str, source:str,
>                       event_type:str, payload:Dict[str,Any], signature:str,
>                       idempotency_key:str, raw_body:str, handler:Callable,
>                       secret:Optional[str]=None)

*Process webhook with verification, idempotency, and custom handler execution*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| db | Database |  | Tenant database connection |
| webhook_id | str |  | Unique webhook ID |
| source | str |  | Source system |
| event_type | str |  | Event type |
| payload | Dict |  | Webhook payload |
| signature | str |  | Request signature |
| idempotency_key | str |  | Idempotency key |
| raw_body | str |  | Raw request body for signature verification |
| handler | Callable |  | App-specific webhook handler function |
| secret | Optional | None | Optional webhook secret |
| **Returns** | **Dict** |  |  |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L144){target="_blank" style="float:right; font-size:smaller"}

### handle_webhook_request

>      handle_webhook_request (request, db:fastsql.core.Database, source:str,
>                              handler:Callable,
>                              signature_header:str='X-Webhook-Signature',
>                              idempotency_header:str='X-Idempotency-Key',
>                              event_type_field:str='type',
>                              secret:Optional[str]=None)

*FastHTML route handler for webhook requests.*

Example:
    @app.post('/webhooks/stripe')
    async def stripe_webhook(request):
        return await handle_webhook_request(
            request=request,
            db=get_tenant_db(request),
            source='stripe',
            handler=handle_stripe_event,
            signature_header='X-Stripe-Signature',
            run_in_background=True
        )

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| request |  |  | FastHTML request object |
| db | Database |  | Tenant database instance |
| source | str |  | Webhook source identifier |
| handler | Callable |  | App-specific handler function |
| signature_header | str | X-Webhook-Signature | Header containing signature |
| idempotency_header | str | X-Idempotency-Key | Header containing idempotency key |
| event_type_field | str | type | Field in payload containing event type |
| secret | Optional | None | Optional webhook secret |
| **Returns** | **tuple** |  | **Returns (response_dict, status_code)** |




========================================

FILE: _proc/02_utils_sql.html.md

---
description: Comprehensive SQL helper library for database operations with multi-database
  support.
output-file: utils_sql.html
title: "\U0001F5C3\uFE0F SQL Helpers"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

This module provides a **batteries-included SQL toolkit** for building database-heavy applications:

| Category | Functions | Purpose |
|----------|-----------|--------|
| ğŸ” Query Registry | [`run_id`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id), [`validate_params`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params) | Execute queries by ID from centralized registries |
| â• Insert-Only | [`insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only), [`bulk_insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only) | Insert new records, skip conflicts |
| ğŸ”„ Upsert | [`upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert), [`bulk_upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert) | Insert or update existing records |
| ğŸ“ CRUD | [`get_by_id`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id), [`update_record`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record), [`delete_record`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record), [`bulk_delete`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete) | Standard database operations |
| ğŸ”§ Utilities | [`with_transaction`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction), [`paginate_sql`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql), [`batch_execute`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute) | Transaction management & helpers |
| ğŸ’° Money | [`to_cents`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents), [`from_cents`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents) | Currency conversion for `int`-only storage |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SQL Utilities Layer                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” Query Registry        â”‚  Execute queries by ID              â”‚
â”‚  â• Insert Operations     â”‚  insert_only, bulk_insert_only      â”‚
â”‚  ğŸ”„ Upsert Operations     â”‚  upsert, bulk_upsert                â”‚
â”‚  ğŸ“ CRUD Operations       â”‚  get, update, delete (single/bulk)  â”‚
â”‚  ğŸ”§ Utilities             â”‚  transactions, pagination, batching â”‚
â”‚  ğŸ’° Money Helpers         â”‚  cents â†” dollars conversion         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DB_TYPE Detection: PostgreSQL / SQLite (auto-switch syntax)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              fastsql Database Connection                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Quick Reference

### Conflict Handling

| Operation | On Conflict | Use Case |
|-----------|-------------|----------|
| [`insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only) | **Skip** (DO NOTHING) | Append-only logs, idempotent imports |
| [`upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert) | **Update** existing | Sync external data, refresh caches |

### Performance Tips

| Scenario | Recommended | Why |
|----------|-------------|-----|
| Single record | [`insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only), [`upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert) | Simple, immediate |
| 10+ records | `bulk_*` variants | 10-100x faster |
| 100+ records | [`batch_execute`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute) | Commits per batch, memory-safe |
| Multi-table changes | [`with_transaction`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction) | All-or-nothing commits |

---

## ğŸ” Database Type Detection

Automatically detects PostgreSQL vs SQLite from `DB_TYPE` environment variable to generate appropriate SQL syntax.

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L24){target="_blank" style="float:right; font-size:smaller"}

### get_db_type

>      get_db_type ()

*Get database type from environment variable*


---

## ğŸ¯ Query Registry

Execute queries by ID from a centralized registry with automatic parameter validation.

| Function | Purpose |
|----------|--------|
| [`run_id`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id) | Execute a registered query by its ID |
| [`validate_params`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params) | Ensure all `:param` placeholders have values |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L42){target="_blank" style="float:right; font-size:smaller"}

### run_id

>      run_id (db:fastsql.core.Database, registry:Dict[str,str], query_id:str,
>              params:Optional[Dict[str,Any]]=None)

*Execute a query by ID from a query registry.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L33){target="_blank" style="float:right; font-size:smaller"}

### validate_params

>      validate_params (sql:str, params:Dict[str,Any])

*Validate that all required parameters are provided*


---

## â• Insert-Only

Insert new records **only if they don't exist** â€” conflicts are silently skipped.

| Function | Records | SQL Generated |
|----------|---------|---------------|
| [`insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only) | Single | `ON CONFLICT DO NOTHING` (PG) / `INSERT OR IGNORE` (SQLite) |
| [`bulk_insert_only`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only) | Multiple | Same, with batch execution |

> ğŸ’¡ **Use case**: Idempotent imports, append-only audit logs, webhook deduplication

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L95){target="_blank" style="float:right; font-size:smaller"}

### bulk_insert_only

>      bulk_insert_only (db:fastsql.core.Database, table_name:str,
>                        records:List[Dict[str,Any]], conflict_cols:List[str],
>                        auto_commit:bool=True)

*Insert multiple records, skipping conflicts (optimized batch operation).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L64){target="_blank" style="float:right; font-size:smaller"}

### insert_only

>      insert_only (db:fastsql.core.Database, table_name:str,
>                   record:Dict[str,Any], conflict_cols:List[str],
>                   auto_commit:bool=True)

*Insert a single record only if it doesn't exist (ignores conflicts).*


---

## ğŸ”„ Upsert

Insert new records **or update existing ones** on conflict.

| Function | Records | SQL Generated |
|----------|---------|---------------|
| [`upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert) | Single | `ON CONFLICT DO UPDATE` (PG) / `INSERT OR REPLACE` (SQLite) |
| [`bulk_upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert) | Multiple | Same, with batch execution |

> ğŸ’¡ **Use case**: Syncing external API data, refreshing caches, user settings

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L166){target="_blank" style="float:right; font-size:smaller"}

### bulk_upsert

>      bulk_upsert (db:fastsql.core.Database, table_name:str,
>                   records:List[Dict[str,Any]], conflict_cols:List[str],
>                   update_cols:Optional[List[str]]=None, auto_commit:bool=True)

*Insert or update multiple records (optimized batch operation).*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L129){target="_blank" style="float:right; font-size:smaller"}

### upsert

>      upsert (db:fastsql.core.Database, table_name:str, record:Dict[str,Any],
>              conflict_cols:List[str], update_cols:Optional[List[str]]=None,
>              auto_commit:bool=True)

*Insert a record or update if it exists (upsert).*


---

## ğŸ“ CRUD

Standard Create, Read, Update, Delete operations.

| Function | Operation | Description |
|----------|-----------|-------------|
| [`get_by_id`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id) | **Read** | Fetch single record by primary key |
| [`update_record`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record) | **Update** | Modify record fields by ID |
| [`delete_record`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record) | **Delete** | Remove single record by ID |
| [`bulk_delete`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete) | **Delete** | Remove multiple records by ID list |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L251){target="_blank" style="float:right; font-size:smaller"}

### bulk_delete

>      bulk_delete (db:fastsql.core.Database, table_name:str, id_list:List[Any],
>                   id_col:str='id', auto_commit:bool=True)

*Delete multiple records by ID list.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L237){target="_blank" style="float:right; font-size:smaller"}

### delete_record

>      delete_record (db:fastsql.core.Database, table_name:str, id_value:Any,
>                     id_col:str='id', auto_commit:bool=True)

*Delete a single record by ID.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L216){target="_blank" style="float:right; font-size:smaller"}

### update_record

>      update_record (db:fastsql.core.Database, table_name:str, id_value:Any,
>                     id_col:str='id', auto_commit:bool=True, **updates)

*Update a single record by ID.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L206){target="_blank" style="float:right; font-size:smaller"}

### get_by_id

>      get_by_id (db:fastsql.core.Database, table_name:str, id_value:Any,
>                 id_col:str='id')

*Get a single record by ID.*


---

## ğŸ”§ Utilities

Transaction management, pagination, and batch processing.

| Function | Purpose |
|----------|--------|
| [`with_transaction`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction) | Context manager for atomic operations |
| [`paginate_sql`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql) | Add LIMIT/OFFSET to queries |
| [`batch_execute`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute) | Process large lists in memory-safe chunks |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L289){target="_blank" style="float:right; font-size:smaller"}

### batch_execute

>      batch_execute (db:fastsql.core.Database, operation_func, items:List[Any],
>                     batch_size:int=100)

*Execute an operation on items in batches with commits after each batch.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L284){target="_blank" style="float:right; font-size:smaller"}

### paginate_sql

>      paginate_sql (sql:str, page:int, page_size:int)

*Add LIMIT/OFFSET pagination to a SQL query.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L275){target="_blank" style="float:right; font-size:smaller"}

### with_transaction

>      with_transaction (db:fastsql.core.Database)

*Context manager for safe transaction handling with auto-rollback on error.*


---

## ğŸ’° Money Helpers

Convert between dollar amounts and integer cents for database storage.

> âš ï¸ **Why cents?** fastsql only supports `int` and `str` types â€” storing money as cents avoids floating-point precision issues.

| Function | Direction | Example |
|----------|-----------|--------|
| [`to_cents`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents) | `"$150.00"` â†’ `15000` | Store in DB |
| [`from_cents`](https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents) | `15000` â†’ `"$150.00"` | Display to user |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L303){target="_blank" style="float:right; font-size:smaller"}

### to_cents

>      to_cents (dollars:str|float|None)

*Convert dollar amount to integer cents for database storage.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L313){target="_blank" style="float:right; font-size:smaller"}

### from_cents

>      from_cents (cents:int|None)

*Convert integer cents to formatted dollar string for display.*




========================================

FILE: _proc/03_utils_bgtsk.html.md

---
description: Lightweight background task execution for tenant-level operations with
  retry logic and status tracking.
output-file: utils_bgtsk.html
title: "\u26A1 Background Tasks"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Category | Components | Purpose |
|----------|------------|--------|
| ğŸ“¦ Model | [`TenantJob`](https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#tenantjob) | Tenant-level job record with retry support |
| âš¡ Manager | [`BackgroundTaskManager`](https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#backgroundtaskmanager) | Submit, execute, and track background tasks |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastHTML Route                               â”‚
â”‚  return response, bg_task  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                    â”‚
                              â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BackgroundTaskManager                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  submit()           â†’ Create job + return BackgroundTask        â”‚
â”‚  _execute_with_retry() â†’ Run with auto-retry on failure         â”‚
â”‚  get_job()          â†’ Check job status                          â”‚
â”‚  list_jobs()        â†’ Query jobs by type/status                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Retry Logic: 2^n seconds backoff (2s, 4s, 8s)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tenant Database                              â”‚
â”‚                    â””â”€â”€ tenant_jobs table                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Quick Reference

### Job Status Flow

```
pending â†’ running â†’ completed
    â†‘        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ failed (after max retries)
```

### Usage Pattern

```python
# In your FastHTML route
manager = BackgroundTaskManager(tenant_db)
job_id, bg_task = manager.submit("sync_data", my_sync_func, user_id="123")
return response, bg_task  # Starlette runs bg_task after response
```

---

## ğŸ“¦ TenantJob Model

Tracks background jobs at the tenant level with retry support.

| Field | Type | Description |
|-------|------|-------------|
| `id` | str | Unique job identifier |
| `job_type` | str | Job category (e.g., "sync", "email") |
| `status` | str | `pending` / `running` / `completed` / `failed` |
| `payload` | str | JSON kwargs passed to task function |
| `result` | str | JSON result on completion |
| `error_log` | str | Stack trace on failure |
| `retry_count` | int | Current retry attempt |
| `max_retries` | int | Max attempts before marking failed |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L26){target="_blank" style="float:right; font-size:smaller"}

### TenantJob

>      TenantJob ()

*Tenant-level background job with retry support.*


---

## âš¡ BackgroundTaskManager

Submit and track background tasks with automatic retry logic.

| Method | Purpose |
|--------|--------|
| `submit` | Create job and return BackgroundTask for Starlette |
| `get_job` | Get job status and details by ID |
| `list_jobs` | Query jobs with optional type/status filters |

> ğŸ’¡ **Use case**: Long-running operations like syncing data, sending emails, or processing uploads

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L41){target="_blank" style="float:right; font-size:smaller"}

### BackgroundTaskManager

>      BackgroundTaskManager (db:fastsql.core.Database)

*Lightweight background task manager for tenant-level operations.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L103){target="_blank" style="float:right; font-size:smaller"}

### BackgroundTaskManager.list_jobs

>      BackgroundTaskManager.list_jobs (job_type:Optional[str]=None,
>                                       status:Optional[str]=None,
>                                       limit:int=100)

*List jobs with optional filtering.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L99){target="_blank" style="float:right; font-size:smaller"}

### BackgroundTaskManager.get_job

>      BackgroundTaskManager.get_job (job_id:str)

*Get job status and details.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L49){target="_blank" style="float:right; font-size:smaller"}

### BackgroundTaskManager.submit

>      BackgroundTaskManager.submit (job_type:str, task_func:Callable,
>                                    max_retries:int=3, **task_kwargs)

*Submit a new background task for execution.*




========================================

FILE: _proc/09_utils_polars_mapper.html.md

---
description: High-performance JSON-to-database pipeline using Polars vectorized transformations.
output-file: utils_polars_mapper.html
title: "\U0001F43B\u200D\u2744\uFE0F Data Transforms"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`map_and_upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert) | Bulk JSONâ†’DB upsert via staging table |
| [`apply_schema`](https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#apply_schema) | Type conversions (dates, booleans, numbers) |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Staging Table Pattern                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. df.write_database(staging_table) â†’ fast bulk INSERT        â”‚
â”‚  2. INSERT ... ON CONFLICT SELECT FROM staging â†’ vectorized    â”‚
â”‚  3. DROP TABLE staging â†’ cleanup                                â”‚
â”‚                                                                 â”‚
â”‚  âš¡ 10-100x faster than row-by-row upserts                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¥ Map & Upsert

| Parameter | Description |
|-----------|-------------|
| `df` | Polars DataFrame from JSON |
| `table_name` | Target database table (must exist) |
| `key_col` | Primary key for ON CONFLICT resolution |
| `db_uri` | Database connection string |
| `column_map` | Optional rename map `{json_col: db_col}` |
| `unnest_cols` | Optional list of nested columns to flatten |

**Staging Table Pattern (10-100x faster than row-by-row):**
1. Write to temporary staging table (fast bulk insert)
2. Execute `INSERT ... ON CONFLICT` (database-native, vectorized)
3. Drop staging table (cleanup)

**Example:**

```python
import polars as pl

# JSON from API
json_data = [
    {'user_id_val': 1, 'ABC_1': 'Alice', 'extra': 'ignore'},
    {'user_id_val': 2, 'ABC_1': 'Bob', 'extra': 'ignore'}
]

df = pl.DataFrame(json_data)

map_and_upsert(
    df=df,
    table_name='users',
    key_col='user_id',
    db_uri='sqlite:///app.db',
    column_map={'user_id_val': 'user_id', 'ABC_1': 'name'}
)
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L21){target="_blank" style="float:right; font-size:smaller"}

### map_and_upsert

>      map_and_upsert (df:polars.dataframe.frame.DataFrame, table_name:str,
>                      key_col:str, db_uri:str, column_map:dict=None,
>                      unnest_cols:list[str]=None)

*Map JSON data to database columns and upsert using staging table pattern.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| df | DataFrame |  | The raw Polars DataFrame from JSON |
| table_name | str |  | Target database table name |
| key_col | str |  | Primary key column for conflict resolution |
| db_uri | str |  | SQLAlchemy connection string (e.g., 'sqlite:///db.db' or 'postgresql://...') |
| column_map | dict | None | Optional rename map {json_key: db_col} |
| unnest_cols | list | None | List of Struct columns to flatten |


## ğŸ”§ Schema Transformations

| Parameter | Description |
|-----------|-------------|
| `df` | Polars DataFrame |
| `type_map` | Dict mapping column names to Polars dtypes |

**Supported conversions:**

| Type | Handling |
|------|----------|
| `pl.Date` | Parses `YYYY-MM-DD` strings |
| `pl.Datetime` | Parses datetime strings |
| `pl.Boolean` | Converts `"true"`/`"false"` strings |
| Other | Uses `cast()` (works for numeric types) |

**Example:**

```python
df = pl.DataFrame({
    'created_at': ['2024-01-15', '2024-01-16'],
    'is_active': ['true', 'false'],
    'amount': ['123.45', '678.90']
})

df = apply_schema(df, {
    'created_at': pl.Date,
    'is_active': pl.Boolean,
    'amount': pl.Float64
})
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L104){target="_blank" style="float:right; font-size:smaller"}

### apply_schema

>      apply_schema (df:polars.dataframe.frame.DataFrame, type_map:dict)

*Apply explicit type conversions to DataFrame columns.*

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| df | DataFrame | Input DataFrame |
| type_map | dict | Column name -> Polars dtype (e.g., {'created_at': pl.Date, 'is_active': pl.Boolean}) |
| **Returns** | **DataFrame** |  |




========================================

FILE: _proc/10_utils_sync.html.md

---
description: "End-to-end data sync pipeline: GraphQL API \u2192 Polars \u2192 Database."
output-file: utils_sync.html
title: "\U0001F504 API \u2192 DB Sync"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`sync_external_data`](https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_external_data) | Full sync: API â†’ Transform â†’ DB |
| [`sync_incremental`](https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_incremental) | Incremental sync since timestamp |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    End-to-End Sync Pipeline                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GraphQL API â”€â”€â–¶ Streaming Pages â”€â”€â–¶ Polars Transform â”€â”€â–¶ DB  â”‚
â”‚       â”‚                â”‚                    â”‚                   â”‚
â”‚  fetch_pages      yield batch         map_and_upsert           â”‚
â”‚  generator        (memory safe)        (staging pattern)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Full Sync

| Parameter | Description |
|-----------|-------------|
| `client` | GraphQL client instance |
| `query_template` | GraphQL query with pagination |
| `variables` | Query variables |
| `items_path` | JSONPath to data items |
| `cursor_path` | JSONPath to cursor |
| `table_name` | Target table name |
| `key_col` | Primary key column |
| `db_uri` | Database connection string |
| `column_map` | Optional column renaming |
| `type_map` | Optional type conversions |
| `has_next_path` | Optional hasNextPage path |

**Returns:** `{'total_records': 10000, 'batches': 10}`

**Example:**

```python
from fh_saas.utils_api import AsyncAPIClient, bearer_token_auth
from fh_saas.utils_graphql import GraphQLClient
import polars as pl

async with AsyncAPIClient(
    'https://api.example.com/graphql',
    auth_headers=bearer_token_auth('TOKEN')
) as api_client:
    
    client = GraphQLClient(api_client)
    
    stats = await sync_external_data(
        client=client,
        query_template='''
            query($cursor: String) {
                users(after: $cursor, first: 1000) {
                    nodes { user_id_val name_str email_addr }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        variables={'cursor': None},
        items_path=['data', 'users', 'nodes'],
        cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
        has_next_path=['data', 'users', 'pageInfo', 'hasNextPage'],
        table_name='users',
        key_col='user_id',
        db_uri='sqlite:///app.db',
        column_map={
            'user_id_val': 'user_id',
            'name_str': 'name',
            'email_addr': 'email'
        },
        type_map={'user_id': pl.Int64}
    )
    
    print(f"Synced {stats['total_records']} records")
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sync.py#L20){target="_blank" style="float:right; font-size:smaller"}

### sync_external_data

>      sync_external_data (client:fh_saas.utils_graphql.GraphQLClient,
>                          query_template:str, variables:dict,
>                          items_path:list[str], cursor_path:list[str],
>                          table_name:str, key_col:str, db_uri:str,
>                          column_map:dict=None, type_map:dict=None,
>                          has_next_path:list[str]=None, batch_size:int=5000)

*Sync external data from GraphQL API to database (streaming, memory-efficient).*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| client | GraphQLClient |  | Initialized GraphQL client |
| query_template | str |  | GraphQL query with $cursor variable |
| variables | dict |  | Initial variables (e.g., {'cursor': None}) |
| items_path | list |  | Path to data list in response |
| cursor_path | list |  | Path to next cursor |
| table_name | str |  | Target database table |
| key_col | str |  | Primary key for upsert |
| db_uri | str |  | Database connection string |
| column_map | dict | None | Optional column renaming |
| type_map | dict | None | Optional type conversions |
| has_next_path | list | None | Optional hasNextPage path |
| batch_size | int | 5000 | Max rows per batch (pagination page size) |
| **Returns** | **Dict** |  |  |


## â±ï¸ Incremental Sync

Syncs only records updated after `last_sync_time`.

| Parameter | Description |
|-----------|-------------|
| `last_sync_time` | ISO timestamp (e.g., `'2024-01-15T10:00:00Z'`) |
| *(others)* | Same as [`sync_external_data`](https://abhisheksreesaila.github.io/fh-saas/utils_sync.html#sync_external_data) |

**Returns:** `{'total_records': 100, 'batches': 2, 'last_sync_time': '2024-01-16T10:00:00Z'}`

**Example:**

```python
# Query with $last_sync filter
query = '''
    query($cursor: String, $last_sync: DateTime!) {
        users(after: $cursor, where: {updated_at: {_gt: $last_sync}}) {
            nodes { id name updated_at }
            pageInfo { hasNextPage endCursor }
        }
    }
'''

stats = await sync_incremental(
    client=client,
    query_template=query,
    last_sync_time='2024-01-15T10:00:00Z',
    items_path=['data', 'users', 'nodes'],
    cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
    table_name='users',
    key_col='id',
    db_uri='sqlite:///app.db'
)
```

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sync.py#L75){target="_blank" style="float:right; font-size:smaller"}

### sync_incremental

>      sync_incremental (client:fh_saas.utils_graphql.GraphQLClient,
>                        query_template:str, last_sync_time:str,
>                        items_path:list[str], cursor_path:list[str],
>                        table_name:str, key_col:str, db_uri:str,
>                        column_map:dict=None, type_map:dict=None,
>                        has_next_path:list[str]=None)

*Incremental sync: fetch only records updated after last sync timestamp.*

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| client | GraphQLClient |  | Initialized GraphQL client |
| query_template | str |  | GraphQL query with $cursor and $last_sync variables |
| last_sync_time | str |  | ISO timestamp (e.g., '2024-01-15T10:00:00Z') |
| items_path | list |  | Path to data list |
| cursor_path | list |  | Path to cursor |
| table_name | str |  | Target table |
| key_col | str |  | Primary key |
| db_uri | str |  | Database connection |
| column_map | dict | None | Optional column map |
| type_map | dict | None | Optional type map |
| has_next_path | list | None | Optional hasNextPage path |
| **Returns** | **Dict** |  |  |




========================================

FILE: _proc/05_utils_email.html.md

---
description: Send emails via SMTP using markdown templates with markdown_merge.
output-file: utils_email.html
title: "\U0001F4E7 Email Sending"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Category | Functions | Purpose |
|----------|-----------|---------|
| âš™ï¸ Config | [`get_smtp_config`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config) | Load SMTP settings from env |
| ğŸ“ Templates | [`get_template_path`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path), [`load_template`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template) | Manage markdown templates |
| âœ‰ï¸ Sending | [`send_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email), [`send_batch_emails`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails) | Core send functions |
| ğŸ Convenience | [`send_welcome_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email), [`send_invitation_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email), [`send_password_reset_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email) | Pre-built templates |

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Email Sending Flow                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Load SMTP config from environment variables                 â”‚
â”‚  2. Load markdown template from templates/ directory            â”‚
â”‚  3. Substitute template variables (user_name, etc.)             â”‚
â”‚  4. Convert markdown to HTML via markdown_merge                 â”‚
â”‚  5. Send via SMTP (Azure, SendGrid, AWS SES, etc.)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `SMTP_HOST` | âœ… | - | SMTP server hostname |
| `SMTP_PORT` | âŒ | 587 | SMTP server port |
| `SMTP_USER` | âœ… | - | Auth username |
| `SMTP_PASSWORD` | âœ… | - | Auth password |
| `SMTP_MAIL_FROM` | âœ… | - | Sender email |
| `SMTP_STARTTLS` | âŒ | True | Use STARTTLS |
| `SMTP_SSL` | âŒ | False | Use SSL (disables TLS) |

## âš™ï¸ SMTP Configuration

| Function | Purpose |
|----------|---------|
| [`get_smtp_config`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config) | Load SMTP config from environment vars |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L20){target="_blank" style="float:right; font-size:smaller"}

### get_smtp_config

>      get_smtp_config ()

*Load SMTP configuration from environment variables.*


## ğŸ“ Template Management

| Function | Purpose |
|----------|---------|
| [`get_template_path`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path) | Resolve path to template file |
| [`load_template`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template) | Read template content as string |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L70){target="_blank" style="float:right; font-size:smaller"}

### load_template

>      load_template (template_name:str)

*Load markdown email template as string.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L58){target="_blank" style="float:right; font-size:smaller"}

### get_template_path

>      get_template_path (template_name:str)

*Get absolute path to email template file.*


## âœ‰ï¸ Email Sending

| Function | Purpose |
|----------|---------|
| [`send_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email) | Send single email with template |
| [`send_batch_emails`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails) | Send to multiple recipients |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L76){target="_blank" style="float:right; font-size:smaller"}

### send_email

>      send_email (to_email:str, to_name:str, subject:str, template_name:str,
>                  template_vars:Dict[str,str], test:bool=False,
>                  smtp_config:Optional[Dict[str,Any]]=None)

*Send single email using markdown template with variable substitution.*


## ğŸ“¦ Batch Sending

| Function | Purpose |
|----------|---------|
| [`send_batch_emails`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails) | Send personalized emails to multiple recipients |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L154){target="_blank" style="float:right; font-size:smaller"}

### send_batch_emails

>      send_batch_emails (recipients:List[Dict[str,str]], subject:str,
>                         template_name:str,
>                         template_vars_list:List[Dict[str,str]],
>                         test:bool=False, pause:float=0.2,
>                         smtp_config:Optional[Dict[str,Any]]=None)

*Send personalized emails to multiple recipients with per-recipient variables.*


## ğŸ Convenience Functions

Pre-built functions for common email types:

| Function | Template | Purpose |
|----------|----------|---------|
| [`send_welcome_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email) | `welcome.md` | New user onboarding |
| [`send_invitation_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email) | `invitation.md` | Invite to tenant |
| [`send_password_reset_email`](https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email) | `password_reset.md` | Password recovery |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L237){target="_blank" style="float:right; font-size:smaller"}

### send_welcome_email

>      send_welcome_email (to_email:str, to_name:str, user_name:str,
>                          tenant_name:str, dashboard_url:str, test:bool=False)

*Send welcome email to new user with tenant dashboard link.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L261){target="_blank" style="float:right; font-size:smaller"}

### send_invitation_email

>      send_invitation_email (to_email:str, to_name:str, inviter_name:str,
>                             tenant_name:str, invitation_url:str,
>                             test:bool=False)

*Send invitation email with link to join tenant.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L285){target="_blank" style="float:right; font-size:smaller"}

### send_password_reset_email

>      send_password_reset_email (to_email:str, to_name:str, user_name:str,
>                                 reset_url:str, test:bool=False)

*Send password reset email with secure reset link.*





========================================

FILE: _proc/11_utils_blog.html.md

---
description: Load markdown posts with frontmatter and render to SEO-friendly HTML.
output-file: utils_blog.html
title: "\U0001F4DD Blog Publishing"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Class | Purpose |
|-------|---------|
| [`PostLoader`](https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#postloader) | Load markdown posts from filesystem |
| [`MarkdownEngine`](https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#markdownengine) | Render markdown to SEO-friendly HTML |

## ğŸ“‚ PostLoader

| Method | Purpose |
|--------|---------|
| `.load_posts()` | Load all posts sorted by date |
| `.get_post()` | Get single post by slug |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L34){target="_blank" style="float:right; font-size:smaller"}

### PostLoader

>      PostLoader (posts_dir:str)

*Load and parse markdown blog posts from filesystem*

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| posts_dir | str | Directory containing .md files |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L41){target="_blank" style="float:right; font-size:smaller"}

### PostLoader.load_posts

>      PostLoader.load_posts ()

*Load all markdown posts from directory.*

Returns list of post dicts sorted by date (newest first).
Each post contains: title, date, slug, body, categories, author, series.

Example:
    ```python
    loader = PostLoader('blog/posts')
    posts = loader.load_posts()

    for post in posts:
        print(f"{post['title']} - {post['slug']}")
    ```


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L81){target="_blank" style="float:right; font-size:smaller"}

### PostLoader.get_post

>      PostLoader.get_post (slug:str)

*Get single post by slug.*

Example:
    ```python
    post = loader.get_post('bg0010')
    if post:
        print(post['title'])
    ```

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| slug | str |  |
| **Returns** | **Optional** | **URL slug (e.g., 'my-post')** |


## ğŸ¨ MarkdownEngine

| Method | Purpose |
|--------|---------|
| `.render()` | Convert markdown to HTML |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L96){target="_blank" style="float:right; font-size:smaller"}

### MarkdownEngine

>      MarkdownEngine ()

*Render markdown to HTML with SEO extensions*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L117){target="_blank" style="float:right; font-size:smaller"}

### MarkdownEngine.render

>      MarkdownEngine.render (content:str)

*Convert markdown to HTML.*

        Returns HTML string with proper semantic tags for SEO.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Hello

This is **bold**.')
            print(html)  # <h1>Hello</h1><p>This is <strong>bold</strong>.</p>
            ```

|    | **Type** | **Details** |
| -- | -------- | ----------- |
| content | str |  |
| **Returns** | **str** | **Markdown content** |


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L133){target="_blank" style="float:right; font-size:smaller"}

### MarkdownEngine.get_toc

>      MarkdownEngine.get_toc ()

*Get table of contents HTML from last render.*

        Must call render() first. Returns empty string if no headings.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Title
## Section 1
## Section 2')
            toc = engine.get_toc()
            print(toc)  # <ul><li><a href="#section-1">Section 1</a>...</li></ul>
            ```


## FastHTML Integration Example

Basic pattern for server-side rendering with FastHTML:

```python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog')
def blog_index():
    posts = loader.load_posts()
    return Titled('Blog',
        *[Article(
            H2(A(p['title'], href=f"/blog/{p['slug']}")),
            P(p['description']),
            Small(p['date'].strftime('%Y-%m-%d') if p['date'] else '')
        ) for p in posts]
    )

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    html_content = engine.render(post['body'])
    toc = engine.get_toc()
    
    return Titled(post['title'],
        Article(
            NotStr(toc),  # Table of contents
            NotStr(html_content)  # Rendered markdown
        )
    )
```



========================================

FILE: _proc/12_utils_seo.html.md

---
description: Generate meta tags, sitemaps, and structured data for search engines.
output-file: utils_seo.html
title: "\U0001F50D SEO & Sitemaps"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Function | Purpose |
|----------|---------|
| [`generate_head_tags`](https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags) | Meta tags for social sharing |
| [`generate_sitemap_xml`](https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml) | XML sitemap for crawlers |
| `generate_json_ld` | Structured data (Article schema) |

## ğŸ·ï¸ Meta Tags

| Function | Purpose |
|----------|---------|
| [`generate_head_tags`](https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags) | OpenGraph, Twitter Card, canonical |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L16){target="_blank" style="float:right; font-size:smaller"}

### generate_head_tags

>      generate_head_tags (title:str, description:str, url:str,
>                          image_url:Optional[str]=None,
>                          article_published:Optional[datetime.datetime]=None,
>                          article_modified:Optional[datetime.datetime]=None,
>                          author:Optional[str]=None)

*Generate meta tags for SEO.*

Returns list of (tag_name, attributes_dict) tuples for FastHTML components.
Includes standard, OpenGraph, and Twitter Card tags.

Example:
    ```python
    from fasthtml.common import *

    tags = generate_head_tags(
        title='My Blog Post',
        description='Learn about Python',
        url='https://example.com/blog/my-post',
        image_url='https://example.com/image.jpg'
    )

    # Use in FastHTML app
    @app.get('/blog/my-post')
    def post():
        return Html(
            Head(
                *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
                  for tag, attrs in tags]
            ),
            Body('...')
        )
    ```

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| title | str |  | Page title |
| description | str |  | Page description (150-160 chars optimal) |
| url | str |  | Canonical URL |
| image_url | Optional | None | OpenGraph image URL |
| article_published | Optional | None | Publication date |
| article_modified | Optional | None | Last modified date |
| author | Optional | None | Author name |
| **Returns** | **List** |  |  |


## ğŸ—ºï¸ Sitemap

| Function | Purpose |
|----------|---------|
| [`generate_sitemap_xml`](https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml) | XML sitemap for search crawlers |

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L103){target="_blank" style="float:right; font-size:smaller"}

### generate_sitemap_xml

>      generate_sitemap_xml (posts:List[Dict], base_url:str,
>                            blog_path:str='/blog')

*Generate XML sitemap for blog posts.*

Returns sitemap XML string with proper structure and lastmod dates.

Example:
    ```python
    from fasthtml.common import *
    from fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/sitemap.xml')
    def sitemap():
        posts = loader.load_posts()
        xml = generate_sitemap_xml(
            posts=posts,
            base_url='https://example.com',
            blog_path='/blog'
        )
        return Response(xml, media_type='application/xml')
    ```

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| posts | List |  | List of posts from PostLoader |
| base_url | str |  | Base URL (e.g., 'https://example.com') |
| blog_path | str | /blog | Blog path prefix |
| **Returns** | **str** |  |  |


## rss feed generator

Generate RSS 2.0 feed for blog subscribers.

---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L162){target="_blank" style="float:right; font-size:smaller"}

### generate_rss_xml

>      generate_rss_xml (posts:List[Dict], blog_title:str, blog_description:str,
>                        base_url:str, blog_path:str='/blog')

*Generate RSS 2.0 feed for blog posts.*

Returns RSS XML string for feed readers (Feedly, etc.).

Example:
    ```python
    from fasthtml.common import *
    from fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/rss.xml')
    def rss():
        posts = loader.load_posts()[:20]  # Latest 20 posts
        xml = generate_rss_xml(
            posts=posts,
            blog_title='My Blog',
            blog_description='Tech tutorials and insights',
            base_url='https://example.com'
        )
        return Response(xml, media_type='application/xml')
    ```

|    | **Type** | **Default** | **Details** |
| -- | -------- | ----------- | ----------- |
| posts | List |  | List of posts from PostLoader |
| blog_title | str |  | Blog title |
| blog_description | str |  | Blog description |
| base_url | str |  | Base URL |
| blog_path | str | /blog | Blog path prefix |
| **Returns** | **str** |  |  |


## FastHTML Integration Example

Complete SEO setup with FastHTML:

```python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine
from fh_saas.utils_seo import generate_head_tags, generate_sitemap_xml, generate_rss_xml

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    # Generate SEO tags
    tags = generate_head_tags(
        title=post['title'],
        description=post['description'] or post['body'][:160],
        url=f"https://example.com/blog/{slug}",
        image_url=post.get('image'),
        article_published=post['date'],
        author=post.get('author')
    )
    
    # Render markdown
    html_content = engine.render(post['body'])
    
    return Html(
        Head(
            Title(post['title']),
            *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
              for tag, attrs in tags]
        ),
        Body(
            Article(NotStr(html_content))
        )
    )

@app.get('/sitemap.xml')
def sitemap():
    posts = loader.load_posts()
    xml = generate_sitemap_xml(posts, 'https://example.com')
    return Response(xml, media_type='application/xml')

@app.get('/rss.xml')
def rss():
    posts = loader.load_posts()[:20]
    xml = generate_rss_xml(
        posts=posts,
        blog_title='My Blog',
        blog_description='Tech tutorials',
        base_url='https://example.com'
    )
    return Response(xml, media_type='application/xml')
```



========================================

FILE: _proc/13_utils_workflow.html.md

---
description: Minimal wrapper for executing callable sequences in order.
output-file: utils_workflow.html
title: "\U0001F527 Workflow Engine"

---


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

| Class | Purpose |
|-------|---------|
| [`Workflow`](https://abhisheksreesaila.github.io/fh-saas/utils_workflow.html#workflow) | Execute callable steps sequentially |

## ğŸ”§ Workflow Class

| Method | Purpose |
|--------|---------|
| `Workflow(steps)` | Initialize with list of callables |
| `.execute()` | Run all steps sequentially |

::: {#88658265 .cell}
``` {.python .cell-code}
from nbdev.showdoc import *
```
:::


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L13){target="_blank" style="float:right; font-size:smaller"}

### Workflow

>      Workflow (steps:List[Callable])

*Execute a list of callables sequentially. Minimal wrapper for code readability.*


---

[source](https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L20){target="_blank" style="float:right; font-size:smaller"}

### Workflow.execute

>      Workflow.execute ()

*Execute all steps in order*




========================================

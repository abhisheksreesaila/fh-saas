FILE: _proc/00_db_host.html.md

# ğŸ  Multi-Tenant Setup


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

The **Host Database** is the backbone of a multi-tenant architecture. It
answers the critical questions:

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 26%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <strong>Who is this person?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td>Identity &amp; authentication</td>
</tr>
<tr>
<td>ğŸ¢ <strong>Where is their data?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td>Database routing</td>
</tr>
<tr>
<td>ğŸ”‘ <strong>What can they access?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td>Access control</td>
</tr>
<tr>
<td>ğŸ’³ <strong>Are they paying?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td>Billing status</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>What happened?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td>Security audit trail</td>
</tr>
<tr>
<td>âš™ï¸ <strong>Background work?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td>Async operations</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚         ğŸ  HOST DATABASE            â”‚
                        â”‚  (Single source of truth)           â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚  ğŸ‘¤ GlobalUser    â†’ Identity        â”‚
                        â”‚  ğŸ¢ TenantCatalog â†’ DB Routing      â”‚
                        â”‚  ğŸ”‘ Membership    â†’ Access Control  â”‚
                        â”‚  ğŸ’³ Subscription  â†’ Billing         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ—„ï¸ Tenant A   â”‚   â”‚ ğŸ—„ï¸ Tenant B   â”‚   â”‚ ğŸ—„ï¸ Tenant C   â”‚
        â”‚   Database    â”‚   â”‚   Database    â”‚   â”‚   Database    â”‚
        â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** User authenticates once â†’ Host routes to correct
tenant â†’ Tenant data is isolated

## ğŸ› ï¸ Utilities

Helper functions used throughout the host database operations.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### gen_id

``` python

def gen_id(
    
):

```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### timestamp

``` python

def timestamp(
    
):

```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L23"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_db_uri

``` python

def get_db_uri(
    db
)->str:

```

*Extract SQLAlchemy connection URI from a Database object.*

Safely renders the URL with the actual password (required for utilities
like
[`map_and_upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert)
that create new connections).

**Why this is needed:** - `str(db.conn.engine.url)` masks the password
as `***` - This causes â€œpassword authentication failedâ€ errors -
`render_as_string(hide_password=False)` reveals the actual password

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db</code></td>
<td>fastsql/minidataapi Database object or HostDatabase instance</td>
</tr>
</tbody>
</table>

**Returns:** Full connection URI string with password

**Example:**

``` python
from fh_saas.db_host import get_db_uri, HostDatabase
from fh_saas.utils_polars_mapper import map_and_upsert

host_db = HostDatabase.from_env()
db_uri = get_db_uri(host_db.db)

# Now safe to use with map_and_upsert
map_and_upsert(df, 'my_table', 'id', db_uri)
```

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#timestamp"><code>timestamp()</code></a></td>
<td>ğŸ• Returns current UTC time in ISO format</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#gen_id"><code>gen_id()</code></a></td>
<td>ğŸ†” Generates a unique 32-character hex ID</td>
</tr>
<tr>
<td><code>get_db_uri(db)</code></td>
<td>ğŸ”— Extract full connection URI with password from Database
object</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ“¦ Core Models

These dataclasses define the host database schema. Each model maps to a
table with the `core_` or `sys_` prefix.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L116"
target="_blank" style="float:right; font-size:smaller">source</a>

### PricingPlan

``` python

def PricingPlan(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Pricing: Available subscription tiers with Stripe price IDs.*

Stores pricing configuration in database for admin-configurable tiers.
Each plan can have monthly and/or yearly billing intervals.

Attributes: id: Unique plan identifier (e.g., â€˜basicâ€™, â€˜proâ€™,
â€˜enterpriseâ€™) name: Display name for UI (e.g., â€˜Basic Planâ€™)
description: Plan description for pricing page stripe_price_monthly:
Stripe Price ID for monthly billing (price_xxx) stripe_price_yearly:
Stripe Price ID for yearly billing (price_xxx) amount_monthly: Monthly
price in cents (for display, e.g., 799 = $7.99) amount_yearly: Yearly
price in cents (for display, e.g., 7900 = $79.00) currency: ISO currency
code (default: â€˜usdâ€™) trial_days: Free trial period in days (default:
30) features: JSON array of feature keys enabled for this plan
tier_level: Numeric level for feature gating (higher = more access)
is_active: Whether plan is available for new subscriptions sort_order:
Display order on pricing page created_at: Record creation timestamp

Example: \>\>\> plan = PricingPlan( â€¦ id=â€˜proâ€™, â€¦ name=â€˜Pro Planâ€™, â€¦
stripe_price_monthly=â€˜price_1234â€™, â€¦ stripe_price_yearly=â€˜price_5678â€™, â€¦
amount_monthly=1999, â€¦ amount_yearly=19900, â€¦ tier_level=2, â€¦
features=â€˜\[â€œapi_accessâ€, â€œexportsâ€, â€œpriority_supportâ€\]â€™, â€¦ )

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L110"
target="_blank" style="float:right; font-size:smaller">source</a>

### SystemJob

``` python

def SystemJob(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Maintenance: Provisioning & Cleanups*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L104"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostAuditLog

``` python

def HostAuditLog(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Security: Who changed the system?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L92"
target="_blank" style="float:right; font-size:smaller">source</a>

### Subscription

``` python

def Subscription(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Billing: Are they allowed to use the app?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L86"
target="_blank" style="float:right; font-size:smaller">source</a>

### Membership

``` python

def Membership(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Router: Which tenants can they access?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantCatalog

``` python

def TenantCatalog(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Registry: Where is the database?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L75"
target="_blank" style="float:right; font-size:smaller">source</a>

### GlobalUser

``` python

def GlobalUser(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Identity: Who is this person?*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td><code>core_users</code></td>
<td><code>id</code></td>
<td>OAuth identity, email, optional password hash, Stripe customer
ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td><code>core_tenants</code></td>
<td><code>id</code></td>
<td>Maps tenant ID to database URL, tracks plan tier and status</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td><code>core_memberships</code></td>
<td><code>id</code></td>
<td>Links users to tenants with roles (<code>owner</code>,
<code>admin</code>, <code>member</code>)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td><code>core_subscriptions</code></td>
<td><code>id</code></td>
<td>Stripe subscription state for billing enforcement</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#pricingplan"><code>PricingPlan</code></a></td>
<td><code>core_pricing_plans</code></td>
<td><code>id</code></td>
<td>Available subscription tiers with Stripe price IDs</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td><code>sys_audit_logs</code></td>
<td><code>id</code></td>
<td>Immutable security log for compliance</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td><code>sys_jobs</code></td>
<td><code>id</code></td>
<td>Background task queue for provisioning, cleanup</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”Œ HostDatabase Singleton

The
[`HostDatabase`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase)
class provides a **singleton** connection manager for the host database.

âœ… **Why Singleton?** - Single connection pool shared across the
application - Consistent transaction management - Easy dependency
injection for testing

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Application Start                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  HostDatabase.from_env() â”‚  â† Reads DB_* env vars
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Creates tables if    â”‚
             â”‚   they don't exist     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Returns singleton     â”‚  â† Same instance everywhere
             â”‚  instance              â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L166"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase

``` python

def HostDatabase(
    db_url:str=None
):

```

*Singleton connection manager for the host database.*

### ğŸ”§ Methods

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from_env()</code></td>
<td>ğŸ­ Factory method - creates instance from environment variables</td>
</tr>
<tr>
<td><code>commit()</code></td>
<td>âœ… Commit the current database transaction</td>
</tr>
<tr>
<td><code>rollback()</code></td>
<td>â†©ï¸ï¸ Rollback the current transaction on error</td>
</tr>
<tr>
<td><code>reset_instance()</code></td>
<td>ğŸ§ª Reset singleton (testing only)</td>
</tr>
</tbody>
</table>

#### ğŸŒ Environment Variables for `from_env()`

<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_TYPE</code></td>
<td><code>POSTGRESQL</code></td>
<td>Database type (<code>POSTGRESQL</code> or <code>SQLITE</code>)</td>
</tr>
<tr>
<td><code>DB_USER</code></td>
<td><code>postgres</code></td>
<td>Database username</td>
</tr>
<tr>
<td><code>DB_PASS</code></td>
<td><em>(required)</em></td>
<td>Database password</td>
</tr>
<tr>
<td><code>DB_HOST</code></td>
<td><code>localhost</code></td>
<td>Database host</td>
</tr>
<tr>
<td><code>DB_PORT</code></td>
<td><code>5432</code></td>
<td>Database port</td>
</tr>
<tr>
<td><code>DB_NAME</code></td>
<td><code>app_host</code></td>
<td>Database name</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L205"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.from_env

``` python

def from_env(
    
):

```

*Create HostDatabase from DB\_* environment variables.\*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L224"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.commit

``` python

def commit(
    
):

```

*Commit current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L228"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.rollback

``` python

def rollback(
    
):

```

*Rollback current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L248"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.reset_instance

``` python

def reset_instance(
    
):

```

*Reset singleton instance (testing only).*

âš ï¸ Call close() first to release database connections!

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_host import HostDatabase, GlobalUser, gen_id, timestamp

# Initialize singleton from environment
host_db = HostDatabase.from_env()

# Create a user
user = GlobalUser(
    id=gen_id(),
    email="user@example.com",
    oauth_id="google_123",
    created_at=timestamp()
)
host_db.global_users.insert(user)
host_db.commit()

# Query users
all_users = host_db.global_users()
```

ğŸ’¡ **Tip:** The singleton ensures you always get the same connection, so
you can call
[`HostDatabase.from_env()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase.from_env)
anywhere in your app.


========================================

FILE: _proc/01_db_tenant.html.md

# ğŸ—„ï¸ Tenant Databases


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

Each tenant gets their own **isolated database** containing:

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td>Local user profiles linked to global identity</td>
</tr>
<tr>
<td>ğŸ” <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td>Fine-grained resource permissions</td>
</tr>
<tr>
<td>âš™ï¸ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td>Tenant-wide configuration</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      ğŸ  HOST DATABASE                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
    â”‚  â”‚ TenantCatalog â”‚ â”€â”€â–º Maps tenant_id â†’ database URL           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚  get_or_create_tenant_db(tenant_id)
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ğŸ—„ï¸ TENANT DATABASE                           â”‚
    â”‚                    (Isolated per tenant)                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ‘¤ TenantUser      â†’ Local profile (links to GlobalUser.id)   â”‚
    â”‚  ğŸ” TenantPermission â†’ Resource-level access control           â”‚
    â”‚  âš™ï¸ TenantSettings   â†’ Timezone, currency, feature flags       â”‚
    â”‚  ğŸª WebhookEvent     â†’ Idempotent webhook processing           â”‚
    â”‚  ğŸ”‘ WebhookSecret    â†’ HMAC secrets per webhook source         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ“Š [Your App Tables] â†’ Transactions, budgets, etc.            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** Tenant data is completely isolated â†’ No cross-tenant
data leakage possible

## ğŸ”Œ Tenant Connection

> âš ï¸ **Naming Convention**: Use **underscores** (not hyphens) in
> `tenant_id` values.
>
> Database names are derived from `tenant_id` (e.g., `tenant_acme_001` â†’
> `t_tenant_acme_001_db`). PostgreSQL and SQLite identifiers work best
> with alphanumeric characters and underscores.
>
> âœ… Good: `tenant_acme_001`, `tenant_finxplorer_prod` âŒ Avoid:
> `tenant-acme-001`, `tenant.finxplorer.prod`

``` python
from nbdev.showdoc import show_doc
```

[`get_or_create_tenant_db()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#get_or_create_tenant_db)
handles the full lifecycle:

1.  ğŸ” **Check** if tenant exists in host database
2.  ğŸ—„ï¸ **Create** physical database if new (PostgreSQL)
3.  ğŸ“ **Register** tenant in
    [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog)
4.  ğŸ”Œ **Return** connection to tenant database

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tenant_id</code></td>
<td>Unique tenant identifier (from <a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a>)</td>
</tr>
<tr>
<td><code>tenant_name</code></td>
<td>Optional display name (defaults to tenant_id)</td>
</tr>
</tbody>
</table>

**Returns:** `Database` connection to the tenantâ€™s isolated database

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_or_create_tenant_db

``` python

def get_or_create_tenant_db(
    tenant_id:str, tenant_name:str=None
):

```

*Get or create a tenant database connection by tenant ID.*

âš ï¸ IMPORTANT: Caller is responsible for closing the returned Database
connection by calling `db.conn.close()` and `db.engine.dispose()` when
done.

------------------------------------------------------------------------

## ğŸ“¦ Core Tenant Models

These models provide the infrastructure every tenant needs. Your
app-specific models (transactions, budgets, etc.) build on top of these.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantSettings

``` python

def TenantSettings(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Tenant-wide configuration and feature flags.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L113"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantPermission

``` python

def TenantPermission(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Fine-grained resource permission for a tenant user.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L104"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantUser

``` python

def TenantUser(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Local user profile linked to GlobalUser in host database.*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td><code>core_tenant_users</code></td>
<td><code>id</code></td>
<td>Links to <code>GlobalUser.id</code>, stores local role &amp;
preferences</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td><code>core_permissions</code></td>
<td><code>id</code></td>
<td>Resource + action permissions (RBAC)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td><code>core_settings</code></td>
<td><code>id</code></td>
<td>Timezone, currency, feature flags</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”§ Schema Initialization

[`init_tenant_core_schema()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#init_tenant_core_schema)
creates all infrastructure tables in a tenant database:

    tenant_db = get_or_create_tenant_db("tenant_abc")
    tables = init_tenant_core_schema(tenant_db)

    # Access tables via returned dict
    tables['tenant_users'].insert(user)
    tables['settings'].insert(settings)

**Returns:** Dictionary of table accessors for all core models

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L132"
target="_blank" style="float:right; font-size:smaller">source</a>

### init_tenant_core_schema

``` python

def init_tenant_core_schema(
    tenant_db:Database
):

```

*Create all core tenant tables and return table accessors.*

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_tenant import get_or_create_tenant_db, init_tenant_core_schema, TenantUser
from fh_saas.db_host import gen_id, timestamp

# Get or create tenant database
tenant_db = get_or_create_tenant_db("tenant_abc123", "Acme Corp")

# Initialize core schema
tables = init_tenant_core_schema(tenant_db)

# Add a tenant user (linked to GlobalUser.id)
user = TenantUser(
    id="global_user_xyz",  # Must match GlobalUser.id
    display_name="John Doe",
    local_role="admin",
    created_at=timestamp()
)
tables['tenant_users'].insert(user)
tenant_db.conn.commit()
```

ğŸ’¡ **Tip:** The `id` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
**must match** the `GlobalUser.id` from the host database to maintain
identity linking.

------------------------------------------------------------------------

## ğŸ” Role-Based Access Control (RBAC)

Every tenant has a **three-tier role system** for controlling access:

### Role Hierarchy

<table>
<thead>
<tr>
<th>Role</th>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin</code></td>
<td>3</td>
<td>Full access to all resources and settings</td>
</tr>
<tr>
<td><code>editor</code></td>
<td>2</td>
<td>Can view and modify data, but not settings</td>
</tr>
<tr>
<td><code>viewer</code></td>
<td>1</td>
<td>Read-only access to data</td>
</tr>
</tbody>
</table>

### Role Assignment Rules

1.  **Tenant owner** (from host `Membership.role='owner'`) â†’
    automatically gets `admin` role
2.  **Other users** â†’ assigned explicitly by admin via
    `TenantUser.local_role`
3.  **No defaults** â†’ admins must explicitly assign roles when inviting
    users

### TenantUser.local_role

The `local_role` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
stores the userâ€™s role within the tenant:

``` python
# Example: Admin adds a new user as editor
new_user = TenantUser(
    id=global_user_id,      # Must match GlobalUser.id
    display_name="Jane Doe",
    local_role="editor",    # Assigned by admin
    created_at=timestamp()
)
tables['tenant_users'].insert(new_user)
```

### Fine-Grained Permissions (Optional)

For advanced use cases, the `core_permissions` table allows
resource-level control:

``` python
# Example: Grant user edit access to transactions only
permission = TenantPermission(
    id=gen_id(),
    user_id=tenant_user.id,
    resource="transactions",
    action="edit",
    granted=True,
    created_at=timestamp()
)
tables['permissions'].insert(permission)
```

<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>resource</code></td>
<td>What the permission applies to (e.g., â€œtransactionsâ€,
â€œbudgetsâ€)</td>
</tr>
<tr>
<td><code>action</code></td>
<td>What action is allowed (e.g., â€œviewâ€, â€œeditâ€, â€œdeleteâ€)</td>
</tr>
<tr>
<td><code>granted</code></td>
<td>True = allowed, False = explicitly denied</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Tip:** Most apps only need the `local_role` field. Use
> `core_permissions` when you need per-resource control (e.g., â€œUser X
> can view transactions but not budgetsâ€).


========================================

FILE: _proc/15_utils_db.html.md

# ğŸ—„ï¸ Table Management


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table"><code>register_table</code></a></td>
<td>Create table from dataclass model</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables"><code>register_tables</code></a></td>
<td>Create multiple tables atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table"><code>drop_table</code></a></td>
<td>Drop table if exists</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index"><code>create_index</code></a></td>
<td>Create index with dialect-specific SQL</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index"><code>drop_index</code></a></td>
<td>Drop index if exists</td>
</tr>
<tr>
<td><code>list_tables</code></td>
<td>List all tables in database</td>
</tr>
<tr>
<td><code>list_indexes</code></td>
<td>List indexes for a table</td>
</tr>
</tbody>
</table>

## ğŸ“‹ Table Registration

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_table"><code>register_table</code></a></td>
<td>Create single table from dataclass</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#register_tables"><code>register_tables</code></a></td>
<td>Create multiple tables atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_table"><code>drop_table</code></a></td>
<td>Drop table if exists</td>
</tr>
</tbody>
</table>

**Example:**

``` python
class Transaction:
    id: str
    amount: float
    date: str
    category: str = None

tenant_db = get_or_create_tenant_db("tenant_123")
transactions = register_table(tenant_db, Transaction, "transactions")

# Use table object for CRUD
transactions.insert(Transaction(id="t1", amount=100.0, date="2024-01-01"))
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### register_table

``` python

def register_table(
    tenant_db:Database, model_class:Type, table_name:str, pk:str='id'
):

```

*Create a table from a dataclass model if it doesnâ€™t exist (atomic).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### register_tables

``` python

def register_tables(
    tenant_db:Database, models:List
)->Dict:

```

*Create multiple tables atomically (all succeed or all rollback).*

**Parameters:** - `models`: List of tuples
`[(ModelClass, table_name, pk), ...]`

**Returns:** Dict mapping table names to table objects
`{table_name: table_object}`

**Example:**

``` python
class Transaction:
    id: str; amount: float; date: str

class Connection:
    id: str; provider: str; status: str

tables = register_tables(tenant_db, [
    (Transaction, "transactions", "id"),
    (Connection, "connections", "id"),
])

tables["transactions"].insert(...)
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### drop_table

``` python

def drop_table(
    tenant_db:Database, table_name:str
)->None:

```

*Drop a table if it exists (atomic operation).*

## ğŸ“‡ Index Management

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index"><code>create_index</code></a></td>
<td>Create index with dialect-specific SQL</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_indexes"><code>create_indexes</code></a></td>
<td>Create multiple indexes atomically</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#drop_index"><code>drop_index</code></a></td>
<td>Drop index if exists</td>
</tr>
</tbody>
</table>

**Parameters for
[`create_index`](https://abhisheksreesaila.github.io/fh-saas/utils_db.html#create_index):**

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>table_name</code></td>
<td>Name of the table</td>
</tr>
<tr>
<td><code>columns</code></td>
<td>List of column names to index</td>
</tr>
<tr>
<td><code>unique</code></td>
<td>If True, creates UNIQUE index (default: False)</td>
</tr>
<tr>
<td><code>index_name</code></td>
<td>Custom name (auto-generates <code>idx_{table}_{cols}</code> if
None)</td>
</tr>
</tbody>
</table>

**Example:**

``` python
# Simple index
create_index(tenant_db, "transactions", ["date"])

# Composite unique index
create_index(tenant_db, "transactions", ["account_id", "external_id"], unique=True)

# Custom name
create_index(tenant_db, "transactions", ["category"], index_name="idx_txn_cat")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L61"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_index

``` python

def create_index(
    tenant_db:Database, table_name:str, columns:List, unique:bool=False, index_name:str=None
)->None:

```

*Create an index on a table if it doesnâ€™t exist (atomic operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L83"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_indexes

``` python

def create_indexes(
    tenant_db:Database, indexes:List
)->None:

```

*Create multiple indexes atomically (all succeed or all rollback).*

**Parameters:** - `indexes`: List of tuples
`[(table_name, columns, unique, index_name), ...]` - `index_name` can be
`None` for auto-generated names

**Example:**

``` python
create_indexes(tenant_db, [
    ("transactions", ["date"], False, None),
    ("transactions", ["account_id", "external_id"], True, "idx_txn_unique"),
    ("connections", ["provider"], False, None),
])
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L107"
target="_blank" style="float:right; font-size:smaller">source</a>

### drop_index

``` python

def drop_index(
    tenant_db:Database, index_name:str, table_name:str=None
)->None:

```

*Drop an index if it exists (atomic operation).*

## ğŸ” Schema Introspection

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_db.html#table_exists"><code>table_exists</code></a></td>
<td>Check if a table exists</td>
</tr>
</tbody>
</table>

**Example:**

``` python
if not table_exists(tenant_db, "transactions"):
    transactions = register_table(tenant_db, Transaction, "transactions")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_db.py#L127"
target="_blank" style="float:right; font-size:smaller">source</a>

### table_exists

``` python

def table_exists(
    tenant_db:Database, table_name:str
)->bool:

```

*Check if a table exists in the database.*

## Usage Example

Complete workflow: Define dataclass models â†’ Get tenant DB â†’ Register
tables â†’ Create indexes


========================================

FILE: _proc/04_utils_auth.html.md

# ğŸ” Authentication


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

------------------------------------------------------------------------

## â° Sliding Session Configuration

Configure session timeout behavior with sliding expiry.

<table style="width:100%;">
<colgroup>
<col style="width: 33%" />
<col style="width: 27%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>max_age</code></td>
<td><code>3600</code></td>
<td>Session expires after this many seconds of inactivity</td>
</tr>
<tr>
<td><code>sliding</code></td>
<td><code>True</code></td>
<td>Refresh session on each request</td>
</tr>
<tr>
<td><code>absolute_max</code></td>
<td><code>None</code></td>
<td>Optional hard limit regardless of activity (e.g., 86400 for
24h)</td>
</tr>
<tr>
<td><code>secure</code></td>
<td><code>True</code></td>
<td>HTTPS-only cookies in production</td>
</tr>
<tr>
<td><code>same_site</code></td>
<td><code>"lax"</code></td>
<td>SameSite cookie policy for CSRF protection</td>
</tr>
</tbody>
</table>

### How Sliding Sessions Work

    Current (Fixed Timeout):
      Login at 10:00 â†’ Expires at 11:00 (regardless of activity)
      User active at 10:55 â†’ STILL logged out at 11:00 âŒ

    Sliding Timeout:
      Login at 10:00 â†’ Expires at 11:00
      User active at 10:55 â†’ Expires at 11:55 âœ“
      User active at 11:50 â†’ Expires at 12:50 âœ“
      User idle for 1 hour â†’ Logged out âœ“

------------------------------------------------------------------------

## ğŸ”„ Sliding Session Middleware

Custom middleware that extends Starletteâ€™s SessionMiddleware to refresh
cookie `max_age` on each authenticated request.

------------------------------------------------------------------------

### SessionConfig

``` python

def SessionConfig(
    max_age:int=3600, sliding:bool=True, absolute_max:int=None, secure:bool=True, same_site:str='lax',
    http_only:bool=True
)->None:

```

*Configuration for sliding session behavior.*

Attributes: max_age: Session expires after this many seconds of
inactivity. Default: 3600 (1 hour) sliding: If True, refresh session
expiry on each request. Default: True absolute_max: Optional hard limit
in seconds regardless of activity. Default: None secure: If True, cookie
only sent over HTTPS. Default: True same_site: SameSite cookie policy
(â€˜laxâ€™, â€˜strictâ€™, â€˜noneâ€™). Default: â€˜laxâ€™ http_only: If True, cookie not
accessible via JavaScript. Default: True

Example: \>\>\> config = SessionConfig() \# 1 hour inactivity timeout,
sliding enabled \>\>\> config = SessionConfig(max_age=1800) \# 30 min
inactivity timeout \>\>\> config = SessionConfig(max_age=3600,
absolute_max=86400) \# 1h sliding, 24h hard limit

------------------------------------------------------------------------

### SlidingSessionMiddleware

``` python

def SlidingSessionMiddleware(
    app, secret_key:str, session_config:SessionConfig=None, session_cookie:str='session', path:str='/'
):

```

*Session middleware with sliding expiry.*

Extends Starletteâ€™s SessionMiddleware to refresh the session cookie
max_age on each request, implementing sliding session expiry.

Sessions expire after `max_age` seconds of INACTIVITY, not from login
time.

Args: app: ASGI application secret_key: Secret key for signing cookies
session_config: SessionConfig instance for timeout settings
session_cookie: Cookie name. Default: â€˜sessionâ€™ path: Cookie path.
Default: â€˜/â€™

Example: \>\>\> from starlette.applications import Starlette \>\>\> app
= Starlette() \>\>\> config = SessionConfig(max_age=3600) \# 1 hour
inactivity \>\>\> app = SlidingSessionMiddleware(app, secret_key=â€˜â€¦â€™,
session_config=config)

------------------------------------------------------------------------

### create_session_middleware

``` python

def create_session_middleware(
    secret_key:str, session_config:SessionConfig=None, session_cookie:str='session'
)->SlidingSessionMiddleware:

```

*Factory to create SlidingSessionMiddleware for FastHTML apps.*

Args: secret_key: Secret key for signing session cookies (required)
session_config: SessionConfig instance. Default: SessionConfig.default()
session_cookie: Cookie name. Default: â€˜sessionâ€™

Returns: Configured SlidingSessionMiddleware instance

Example: \>\>\> from fasthtml.common import FastHTML \>\>\> \>\>\> \#
Create app WITHOUT default session middleware \>\>\> app =
FastHTML(sess_cls=None) \# Disable default sessions \>\>\> \>\>\> \# Add
sliding session middleware \>\>\> config = SessionConfig(max_age=3600)
\# 1 hour inactivity \>\>\> app =
create_session_middleware(â€˜your-secret-keyâ€™, config)(app) \>\>\> \>\>\>
\# Or wrap during app creation (recommended) \>\>\> middleware =
create_session_middleware(â€˜your-secret-keyâ€™, config) \>\>\> \# Then
configure FastHTML to use it

Note: FastHTMLâ€™s default SessionMiddleware needs to be disabled first.
See integration documentation for patterns.

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>â° Sliding Sessions</td>
<td><code>SessionConfig</code>, <code>SlidingSessionMiddleware</code>,
<code>create_session_middleware</code></td>
<td>Sliding session expiry (inactivity timeout)</td>
</tr>
<tr>
<td>ğŸ›¡ï¸ Beforeware</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware"><code>create_auth_beforeware</code></a></td>
<td>Protect routes, auto-setup tenant DB</td>
</tr>
<tr>
<td>ğŸ”‘ OAuth Client</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client"><code>get_google_oauth_client</code></a></td>
<td>Initialize Google OAuth</td>
</tr>
<tr>
<td>ğŸ”’ CSRF</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state"><code>generate_oauth_state</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state"><code>verify_oauth_state</code></a></td>
<td>Prevent session hijacking</td>
</tr>
<tr>
<td>ğŸ‘¤ Users</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user"><code>create_or_get_global_user</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership"><code>get_user_membership</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership"><code>verify_membership</code></a></td>
<td>User &amp; membership management</td>
</tr>
<tr>
<td>ğŸ—ï¸ Provisioning</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user"><code>provision_new_user</code></a></td>
<td>Auto-create tenant for new users</td>
</tr>
<tr>
<td>ğŸ“‹ Session</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session"><code>create_user_session</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user"><code>get_current_user</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session"><code>clear_session</code></a></td>
<td>Session management</td>
</tr>
<tr>
<td>ğŸš¦ Routing</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#auth_redirect"><code>auth_redirect</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login"><code>route_user_after_login</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access"><code>require_tenant_access</code></a></td>
<td>Authorization &amp; routing</td>
</tr>
<tr>
<td>ğŸŒ Handlers</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request"><code>handle_login_request</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback"><code>handle_oauth_callback</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout"><code>handle_logout</code></a></td>
<td>Route implementations</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    OAuth Authentication Flow                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. User clicks "Login with Google"                             â”‚
    â”‚  2. Generate CSRF state token â†’ store in session                â”‚
    â”‚  3. Redirect to Google OAuth                                    â”‚
    â”‚  4. Google authenticates â†’ redirects with code + state          â”‚
    â”‚  5. Verify CSRF state matches session                           â”‚
    â”‚  6. Exchange code for user info                                 â”‚
    â”‚  7. Create/get GlobalUser in host DB                            â”‚
    â”‚  8. Check membership OR auto-provision new tenant               â”‚
    â”‚  9. Create session â†’ redirect to dashboard                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       Tenant Model                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Many Users â†’ One Tenant (many-to-one)                          â”‚
    â”‚  Each user belongs to exactly ONE tenant                        â”‚
    â”‚  Each tenant can have MANY users                                â”‚
    â”‚  New users auto-create their own tenant                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Security Features

<table>
<thead>
<tr>
<th>Feature</th>
<th>Protection</th>
</tr>
</thead>
<tbody>
<tr>
<td>CSRF State Token</td>
<td>Prevents session hijacking attacks</td>
</tr>
<tr>
<td>Membership Validation</td>
<td>Ensures cross-tenant isolation</td>
</tr>
<tr>
<td>Audit Logging</td>
<td>Tracks all authentication events</td>
</tr>
</tbody>
</table>

### Token Expiry

<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 26%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Token Type</th>
<th>Expiry</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Google OAuth</td>
<td>1 hour</td>
<td>User must re-login (refresh tokens: future)</td>
</tr>
<tr>
<td>Session (sliding)</td>
<td>1 hour inactivity</td>
<td>Refreshes on each request via
<code>SlidingSessionMiddleware</code></td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Sliding Sessions**: Use `SlidingSessionMiddleware` or
> `create_session_middleware()` to keep users logged in while active.
> Sessions only expire after configured inactivity period.

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

## ğŸ­ Role-Based Access Control

Control access based on user roles within the tenant.

### Role Hierarchy

<table>
<thead>
<tr>
<th>Role</th>
<th>Level</th>
<th>Automatic For</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin</code></td>
<td>3</td>
<td>Tenant owners</td>
</tr>
<tr>
<td><code>editor</code></td>
<td>2</td>
<td>â€”</td>
</tr>
<tr>
<td><code>viewer</code></td>
<td>1</td>
<td>â€”</td>
</tr>
</tbody>
</table>

### Key Functions

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#has_min_role"><code>has_min_role</code></a></td>
<td>Check if user meets minimum role requirement</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_role"><code>require_role</code></a></td>
<td>Route decorator for role-based protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_role"><code>get_user_role</code></a></td>
<td>Derive effective role from session + tenant DB</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L48"
target="_blank" style="float:right; font-size:smaller">source</a>

### has_min_role

``` python

def has_min_role(
    user:dict, required_role:str
)->bool:

```

*Check if user meets the minimum role requirement.*

Args: user: User dict with â€˜roleâ€™ field (from request.state.user)
required_role: Minimum role needed (â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™)

Returns: True if userâ€™s role \>= required_role in hierarchy

Example: \>\>\> user = {â€˜roleâ€™: â€˜editorâ€™} \>\>\> has_min_role(user,
â€˜viewerâ€™) \# True - editor \> viewer \>\>\> has_min_role(user, â€˜adminâ€™)
\# False - editor \< admin

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L69"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_role

``` python

def get_user_role(
    session:dict, tenant_db:Database=None
)->str:

```

*Derive effective role from session and tenant database.*

Rules: 1. Tenant owner (session\[â€˜tenant_roleâ€™\] == â€˜ownerâ€™) â†’ â€˜adminâ€™
2. System admin â†’ â€˜adminâ€™ 3. Otherwise â†’ lookup TenantUser.local_role
from tenant DB 4. Fallback â†’ None (user must be explicitly assigned a
role)

Args: session: User session dict tenant_db: Tenant database connection
(optional)

Returns: Effective role string: â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™, or None

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L114"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_role

``` python

def require_role(
    min_role:str
):

```

*Decorator to protect routes with minimum role requirement.*

Args: min_role: Minimum role required (â€˜adminâ€™, â€˜editorâ€™, â€˜viewerâ€™)

Returns: Decorator that checks request.state.user\[â€˜roleâ€™\] Returns 403
Forbidden if user lacks required role

Example: \>\>\> @app.get(â€˜/admin/settingsâ€™) \>\>\>
@require_role(â€˜adminâ€™) \>\>\> def admin_settings(request): â€¦ return
â€œAdmin only contentâ€

    >>> @app.get('/reports')  
    >>> @require_role('viewer')  # All authenticated users
    >>> def view_reports(request):
    ...     return "Reports"

------------------------------------------------------------------------

## âš¡ Session Caching

For HTMX-heavy apps with many partial requests, the beforeware can cache
auth data in the session to avoid database queries on every request.

### Configuration

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>session_cache</code></td>
<td><code>False</code></td>
<td>Enable caching user dict in session</td>
</tr>
<tr>
<td><code>session_cache_ttl</code></td>
<td><code>300</code></td>
<td>Cache TTL in seconds (5 minutes)</td>
</tr>
</tbody>
</table>

### How It Works

    Request arrives
        â”‚
        â–¼
    Check session cache
        â”‚
        â”œâ”€â”€ Cache valid? â†’ Use cached user data (0 DB queries)
        â”‚
        â””â”€â”€ Cache miss/expired? â†’ Query DB â†’ Update cache

### Cache Invalidation

<table>
<thead>
<tr>
<th>Event</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>Logout</td>
<td>Automatic (session cleared)</td>
</tr>
<tr>
<td>Role change</td>
<td>Call <code>invalidate_auth_cache(session)</code></td>
</tr>
<tr>
<td>TTL expiry</td>
<td>Automatic refresh on next request</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L171"
target="_blank" style="float:right; font-size:smaller">source</a>

### invalidate_auth_cache

``` python

def invalidate_auth_cache(
    session:dict
):

```

*Clear the auth cache from session.*

Call this when: - User role or permissions change - User is
added/removed from tenant - Admin changes userâ€™s local_role

Args: session: User session dict

Example: \>\>\> \# After admin changes user role \>\>\>
tenant_user.local_role = â€˜editorâ€™ \>\>\>
tables\[â€˜tenant_usersâ€™\].update(tenant_user) \>\>\>
invalidate_auth_cache(session) \# Force fresh lookup

### Usage Example

``` python
from fh_saas.utils_auth import invalidate_auth_cache

# Enable caching (recommended for HTMX apps)
app = FastHTML(
    before=create_auth_beforeware(
        session_cache=True,
        session_cache_ttl=300  # 5 minutes
    )
)

# After changing user role, invalidate their cache
@app.post('/admin/users/{user_id}/role')
def update_role(request, user_id: str, new_role: str):
    tables = request.state.tables
    user = tables['tenant_users'].get(user_id)
    user.local_role = new_role
    tables['tenant_users'].update(user)
    
    # If changing own role, invalidate cache
    if user_id == request.state.user['user_id']:
        invalidate_auth_cache(request.session)
    
    return "Role updated"
```

### Usage in Routes

``` python
from fh_saas.utils_auth import require_role, has_min_role

# Option 1: Decorator for route-level protection
@app.get('/admin/users')
@require_role('admin')
def manage_users(request):
    return "Admin-only user management"

@app.get('/dashboard')
@require_role('viewer')  # All roles can access
def dashboard(request):
    return "Dashboard for all users"

# Option 2: Inline check for conditional logic
@app.get('/data')
def view_data(request):
    user = request.state.user
    
    if has_min_role(user, 'admin'):
        return "All data with admin controls"
    elif has_min_role(user, 'editor'):
        return "Data with edit buttons"
    else:
        return "Read-only data view"
```

### Role Derivation Flow

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Role Derivation (in beforeware)              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. Check session['tenant_role']                                â”‚
    â”‚     â””â”€â”€ If 'owner' â†’ effective role = 'admin'                  â”‚
    â”‚                                                                 â”‚
    â”‚  2. Check session['is_sys_admin']                               â”‚
    â”‚     â””â”€â”€ If True â†’ effective role = 'admin'                     â”‚
    â”‚                                                                 â”‚
    â”‚  3. Lookup TenantUser.local_role in tenant DB                   â”‚
    â”‚     â””â”€â”€ Returns assigned role or None                          â”‚
    â”‚                                                                 â”‚
    â”‚  4. Attach to request.state.user['role']                        â”‚
    â”‚     â””â”€â”€ Used by require_role() and has_min_role()              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ›¡ï¸ Auth Beforeware

Protect routes by checking for authenticated sessions with auto tenant
DB setup.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_auth_beforeware"><code>create_auth_beforeware</code></a></td>
<td>Factory to create route protection middleware</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Pass to FastHTMLâ€™s `before=` parameter for app-wide
> authentication

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L244"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_auth_beforeware

``` python

def create_auth_beforeware(
    redirect_path:str='/login', session_key:str='user_id', skip:list=None, include_defaults:bool=True,
    setup_tenant_db:bool=True, schema_init:Callable=None, session_cache:bool=False, session_cache_ttl:int=300,
    require_subscription:bool=False, subscription_redirect:str=None, grace_period_days:int=3,
    session_config:SessionConfig=None
):

```

*Create Beforeware that checks for authenticated session and sets up
request.state.*

Args: redirect_path: Where to redirect unauthenticated users
session_key: Session key for user ID skip: List of regex patterns to
skip auth include_defaults: Include default skip patterns
setup_tenant_db: Auto-setup tenant database on request.state
schema_init: Optional callback to initialize tables dict. Signature:
(tenant_db: Database) -\> dict\[str, Table\] Result stored in
request.state.tables session_cache: Enable caching user dict in session
to reduce DB queries. Recommended for HTMX-heavy apps. Default: False
session_cache_ttl: Cache TTL in seconds. Default: 300 (5 minutes)
require_subscription: If True, check for active subscription and return
402 if not found. Default: False subscription_redirect: Optional URL to
redirect if subscription required. If None, returns 402 Payment Required
response. grace_period_days: Days to allow access after payment failure
(default: 3) session_config: Optional SessionConfig for absolute timeout
enforcement. Note: Sliding expiry requires SlidingSessionMiddleware.
This parameter only enforces absolute_max if configured.

Returns: Beforeware instance for FastHTML apps

Sets on request.state: - user: dict with user_id, email, tenant_id,
role, is_owner - tenant_id: str - tenant_db: Database connection -
tables: dict of Table objects (if schema_init provided) - subscription:
Subscription object (if require_subscription enabled)

Example: \>\>\> \# Basic usage \>\>\> beforeware =
create_auth_beforeware()

    >>> # With session caching for HTMX apps
    >>> beforeware = create_auth_beforeware(
    ...     session_cache=True,
    ...     session_cache_ttl=300
    ... )

    >>> # With schema initialization
    >>> def get_app_tables(db):
    ...     return {'users': db.create(User, pk='id')}
    >>> beforeware = create_auth_beforeware(schema_init=get_app_tables)

    >>> # With subscription requirement
    >>> beforeware = create_auth_beforeware(
    ...     require_subscription=True,
    ...     subscription_redirect='/pricing'
    ... )

------------------------------------------------------------------------

## ğŸ”‘ OAuth Client

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_google_oauth_client"><code>get_google_oauth_client</code></a></td>
<td>Initialize Google OAuth client from env vars</td>
</tr>
</tbody>
</table>

> âš ï¸ **Required env vars**: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L405"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_google_oauth_client

``` python

def get_google_oauth_client(
    
):

```

*Initialize Google OAuth client with credentials from environment.*

------------------------------------------------------------------------

## ğŸ”’ CSRF Protection

Prevent session hijacking via state token validation.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#generate_oauth_state"><code>generate_oauth_state</code></a></td>
<td>Create random UUID for CSRF protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_oauth_state"><code>verify_oauth_state</code></a></td>
<td>Validate callback state matches session</td>
</tr>
</tbody>
</table>

### Attack Without CSRF Protection

    1. Attacker initiates OAuth â†’ gets auth code
    2. Attacker sends victim: yourapp.com/auth/callback?code=ATTACKER_CODE
    3. Victim clicks â†’ session created for attacker's account
    4. Victim enters data â†’ attacker sees it all

> ğŸ›¡ï¸ **Solution**: State token generated at login, verified at callback

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L421"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_oauth_state

``` python

def verify_oauth_state(
    session:dict, callback_state:str
):

```

*Verify OAuth callback state matches stored session state (CSRF
protection).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L416"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_oauth_state

``` python

def generate_oauth_state(
    
):

```

*Generate cryptographically secure random state token for CSRF
protection.*

------------------------------------------------------------------------

## ğŸ‘¤ User Management

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_or_get_global_user"><code>create_or_get_global_user</code></a></td>
<td>Create or retrieve user from host DB</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_user_membership"><code>get_user_membership</code></a></td>
<td>Get userâ€™s active tenant membership</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#verify_membership"><code>verify_membership</code></a></td>
<td>Validate user has access to tenant</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L473"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_membership

``` python

def verify_membership(
    host_db:HostDatabase, user_id:str, tenant_id:str
)->bool:

```

*Verify user has active membership for specific tenant.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L465"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_user_membership

``` python

def get_user_membership(
    host_db:HostDatabase, user_id:str
):

```

*Get single active membership for user.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L434"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_or_get_global_user

``` python

def create_or_get_global_user(
    host_db:HostDatabase, oauth_id:str, email:str, oauth_info:dict=None
):

```

*Create or retrieve GlobalUser from host database.*

------------------------------------------------------------------------

## ğŸ—ï¸ Auto-Provisioning

Create tenant infrastructure for first-time users.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#provision_new_user"><code>provision_new_user</code></a></td>
<td>Create tenant DB, catalog entry, membership, and TenantUser</td>
</tr>
</tbody>
</table>

### Provisioning Steps

    1. Create physical tenant database (PostgreSQL/SQLite)
    2. Register tenant in host catalog
    3. Create membership (user â†’ tenant, role='owner')
    4. Create TenantUser profile (local_role='admin')
    5. Initialize core tenant schema
    6. Log audit event

> ğŸ’¡ **Future**: Insert payment screen before step 1

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L481"
target="_blank" style="float:right; font-size:smaller">source</a>

### provision_new_user

``` python

def provision_new_user(
    host_db:HostDatabase, global_user:GlobalUser
)->str:

```

*Auto-provision new tenant for first-time user.*

------------------------------------------------------------------------

## ğŸ“‹ Session Management

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#create_user_session"><code>create_user_session</code></a></td>
<td>Populate session after successful OAuth</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#get_current_user"><code>get_current_user</code></a></td>
<td>Extract user info from session</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#clear_session"><code>clear_session</code></a></td>
<td>Clear all session data (logout)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L588"
target="_blank" style="float:right; font-size:smaller">source</a>

### clear_session

``` python

def clear_session(
    session:dict
):

```

*Clear all session data (logout).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L565"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_current_user

``` python

def get_current_user(
    session:dict
)->dict | None:

```

*Extract current user info from session.*

Returns: dict with keys: user_id, email, tenant_id, tenant_role,
is_sys_admin

Note: The â€˜roleâ€™ and â€˜is_ownerâ€™ fields are added by
create_auth_beforeware after deriving the effective role from
TenantUser.local_role. Access via request.state.user\[â€˜roleâ€™\] in
routes.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L555"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_user_session

``` python

def create_user_session(
    session:dict, global_user:GlobalUser, membership:Membership
):

```

*Create authenticated session after successful OAuth login.*

Sets session keys for user identity and tracking: - user_id, email,
tenant_id, tenant_role, is_sys_admin: Identity - login_at: Timestamp
when user logged in - session_started_at: Unix timestamp for absolute
session timeout tracking

------------------------------------------------------------------------

## ğŸš¦ Route Helpers

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#auth_redirect"><code>auth_redirect</code></a></td>
<td>HTMX-aware redirect to login page</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#route_user_after_login"><code>route_user_after_login</code></a></td>
<td>Determine redirect URL based on user type</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#require_tenant_access"><code>require_tenant_access</code></a></td>
<td>Get tenant DB with membership validation</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L593"
target="_blank" style="float:right; font-size:smaller">source</a>

### auth_redirect

``` python

def auth_redirect(
    request, redirect_url:str='/login'
):

```

*HTMX-aware redirect for authentication flows.*

When HTMX makes a partial request and receives a standard redirect
(302/303), it follows the redirect and swaps the response into the
target element. This causes the login page to appear inside the partial
content area.

This function detects HTMX requests and uses the `HX-Redirect` header to
trigger a full page navigation instead.

Args: request: Starlette request object redirect_url: URL to redirect to
(default: â€˜/loginâ€™)

Returns: Response with appropriate redirect mechanism

Example:
`python     @app.get('/dashboard')     def dashboard(request):         if not get_current_user(request.session):             return auth_redirect(request)         return render_dashboard()`

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L642"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_tenant_access

``` python

def require_tenant_access(
    request_or_session
):

```

*Get tenant database with membership validation.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L633"
target="_blank" style="float:right; font-size:smaller">source</a>

### route_user_after_login

``` python

def route_user_after_login(
    global_user:GlobalUser, membership:Membership=None
)->str:

```

*Determine redirect URL based on user type and membership.*

## ğŸŒ OAuth Route Handlers

Complete OAuth 2.0 flow handlers:

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_login_request"><code>handle_login_request</code></a></td>
<td>Initiate OAuth with CSRF protection</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_oauth_callback"><code>handle_oauth_callback</code></a></td>
<td>Process provider response</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_auth.html#handle_logout"><code>handle_logout</code></a></td>
<td>Clear session and redirect</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L724"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_logout

``` python

def handle_logout(
    session
):

```

*Clear session and redirect to login page.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L680"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_oauth_callback

``` python

def handle_oauth_callback(
    code:str, state:str, request, session
):

```

*Complete OAuth flow: CSRF verify â†’ user info â†’ provision â†’ session â†’
redirect.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_auth.py#L664"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_login_request

``` python

def handle_login_request(
    request, session
):

```

*Generate Google OAuth URL with CSRF state protection.*


========================================

FILE: _proc/06_utils_log.html.md

# ğŸ“Š Logging


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging</code></a></td>
<td>One-time setup at app startup</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ“‹ Environment Variables

<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FH_SAAS_LOG_LEVEL</code></td>
<td>WARNING</td>
<td>DEBUG, INFO, WARNING, ERROR</td>
</tr>
<tr>
<td><code>FH_SAAS_LOG_FILE</code></td>
<td>(none)</td>
<td>Path to log file (optional)</td>
</tr>
</tbody>
</table>

## âš™ï¸ configure_logging

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_log.py#L15"
target="_blank" style="float:right; font-size:smaller">source</a>

### configure_logging

``` python

def configure_logging(
    log_file:str=None, level:str=None, max_bytes:int=10000000, backup_count:int=5
):

```

*Configure logging for all fh_saas modules - call once at app startup.*

## ğŸ“– Usage Examples

### 1. App Startup (call once in main.py)

``` python
from fh_saas.utils_log import configure_logging

# Option A: Use environment variables (recommended for production)
# Set FH_SAAS_LOG_LEVEL=INFO and FH_SAAS_LOG_FILE=./logs/app.log in .env
configure_logging()

# Option B: Explicit - console only
configure_logging(level='INFO')

# Option C: Console + rotating file
configure_logging(level='INFO', log_file='./logs/app.log')
```

### 2. In Any fh_saas Module (already done)

Every module in fh_saas declares a logger at the top:

``` python
# fh_saas/utils_oauth.py
import logging
logger = logging.getLogger(__name__)

def handle_login_request(request, session):
    logger.debug('Login request initiated')
    # ... do work ...
    logger.info(f'OAuth complete, redirecting to {redirect_url}')
```

### 3. Where Do Logs Go?

<table>
<colgroup>
<col style="width: 48%" />
<col style="width: 31%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>Configuration</th>
<th>Console</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging()</code></a></td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>configure_logging(log_file='app.log')</code></td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>No <a
href="https://abhisheksreesaila.github.io/fh-saas/utils_log.html#configure_logging"><code>configure_logging()</code></a>
call</td>
<td>âŒ silent</td>
<td>âŒ</td>
</tr>
</tbody>
</table>

### 4. Log Levels

<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 44%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Level</th>
<th>When to Use</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DEBUG</code></td>
<td>Detailed diagnostic</td>
<td><code>logger.debug('Checking user session')</code></td>
</tr>
<tr>
<td><code>INFO</code></td>
<td>Normal operations</td>
<td><code>logger.info('User logged in')</code></td>
</tr>
<tr>
<td><code>WARNING</code></td>
<td>Unexpected but not failing</td>
<td><code>logger.warning('Token expiring soon')</code></td>
</tr>
<tr>
<td><code>ERROR</code></td>
<td>Operation failed</td>
<td><code>logger.error('Auth failed', exc_info=True)</code></td>
</tr>
</tbody>
</table>

### 5. Real Example from fh_saas

``` python
# In your FastHTML app
from fasthtml.common import *
from fh_saas.utils_log import configure_logging
from fh_saas.utils_oauth import handle_login_request, handle_oauth_callback

# Configure logging ONCE at startup
configure_logging(level='INFO', log_file='./logs/app.log')

app = FastHTML()

@app.get('/login')
def login(request, session):
    return handle_login_request(request, session)  # Logs automatically

@app.get('/auth/callback') 
def callback(code: str, state: str, request, session):
    return handle_oauth_callback(code, state, request, session)  # Logs automatically
```

Output in console and file:

    2026-01-10 14:30:00 | fh_saas.utils_oauth | DEBUG | Login request initiated
    2026-01-10 14:30:05 | fh_saas.utils_oauth | DEBUG | OAuth callback received
    2026-01-10 14:30:05 | fh_saas.utils_oauth | INFO | OAuth complete, redirecting to /dashboard


========================================

FILE: _proc/07_utils_api.html.md

# ğŸŒ HTTP Client


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 36%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ”„ Client</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient"><code>AsyncAPIClient</code></a></td>
<td>Async HTTP with retry</td>
</tr>
<tr>
<td>ğŸ”‘ Auth</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth"><code>bearer_token_auth</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth"><code>api_key_auth</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth"><code>oauth_token_auth</code></a></td>
<td>Auth header generators</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Retry Logic Flow                             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Request â†’ Response                                             â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Status 429 or 500+ â†’ Retry (exponential: 2s, 4s, 8s)          â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Status 400-499 (except 429) â†’ Fail immediately                â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Network error â†’ Retry                                          â”‚
    â”‚     â†“                                                           â”‚
    â”‚  Max 3 attempts â†’ Raise exception                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ”„ AsyncAPIClient

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#asyncapiclient"><code>AsyncAPIClient</code></a></td>
<td>Async HTTP client with retry</td>
</tr>
<tr>
<td><code>.request()</code></td>
<td>Execute HTTP request with retry</td>
</tr>
<tr>
<td><code>.get_json()</code></td>
<td>GET request returning JSON</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L28"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient

``` python

def AsyncAPIClient(
    base_url:str, auth_headers:dict=None, timeout:int=30
):

```

*Async HTTP client with retry logic for external API integrations.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L31"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.\_\_init\_\_

``` python

def __init__(
    base_url:str, auth_headers:dict=None, timeout:int=30
):

```

*Initialize client with base URL, optional auth headers, and timeout.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L63"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.request

``` python

def request(
    method:str, endpoint:str, params:dict=None, json:dict=None, headers:dict=None
)->httpx.Response:

```

*Execute HTTP request with automatic retry on 429/500+ errors.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### AsyncAPIClient.get_json

``` python

def get_json(
    endpoint:str, params:dict=None
)->Dict[str, Any]:

```

*Convenience GET that returns parsed JSON.*

## ğŸ”‘ Auth Helpers

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#bearer_token_auth"><code>bearer_token_auth</code></a></td>
<td>Bearer token header</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#api_key_auth"><code>api_key_auth</code></a></td>
<td>API key header (customizable)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_api.html#oauth_token_auth"><code>oauth_token_auth</code></a></td>
<td>OAuth 2.0 access token</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L97"
target="_blank" style="float:right; font-size:smaller">source</a>

### bearer_token_auth

``` python

def bearer_token_auth(
    token:str
)->dict:

```

*Generate Bearer token authentication header.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### api_key_auth

``` python

def api_key_auth(
    api_key:str, header_name:str='X-API-Key'
)->dict:

```

*Generate API key header with customizable header name.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_api.py#L107"
target="_blank" style="float:right; font-size:smaller">source</a>

### oauth_token_auth

``` python

def oauth_token_auth(
    access_token:str
)->dict:

```

*Generate OAuth 2.0 access token header (alias for bearer_token_auth).*


========================================

FILE: _proc/08_utils_graphql.html.md

# ğŸ”® GraphQL Client


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_graphql.html#graphqlclient"><code>GraphQLClient</code></a></td>
<td>GraphQL client with async generator pagination</td>
</tr>
<tr>
<td><code>.from_url()</code></td>
<td>âœ¨ <strong>NEW</strong> - Create client from URL with optional
bearer token</td>
</tr>
<tr>
<td><code>.execute()</code></td>
<td>âœ¨ <strong>NEW</strong> - Unified method for queries and
mutations</td>
</tr>
<tr>
<td><code>.execute_query()</code></td>
<td>Execute single query (returns full response)</td>
</tr>
<tr>
<td><code>.execute_mutation()</code></td>
<td>Execute mutation (alias for execute_query)</td>
</tr>
<tr>
<td><code>.fetch_pages_relay()</code></td>
<td>âœ¨ <strong>NEW</strong> - Fetch all pages from Relay-style
pagination</td>
</tr>
<tr>
<td><code>.fetch_pages_generator()</code></td>
<td>Stream paginated data (memory-efficient)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_graphql.html#execute_graphql"><code>execute_graphql()</code></a></td>
<td>âœ¨ <strong>NEW</strong> - One-liner function for simple queries</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Streaming Pagination Flow                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Page 1: query($cursor: null) â†’ yield [batch] â†’ process        â”‚
    â”‚  Page 2: query($cursor: xyz)  â†’ yield [batch] â†’ process        â”‚
    â”‚  Page N: query($cursor: abc)  â†’ yield [batch] â†’ process        â”‚
    â”‚                                                                 â”‚
    â”‚  âš ï¸ CRITICAL: Never accumulates full dataset in memory         â”‚
    â”‚  âœ… Memory: O(page_size) not O(total_records)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ”® GraphQLClient

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.from_url()</code></td>
<td>âœ¨ <strong>NEW</strong> - Create client from URL + token</td>
</tr>
<tr>
<td><code>.execute()</code></td>
<td>âœ¨ <strong>NEW</strong> - Unified query/mutation (returns data
only)</td>
</tr>
<tr>
<td><code>.execute_query()</code></td>
<td>Execute single GraphQL query (full response)</td>
</tr>
<tr>
<td><code>.execute_mutation()</code></td>
<td>Execute GraphQL mutation</td>
</tr>
<tr>
<td><code>.fetch_pages_relay()</code></td>
<td>âœ¨ <strong>NEW</strong> - Auto-accumulate Relay pagination</td>
</tr>
<tr>
<td><code>.fetch_pages_generator()</code></td>
<td>Async generator for paginated data (streaming)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

### ğŸš€ Quick Start Examples

#### One-Liner Query

``` python
from fh_saas.utils_graphql import execute_graphql

# NEW: No client management needed
result = await execute_graphql(
    url="https://api.example.com/graphql",
    query="query { users { id name } }",
    bearer_token="your-token"
)
```

#### Convenience Constructor

``` python
from fh_saas.utils_graphql import GraphQLClient

# NEW: Direct from URL
async with GraphQLClient.from_url(
    url="https://api.example.com/graphql",
    bearer_token="your-token"
) as gql:
    result = await gql.execute("query { users { id name } }")
```

#### Relay Pagination (Auto-Accumulate)

``` python
# NEW: Fetch all pages automatically
async with GraphQLClient.from_url(url, bearer_token=token) as gql:
    all_items = await gql.fetch_pages_relay(
        query='''
            query($first: Int, $after: String, $filter: Filter) {
                transactionsConnection(first: $first, after: $after, filter: $filter) {
                    edges { node { id amount } }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        connection_path="transactionsConnection",
        variables={"filter": {"status": "completed"}},
        page_size=100,
        max_pages=50  # Safety limit
    )
    print(f"Fetched {len(all_items)} total items")
```

#### Legacy: Manual Client Management

``` python
from fh_saas.utils_api import AsyncAPIClient, bearer_token_auth
from fh_saas.utils_graphql import GraphQLClient

# Still supported for advanced use cases
async with AsyncAPIClient(
    'https://api.example.com/graphql',
    auth_headers=bearer_token_auth('TOKEN')
) as http_client:
    
    client = GraphQLClient(http_client)
    result = await client.execute_query(
        query='{ users { id name } }'
    )
```

#### Memory-Efficient Streaming (Generator)

``` python
# For very large datasets - process batches without accumulating
async with GraphQLClient.from_url(url, bearer_token=token) as gql:
    async for batch in gql.fetch_pages_generator(
        query_template='''
            query($cursor: String) {
                users(after: $cursor, first: 1000) {
                    nodes { id name email }
                    pageInfo { hasNextPage endCursor }
                }
            }
        ''',
        variables={'cursor': None},
        items_path=['data', 'users', 'nodes'],
        cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
        has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
    ):
        print(f"Processing batch of {len(batch)} records")
        # Process immediately - never load full dataset
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient

``` python

def GraphQLClient(
    api_client:AsyncAPIClient, # Initialized AsyncAPIClient instance
    endpoint:str='', # GraphQL endpoint path (default: '' for base URL)
):

```

*GraphQL client with streaming pagination for memory-efficient data
fetching.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L22"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.\_\_init\_\_

``` python

def __init__(
    api_client:AsyncAPIClient, # Initialized AsyncAPIClient instance
    endpoint:str='', # GraphQL endpoint path (default: '' for base URL)
):

```

*Initialize self. See help(type(self)) for accurate signature.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L89"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.execute_query

``` python

def execute_query(
    query:str, # GraphQL query string
    variables:dict=None, # Query variables
)->Dict[str, Any]:

```

*Execute a single GraphQL query and return the JSON response.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L114"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.execute_mutation

``` python

def execute_mutation(
    mutation:str, # GraphQL mutation string
    variables:dict=None, # Mutation variables
)->Dict[str, Any]:

```

*Execute a GraphQL mutation (alias for execute_query).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L177"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.fetch_pages_generator

``` python

def fetch_pages_generator(
    query_template:str, # GraphQL query with $variables placeholders
    variables:dict, # Initial variables (must include cursor key)
    items_path:list[str], # JSONPath to list of items (e.g., ['data', 'users', 'nodes'])
    cursor_path:list[str], # JSONPath to next cursor (e.g., ['data', 'users', 'pageInfo', 'endCursor'])
    has_next_path:list[str]=None, # Optional path to hasNextPage boolean (if None, checks cursor != None)
    cursor_var:str='cursor', # Variable name for cursor in query (default: 'cursor')
)->AsyncGenerator[List[Dict], None]:

```

*Stream paginated GraphQL data page-by-page using async generator.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.fetch_pages_relay

``` python

def fetch_pages_relay(
    query:str, # GraphQL query with $first and $after variables
    connection_path:str, # Dot-notation path to connection object (e.g., "transactionsConnection")
    variables:dict | None=None, # Base variables for the query (excluding first/after)
    page_size:int=100, # Number of items per page
    max_pages:int | None=None, # Maximum pages to fetch (None for unlimited)
)->list[dict]:

```

*Fetch all pages from a Relay-style paginated GraphQL query.*

Example query structure: query($first: Int, $after: String, $filter:
TransactionFilter) { transactionsConnection(first: $first, after:
$after, filter: $filter) { edges { node { id amount } } pageInfo {
hasNextPage endCursor } } }

Returns: List of all nodes from all pages

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L60"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.execute

``` python

def execute(
    query:str, # GraphQL query or mutation string
    variables:dict=None, # Query/mutation variables
)->Dict[str, Any]:

```

*Execute a GraphQL query or mutation and return the data portion.*

This is a unified method that works for both queries and mutations.
Returns only the â€˜dataâ€™ portion of the response for convenience.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### GraphQLClient.from_url

``` python

def from_url(
    cls, url:str, # GraphQL endpoint URL
    bearer_token:str | None=None, # Optional bearer token for Authorization header
    headers:dict | None=None, # Optional additional headers
):

```

*Create GraphQL client directly from URL with optional bearer token.*

Usage: async with GraphQLClient.from_url(url, bearer_token=token) as
gql: result = await gql.execute(query)

### Streaming Pagination Details

**Why use generators?** For large datasets (millions of rows),
accumulating all data in memory causes OOM errors. The async generator
yields batches instead.

**Parameters:**

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>query_template</code></td>
<td>GraphQL query with <code>$cursor</code> variable</td>
</tr>
<tr>
<td><code>variables</code></td>
<td>Initial variables dict (e.g., <code>{'cursor': None}</code>)</td>
</tr>
<tr>
<td><code>items_path</code></td>
<td>Path to data list in response (e.g.,
<code>['data', 'users', 'nodes']</code>)</td>
</tr>
<tr>
<td><code>cursor_path</code></td>
<td>Path to next cursor (e.g.,
<code>['data', 'users', 'pageInfo', 'endCursor']</code>)</td>
</tr>
<tr>
<td><code>has_next_path</code></td>
<td>Optional path to <code>hasNextPage</code> flag</td>
</tr>
<tr>
<td><code>cursor_var</code></td>
<td>Cursor variable name in query (default: <code>'cursor'</code>)</td>
</tr>
</tbody>
</table>

**Example with database insert:**

``` python
async for batch in client.fetch_pages_generator(
    query_template='''
        query($cursor: String) {
            users(after: $cursor, first: 1000) {
                nodes { id name }
                pageInfo { hasNextPage endCursor }
            }
        }
    ''',
    variables={'cursor': None},
    items_path=['data', 'users', 'nodes'],
    cursor_path=['data', 'users', 'pageInfo', 'endCursor'],
    has_next_path=['data', 'users', 'pageInfo', 'hasNextPage']
):
    # Process each batch immediately
    df = pl.DataFrame(batch)
    df.write_database('staging_table', connection=conn)
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_graphql.py#L234"
target="_blank" style="float:right; font-size:smaller">source</a>

### execute_graphql

``` python

def execute_graphql(
    url:str, # GraphQL endpoint URL
    query:str, # GraphQL query string
    variables:dict | None=None, # Optional query variables
    bearer_token:str | None=None, # Optional bearer token for Authorization header
    headers:dict | None=None, # Optional additional headers
)->dict:

```

*Execute a single GraphQL query without managing client lifecycle.*

This is a convenience function for one-off queries. For multiple
queries, use GraphQLClient.from_url() to reuse the connection.

Usage: result = await execute_graphql(
url=â€œhttps://api.example.com/graphqlâ€, query=â€œquery { users { id name }
}â€, bearer_token=â€œyour-tokenâ€ )

Raises: ValueError: If the response contains GraphQL errors


========================================

FILE: _proc/14_utils_webhook.html.md

# ğŸª Webhooks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 signature verification</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Prevent duplicate processing</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Webhook Processing Flow                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Request â†’ Verify Signature â†’ Check Idempotency â†’ Log Event    â”‚
    â”‚     â†“           âœ…              âœ… (not duplicate)              â”‚
    â”‚  Execute Handler â†’ Update Status â†’ Return Response              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ” Signature Verification

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 with timing-safe comparison</td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import *
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

``` python

def verify_webhook_signature(
    payload:str, # Raw request body as string
    signature:str, # Signature from header (format: "sha256=<hex>")
    secret:Optional=None, # Secret key, defaults to WEBHOOK_SECRET env var
)->bool:

```

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

## ğŸ”„ Idempotency

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Check if event already processed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

``` python

def check_idempotency(
    db:Database, # Tenant database connection
    idempotency_key:str, # Unique key for this webhook event
)->bool:

```

*Check if webhook event already processed. Returns True if duplicate.*

## ğŸ“ Event Logging

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#update_webhook_status"><code>update_webhook_status</code></a></td>
<td>Update status after processing</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

``` python

def log_webhook_event(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system (e.g., "stripe", "github")
    event_type:str, # Event type (e.g., "payment.success")
    payload:Dict, # Full webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    status:str='pending', # Status: pending, processing, completed, failed
):

```

*Log webhook event to database*

## Update Webhook Status

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

``` python

def update_webhook_status(
    db:Database, # Tenant database connection
    webhook_id:str, # Webhook ID to update
    status:str, # New status
    error_message:Optional=None, # Optional error message
):

```

*Update webhook event status and processed timestamp*

## âš¡ Process Webhook

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

``` python

def process_webhook(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system
    event_type:str, # Event type
    payload:Dict, # Webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    raw_body:str, # Raw request body for signature verification
    handler:Callable, # App-specific webhook handler function
    secret:Optional=None, # Optional webhook secret
)->Dict:

```

*Process webhook with verification, idempotency, and custom handler
execution*

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

``` python

def verify_webhook_signature(
    payload:str, # Raw request body as string
    signature:str, # Signature from header (format: "sha256=<hex>")
    secret:Optional=None, # Secret key, defaults to WEBHOOK_SECRET env var
)->bool:

```

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

``` python

def check_idempotency(
    db:Database, # Tenant database connection
    idempotency_key:str, # Unique key for this webhook event
)->bool:

```

*Check if webhook event already processed. Returns True if duplicate.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

``` python

def log_webhook_event(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system (e.g., "stripe", "github")
    event_type:str, # Event type (e.g., "payment.success")
    payload:Dict, # Full webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    status:str='pending', # Status: pending, processing, completed, failed
):

```

*Log webhook event to database*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

``` python

def update_webhook_status(
    db:Database, # Tenant database connection
    webhook_id:str, # Webhook ID to update
    status:str, # New status
    error_message:Optional=None, # Optional error message
):

```

*Update webhook event status and processed timestamp*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

``` python

def process_webhook(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system
    event_type:str, # Event type
    payload:Dict, # Webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    raw_body:str, # Raw request body for signature verification
    handler:Callable, # App-specific webhook handler function
    secret:Optional=None, # Optional webhook secret
)->Dict:

```

*Process webhook with verification, idempotency, and custom handler
execution*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_webhook_request

``` python

def handle_webhook_request(
    request, # FastHTML request object
    db:Database, # Tenant database instance
    source:str, # Webhook source identifier
    handler:Callable, # App-specific handler function
    signature_header:str='X-Webhook-Signature', # Header containing signature
    idempotency_header:str='X-Idempotency-Key', # Header containing idempotency key
    event_type_field:str='type', # Field in payload containing event type
    secret:Optional=None, # Optional webhook secret
)->tuple: # Returns (response_dict, status_code)

```

*FastHTML route handler for webhook requests.*

Example: @app.post(â€˜/webhooks/stripeâ€™) async def
stripe_webhook(request): return await handle_webhook_request(
request=request, db=get_tenant_db(request), source=â€˜stripeâ€™,
handler=handle_stripe_event, signature_header=â€˜X-Stripe-Signatureâ€™,
run_in_background=True )


========================================

FILE: _proc/02_utils_sql.html.md

# ğŸ—ƒï¸ SQL Helpers


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

This module provides a **batteries-included SQL toolkit** for building
database-heavy applications:

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ” Query Registry</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id"><code>run_id</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params"><code>validate_params</code></a></td>
<td>Execute queries by ID from centralized registries</td>
</tr>
<tr>
<td>â• Insert-Only</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only"><code>bulk_insert_only</code></a></td>
<td>Insert new records, skip conflicts</td>
</tr>
<tr>
<td>ğŸ”„ Upsert</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert"><code>bulk_upsert</code></a></td>
<td>Insert or update existing records</td>
</tr>
<tr>
<td>ğŸ“ CRUD</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id"><code>get_by_id</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record"><code>update_record</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record"><code>delete_record</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete"><code>bulk_delete</code></a></td>
<td>Standard database operations</td>
</tr>
<tr>
<td>ğŸ”§ Utilities</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql"><code>paginate_sql</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Transaction management &amp; helpers</td>
</tr>
<tr>
<td>ğŸ’° Money</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents"><code>to_cents</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents"><code>from_cents</code></a></td>
<td>Currency conversion for <code>int</code>-only storage</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     SQL Utilities Layer                         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ” Query Registry        â”‚  Execute queries by ID              â”‚
    â”‚  â• Insert Operations     â”‚  insert_only, bulk_insert_only      â”‚
    â”‚  ğŸ”„ Upsert Operations     â”‚  upsert, bulk_upsert                â”‚
    â”‚  ğŸ“ CRUD Operations       â”‚  get, update, delete (single/bulk)  â”‚
    â”‚  ğŸ”§ Utilities             â”‚  transactions, pagination, batching â”‚
    â”‚  ğŸ’° Money Helpers         â”‚  cents â†” dollars conversion         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  DB_TYPE Detection: PostgreSQL / SQLite (auto-switch syntax)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              fastsql Database Connection                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Conflict Handling

<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 38%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr>
<th>Operation</th>
<th>On Conflict</th>
<th>Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a></td>
<td><strong>Skip</strong> (DO NOTHING)</td>
<td>Append-only logs, idempotent imports</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td><strong>Update</strong> existing</td>
<td>Sync external data, refresh caches</td>
</tr>
</tbody>
</table>

### Performance Tips

<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 46%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr>
<th>Scenario</th>
<th>Recommended</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single record</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td>Simple, immediate</td>
</tr>
<tr>
<td>10+ records</td>
<td><code>bulk_*</code> variants</td>
<td>10-100x faster</td>
</tr>
<tr>
<td>100+ records</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Commits per batch, memory-safe</td>
</tr>
<tr>
<td>Multi-table changes</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a></td>
<td>All-or-nothing commits</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ” Database Type Detection

Automatically detects PostgreSQL vs SQLite from `DB_TYPE` environment
variable to generate appropriate SQL syntax.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L24"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_db_type

``` python

def get_db_type(
    
):

```

*Get database type from environment variable*

------------------------------------------------------------------------

## ğŸ¯ Query Registry

Execute queries by ID from a centralized registry with automatic
parameter validation.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#run_id"><code>run_id</code></a></td>
<td>Execute a registered query by its ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#validate_params"><code>validate_params</code></a></td>
<td>Ensure all <code>:param</code> placeholders have values</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L42"
target="_blank" style="float:right; font-size:smaller">source</a>

### run_id

``` python

def run_id(
    db:Database, registry:Dict, query_id:str, params:Optional=None
)->Any:

```

*Execute a query by ID from a query registry.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### validate_params

``` python

def validate_params(
    sql:str, params:Dict
)->None:

```

*Validate that all required parameters are provided*

------------------------------------------------------------------------

## â• Insert-Only

Insert new records **only if they donâ€™t exist** â€” conflicts are silently
skipped.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 26%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Records</th>
<th>SQL Generated</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#insert_only"><code>insert_only</code></a></td>
<td>Single</td>
<td><code>ON CONFLICT DO NOTHING</code> (PG) /
<code>INSERT OR IGNORE</code> (SQLite)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_insert_only"><code>bulk_insert_only</code></a></td>
<td>Multiple</td>
<td>Same, with batch execution</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Idempotent imports, append-only audit logs, webhook
> deduplication

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L95"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_insert_only

``` python

def bulk_insert_only(
    db:Database, table_name:str, records:List, conflict_cols:List, auto_commit:bool=True
)->None:

```

*Insert multiple records, skipping conflicts (optimized batch
operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L64"
target="_blank" style="float:right; font-size:smaller">source</a>

### insert_only

``` python

def insert_only(
    db:Database, table_name:str, record:Dict, conflict_cols:List, auto_commit:bool=True
)->None:

```

*Insert a single record only if it doesnâ€™t exist (ignores conflicts).*

------------------------------------------------------------------------

## ğŸ”„ Upsert

Insert new records **or update existing ones** on conflict.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 26%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Records</th>
<th>SQL Generated</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#upsert"><code>upsert</code></a></td>
<td>Single</td>
<td><code>ON CONFLICT DO UPDATE</code> (PG) /
<code>INSERT OR REPLACE</code> (SQLite)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_upsert"><code>bulk_upsert</code></a></td>
<td>Multiple</td>
<td>Same, with batch execution</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Syncing external API data, refreshing caches, user
> settings

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L166"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_upsert

``` python

def bulk_upsert(
    db:Database, table_name:str, records:List, conflict_cols:List, update_cols:Optional=None, auto_commit:bool=True
)->None:

```

*Insert or update multiple records (optimized batch operation).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L129"
target="_blank" style="float:right; font-size:smaller">source</a>

### upsert

``` python

def upsert(
    db:Database, table_name:str, record:Dict, conflict_cols:List, update_cols:Optional=None, auto_commit:bool=True
)->None:

```

*Insert a record or update if it exists (upsert).*

------------------------------------------------------------------------

## ğŸ“ CRUD

Standard Create, Read, Update, Delete operations.

<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 32%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Operation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#get_by_id"><code>get_by_id</code></a></td>
<td><strong>Read</strong></td>
<td>Fetch single record by primary key</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#update_record"><code>update_record</code></a></td>
<td><strong>Update</strong></td>
<td>Modify record fields by ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#delete_record"><code>delete_record</code></a></td>
<td><strong>Delete</strong></td>
<td>Remove single record by ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#bulk_delete"><code>bulk_delete</code></a></td>
<td><strong>Delete</strong></td>
<td>Remove multiple records by ID list</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L251"
target="_blank" style="float:right; font-size:smaller">source</a>

### bulk_delete

``` python

def bulk_delete(
    db:Database, table_name:str, id_list:List, id_col:str='id', auto_commit:bool=True
)->None:

```

*Delete multiple records by ID list.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L237"
target="_blank" style="float:right; font-size:smaller">source</a>

### delete_record

``` python

def delete_record(
    db:Database, table_name:str, id_value:Any, id_col:str='id', auto_commit:bool=True
)->None:

```

*Delete a single record by ID.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L216"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_record

``` python

def update_record(
    db:Database, table_name:str, id_value:Any, id_col:str='id', auto_commit:bool=True, updates:VAR_KEYWORD
)->None:

```

*Update a single record by ID.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L206"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_by_id

``` python

def get_by_id(
    db:Database, table_name:str, id_value:Any, id_col:str='id'
)->Any:

```

*Get a single record by ID.*

------------------------------------------------------------------------

## ğŸ”§ Utilities

Transaction management, pagination, and batch processing.

<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#with_transaction"><code>with_transaction</code></a></td>
<td>Context manager for atomic operations</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#paginate_sql"><code>paginate_sql</code></a></td>
<td>Add LIMIT/OFFSET to queries</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#batch_execute"><code>batch_execute</code></a></td>
<td>Process large lists in memory-safe chunks</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L289"
target="_blank" style="float:right; font-size:smaller">source</a>

### batch_execute

``` python

def batch_execute(
    db:Database, operation_func, items:List, batch_size:int=100
)->None:

```

*Execute an operation on items in batches with commits after each
batch.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L284"
target="_blank" style="float:right; font-size:smaller">source</a>

### paginate_sql

``` python

def paginate_sql(
    sql:str, page:int, page_size:int
)->str:

```

*Add LIMIT/OFFSET pagination to a SQL query.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L275"
target="_blank" style="float:right; font-size:smaller">source</a>

### with_transaction

``` python

def with_transaction(
    db:Database
):

```

*Context manager for safe transaction handling with auto-rollback on
error.*

------------------------------------------------------------------------

## ğŸ’° Money Helpers

Convert between dollar amounts and integer cents for database storage.

> âš ï¸ **Why cents?** fastsql only supports `int` and `str` types â€”
> storing money as cents avoids floating-point precision issues.

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Direction</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#to_cents"><code>to_cents</code></a></td>
<td><code>"$150.00"</code> â†’ <code>15000</code></td>
<td>Store in DB</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_sql.html#from_cents"><code>from_cents</code></a></td>
<td><code>15000</code> â†’ <code>"$150.00"</code></td>
<td>Display to user</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L303"
target="_blank" style="float:right; font-size:smaller">source</a>

### to_cents

``` python

def to_cents(
    dollars:str | float | None
)->int | None:

```

*Convert dollar amount to integer cents for database storage.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_sql.py#L313"
target="_blank" style="float:right; font-size:smaller">source</a>

### from_cents

``` python

def from_cents(
    cents:int | None
)->str:

```

*Convert integer cents to formatted dollar string for display.*


========================================

FILE: _proc/03_utils_bgtsk.html.md

# âš¡ Background Tasks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 40%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Components</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ“¦ Model</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#tenantjob"><code>TenantJob</code></a></td>
<td>Tenant-level job record with retry support</td>
</tr>
<tr>
<td>âš¡ Manager</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_bgtsk.html#backgroundtaskmanager"><code>BackgroundTaskManager</code></a></td>
<td>Submit, execute, and track background tasks</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    FastHTML Route                               â”‚
    â”‚  return response, bg_task  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚                    â”‚
                                  â–¼                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 BackgroundTaskManager                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  submit()           â†’ Create job + return BackgroundTask        â”‚
    â”‚  _execute_with_retry() â†’ Run with auto-retry on failure         â”‚
    â”‚  get_job()          â†’ Check job status                          â”‚
    â”‚  list_jobs()        â†’ Query jobs by type/status                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Retry Logic: 2^n seconds backoff (2s, 4s, 8s)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Tenant Database                              â”‚
    â”‚                    â””â”€â”€ tenant_jobs table                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“š Quick Reference

### Job Status Flow

    pending â†’ running â†’ completed
        â†‘        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â†’ failed (after max retries)

### Usage Pattern

``` python
# In your FastHTML route
manager = BackgroundTaskManager(tenant_db)
job_id, bg_task = manager.submit("sync_data", my_sync_func, user_id="123")
return response, bg_task  # Starlette runs bg_task after response
```

------------------------------------------------------------------------

## ğŸ“¦ TenantJob Model

Tracks background jobs at the tenant level with retry support.

<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>str</td>
<td>Unique job identifier</td>
</tr>
<tr>
<td><code>job_type</code></td>
<td>str</td>
<td>Job category (e.g., â€œsyncâ€, â€œemailâ€)</td>
</tr>
<tr>
<td><code>status</code></td>
<td>str</td>
<td><code>pending</code> / <code>running</code> / <code>completed</code>
/ <code>failed</code></td>
</tr>
<tr>
<td><code>payload</code></td>
<td>str</td>
<td>JSON kwargs passed to task function</td>
</tr>
<tr>
<td><code>result</code></td>
<td>str</td>
<td>JSON result on completion</td>
</tr>
<tr>
<td><code>error_log</code></td>
<td>str</td>
<td>Stack trace on failure</td>
</tr>
<tr>
<td><code>retry_count</code></td>
<td>int</td>
<td>Current retry attempt</td>
</tr>
<tr>
<td><code>max_retries</code></td>
<td>int</td>
<td>Max attempts before marking failed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L26"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantJob

``` python

def TenantJob(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Tenant-level background job with retry support.*

------------------------------------------------------------------------

## âš¡ BackgroundTaskManager

Submit and track background tasks with automatic retry logic.

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>submit</code></td>
<td>Create job and return BackgroundTask for Starlette</td>
</tr>
<tr>
<td><code>get_job</code></td>
<td>Get job status and details by ID</td>
</tr>
<tr>
<td><code>list_jobs</code></td>
<td>Query jobs with optional type/status filters</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Use case**: Long-running operations like syncing data, sending
> emails, or processing uploads

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L41"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager

``` python

def BackgroundTaskManager(
    db:Database
):

```

*Lightweight background task manager for tenant-level operations.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L103"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.list_jobs

``` python

def list_jobs(
    job_type:Optional=None, status:Optional=None, limit:int=100
)->list:

```

*List jobs with optional filtering.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L99"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.get_job

``` python

def get_job(
    job_id:str
)->TenantJob:

```

*Get job status and details.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_bgtsk.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### BackgroundTaskManager.submit

``` python

def submit(
    job_type:str, task_func:Callable, max_retries:int=3, task_kwargs:VAR_KEYWORD
)->tuple:

```

*Submit a new background task for execution.*


========================================

FILE: _proc/09_utils_polars_mapper.html.md

# ğŸ»â€â„ï¸ Data Transforms


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert"><code>map_and_upsert</code></a></td>
<td>Bulk JSONâ†’DB upsert via staging table</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#apply_schema"><code>apply_schema</code></a></td>
<td>Type conversions (dates, booleans, numbers)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Staging Table Pattern                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. df.write_database(staging_table) â†’ fast bulk INSERT        â”‚
    â”‚  2. INSERT ... ON CONFLICT SELECT FROM staging â†’ vectorized    â”‚
    â”‚  3. DROP TABLE staging â†’ cleanup                                â”‚
    â”‚                                                                 â”‚
    â”‚  âš¡ 10-100x faster than row-by-row upserts                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ“¥ Map & Upsert

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame from JSON</td>
</tr>
<tr>
<td><code>table_name</code></td>
<td>Target database table (must exist)</td>
</tr>
<tr>
<td><code>key_col</code></td>
<td>Primary key for ON CONFLICT resolution</td>
</tr>
<tr>
<td><code>db_uri</code></td>
<td>Database connection string</td>
</tr>
<tr>
<td><code>column_map</code></td>
<td>Optional rename map <code>{json_col: db_col}</code></td>
</tr>
<tr>
<td><code>unnest_cols</code></td>
<td>Optional list of nested columns to flatten</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Optional type casting map <code>{col: pl.DataType}</code></td>
</tr>
</tbody>
</table>

**Returns:** `int` - Number of rows affected by the upsert operation

**Staging Table Pattern (10-100x faster than row-by-row):** 1. Write to
temporary staging table (fast bulk insert) 2. Execute
`INSERT ... ON CONFLICT` (database-native, vectorized) 3. Drop staging
table (cleanup)

**Type Casting with `type_map`:**

When API data contains `None` values, Polars may infer incorrect types
(e.g., `String` instead of `Int64`). This causes PostgreSQL type
mismatch errors like:

    column "balance" is of type integer but expression is of type text

Use `type_map` to explicitly cast columns before writing:

``` python
rows = map_and_upsert(
    df=df,
    table_name='accounts',
    key_col='id',
    db_uri=db_uri,
    type_map={
        'balance_current': pl.Int64,
        'balance_available': pl.Int64,
        'balance_limit': pl.Int64
    }
)
print(f"Upserted {rows} rows")
```

**Basic Example:**

``` python
import polars as pl

# JSON from API
json_data = [
    {'user_id_val': 1, 'ABC_1': 'Alice', 'extra': 'ignore'},
    {'user_id_val': 2, 'ABC_1': 'Bob', 'extra': 'ignore'}
]

df = pl.DataFrame(json_data)

rows_affected = map_and_upsert(
    df=df,
    table_name='users',
    key_col='user_id',
    db_uri='sqlite:///app.db',
    column_map={'user_id_val': 'user_id', 'ABC_1': 'name'}
)
print(f"Upserted {rows_affected} users")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### map_and_upsert

``` python

def map_and_upsert(
    df:pl.DataFrame, # The raw Polars DataFrame from JSON
    table_name:str, # Target database table name
    key_col:str, # Primary key column for conflict resolution
    db_uri:str, # SQLAlchemy connection string (e.g., 'sqlite:///db.db' or 'postgresql://...')
    column_map:dict=None, # Optional rename map {json_key: db_col}
    unnest_cols:list[str]=None, # List of Struct columns to flatten
    type_map:dict=None, # Optional type casting map {col_name: pl.DataType}
)->int:

```

*Map JSON data to database columns and upsert using staging table
pattern.*

**Returns:** Number of rows affected by the upsert operation

**Type Casting:** When columns have `None` values, Polars may infer
incorrect types (e.g., String instead of Int64). This causes PostgreSQL
type mismatch errors. Use `type_map` to explicitly cast columns before
writing to the database.

## ğŸ”§ Schema Transformations

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Dict mapping column names to Polars dtypes</td>
</tr>
</tbody>
</table>

**Supported conversions:**

<table>
<thead>
<tr>
<th>Type</th>
<th>Handling</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pl.Date</code></td>
<td>Parses <code>YYYY-MM-DD</code> strings</td>
</tr>
<tr>
<td><code>pl.Datetime</code></td>
<td>Parses datetime strings</td>
</tr>
<tr>
<td><code>pl.Boolean</code></td>
<td>Converts <code>"true"</code>/<code>"false"</code> strings</td>
</tr>
<tr>
<td>Other</td>
<td>Uses <code>cast()</code> (works for numeric types)</td>
</tr>
</tbody>
</table>

**Example:**

``` python
df = pl.DataFrame({
    'created_at': ['2024-01-15', '2024-01-16'],
    'is_active': ['true', 'false'],
    'amount': ['123.45', '678.90']
})

df = apply_schema(df, {
    'created_at': pl.Date,
    'is_active': pl.Boolean,
    'amount': pl.Float64
})
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L133"
target="_blank" style="float:right; font-size:smaller">source</a>

### apply_schema

``` python

def apply_schema(
    df:pl.DataFrame, # Input DataFrame
    type_map:dict, # Column name -> Polars dtype (e.g., {'created_at': pl.Date, 'is_active': pl.Boolean})
)->pl.DataFrame:

```

*Apply explicit type conversions to DataFrame columns.*


========================================

FILE: _proc/16_utils_stripe.html.md

# ğŸ’³ Stripe Utilities


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>âš™ï¸ Configuration</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeconfig"><code>StripeConfig</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeconfig.from_env"><code>StripeConfig.from_env()</code></a></td>
<td>Configure Stripe with env vars or explicit values</td>
</tr>
<tr>
<td>ğŸ’³ Service</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeservice"><code>StripeService</code></a></td>
<td>Unified API for checkouts, subscriptions, webhooks</td>
</tr>
<tr>
<td>ğŸ›’ Checkout</td>
<td><code>create_subscription_checkout</code>,
<code>create_one_time_checkout</code></td>
<td>Generate Stripe checkout sessions</td>
</tr>
<tr>
<td>ğŸ”„ Subscriptions</td>
<td><code>get_subscription</code>, <code>cancel_subscription</code>,
<code>change_plan</code></td>
<td>Manage active subscriptions</td>
</tr>
<tr>
<td>ğŸª Webhooks</td>
<td><code>verify_signature</code>, <code>handle_event</code></td>
<td>Process Stripe webhook events</td>
</tr>
<tr>
<td>ğŸ” Access Control</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#get_active_subscription"><code>get_active_subscription</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#has_active_subscription"><code>has_active_subscription</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#require_active_subscription"><code>require_active_subscription</code></a></td>
<td>Gate features by payment status</td>
</tr>
<tr>
<td>ğŸ“Š Feature Gating</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#check_feature_access"><code>check_feature_access</code></a></td>
<td>Control features by plan tier</td>
</tr>
<tr>
<td>ğŸ›¤ï¸ Route Helpers</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#create_webhook_route"><code>create_webhook_route</code></a>,
<code>create_checkout_route</code>, <a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#create_portal_route"><code>create_portal_route</code></a></td>
<td>FastHTML route factories</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Payment Flow                                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. User clicks "Subscribe" or "Buy"                           â”‚
    â”‚  2. StripeService.create_*_checkout() â†’ Stripe Session          â”‚
    â”‚  3. User completes payment on Stripe                            â”‚
    â”‚  4. Stripe sends webhook â†’ handle_event()                       â”‚
    â”‚  5. Subscription saved to core_subscriptions                    â”‚
    â”‚  6. Access control checks subscription status                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Access Control                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  require_active_subscription(tenant_id)                         â”‚
    â”‚    â”œâ”€ status = 'active' â†’ âœ… Access granted                    â”‚
    â”‚    â”œâ”€ status = 'trialing' â†’ âœ… Access granted                  â”‚
    â”‚    â”œâ”€ status = 'past_due' + within grace â†’ âš ï¸ Access granted   â”‚
    â”‚    â””â”€ Otherwise â†’ ğŸš« 402 Payment Required                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸŒ Environment Variables

<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>Variable</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONFIG_STRIPE_SECRETKEY</code></td>
<td>âœ…</td>
<td>Stripe secret API key (sk_live_* or sk_test_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_WEBHOOKSECRET</code></td>
<td>âœ…</td>
<td>Webhook endpoint signing secret (whsec_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_MONTHLY_PRICE_ID</code></td>
<td>âš ï¸</td>
<td>Pre-created monthly price ID (price_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_YEARLY_PRICE_ID</code></td>
<td>âš ï¸</td>
<td>Pre-created yearly price ID (price_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_BASE_URL</code></td>
<td>âš ï¸</td>
<td>Application base URL for callbacks</td>
</tr>
</tbody>
</table>

> âš ï¸ Price IDs are required for subscription checkouts. Create them in
> Stripe Dashboard first.

------------------------------------------------------------------------

``` python
from nbdev.showdoc import show_doc
```

## âš™ï¸ Configuration

Configure Stripe integration with sensible defaults and environment
variable support.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L30"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeConfig

``` python

def StripeConfig(
    secret_key:str, webhook_secret:str=None, monthly_price_id:str=None, yearly_price_id:str=None, trial_days:int=30,
    grace_period_days:int=3, base_url:str='http://localhost:5001', success_path:str='/payment-success',
    cancel_path:str='/settings/payment', allow_promotions:bool=True, is_development:bool=False,
    feature_tiers:Dict=<factory>
)->None:

```

*Configuration for Stripe integration.*

Supports both subscription and one-time payment modes with configurable
trial periods, grace periods, and callback URLs.

Attributes: secret_key: Stripe secret API key webhook_secret: Webhook
signing secret for signature verification monthly_price_id: Pre-created
Stripe price ID for monthly subscriptions yearly_price_id: Pre-created
Stripe price ID for yearly subscriptions trial_days: Number of days for
free trial (default: 30) grace_period_days: Days to allow access after
payment failure (default: 3) base_url: Application base URL for redirect
callbacks success_path: Path for successful payment redirect
cancel_path: Path for canceled payment redirect allow_promotions: Enable
Stripe promotion codes in checkout is_development: Enable development
mode (skip signature verification)

Example: \>\>\> config = StripeConfig.from_env() \>\>\> service =
StripeService(config)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L74"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeConfig.from_env

``` python

def from_env(
    
)->StripeConfig:

```

*Create StripeConfig from environment variables.*

Reads CONFIG_STRIPE\_\* environment variables with sensible defaults.

Returns: Configured StripeConfig instance

Raises: ValueError: If CONFIG_STRIPE_SECRETKEY is not set

Example: \>\>\> \# Set environment variables first \>\>\>
os.environ\[â€˜CONFIG_STRIPE_SECRETKEYâ€™\] = â€˜sk_test\_â€¦â€™ \>\>\> config =
StripeConfig.from_env()

------------------------------------------------------------------------

## ğŸ’³ Stripe Service

Unified service class for all Stripe operations: checkouts,
subscriptions, and webhooks.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService

``` python

def StripeService(
    config:StripeConfig, host_db:HostDatabase=None
):

```

*Unified Stripe service for payments, subscriptions, and webhooks.*

Consolidates checkout creation, subscription management, and webhook
handling into a single service with consistent patterns.

Attributes: config: StripeConfig instance api: FastStripe API wrapper
host_db: HostDatabase for subscription persistence

Example: \>\>\> config = StripeConfig.from_env() \>\>\> service =
StripeService(config) \>\>\> checkout =
service.create_subscription_checkout( â€¦ plan_type=â€˜monthlyâ€™, â€¦
tenant_id=â€˜tnt_123â€™, â€¦ user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\>
print(checkout.url) \# Redirect user here

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L162"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_subscription_checkout

``` python

def create_subscription_checkout(
    plan_type:str, tenant_id:str, user_email:str, metadata:Dict=None
)->Any:

```

*Create a subscription checkout session with trial.*

Args: plan_type: â€˜monthlyâ€™ or â€˜yearlyâ€™ tenant_id: Tenant ID to associate
subscription with user_email: Customer email for Stripe metadata:
Additional metadata to store with subscription

Returns: Stripe Checkout Session with â€˜urlâ€™ and â€˜idâ€™ attributes

Raises: ValueError: If plan_type is invalid or price ID not configured

Example: \>\>\> checkout = service.create_subscription_checkout( â€¦
plan_type=â€˜monthlyâ€™, â€¦ tenant_id=â€˜tnt_abc123â€™, â€¦
user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\> return
RedirectResponse(checkout.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L230"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_one_time_checkout

``` python

def create_one_time_checkout(
    amount_cents:int, product_name:str, tenant_id:str, user_email:str, currency:str='usd', metadata:Dict=None
)->Any:

```

*Create a one-time payment checkout session.*

Args: amount_cents: Payment amount in cents (e.g., 1999 for $19.99)
product_name: Name displayed on checkout tenant_id: Tenant ID for record
keeping user_email: Customer email for Stripe currency: ISO currency
code (default: â€˜usdâ€™) metadata: Additional metadata to store

Returns: Stripe Checkout Session with â€˜urlâ€™ and â€˜idâ€™ attributes

Example: \>\>\> checkout = service.create_one_time_checkout( â€¦
amount_cents=4999, â€¦ product_name=â€˜Premium Reportâ€™, â€¦
tenant_id=â€˜tnt_abc123â€™, â€¦ user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\>
return RedirectResponse(checkout.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L298"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_customer_portal_session

``` python

def create_customer_portal_session(
    customer_id:str, return_url:str=None
)->Any:

```

*Create a Stripe Customer Portal session for self-service billing.*

Args: customer_id: Stripe customer ID (cus\_\*) return_url: URL to
redirect after portal session (default: base_url)

Returns: Portal session with â€˜urlâ€™ attribute

Example: \>\>\> portal =
service.create_customer_portal_session(â€˜cus_123â€™) \>\>\> return
RedirectResponse(portal.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L342"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.cancel_subscription

``` python

def cancel_subscription(
    subscription_id:str, at_period_end:bool=True
)->Any:

```

*Cancel a subscription.*

Args: subscription_id: Stripe subscription ID at_period_end: If True,
cancel at end of billing period (default) If False, cancel immediately

Returns: Updated Stripe Subscription object

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L441"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.handle_event

``` python

def handle_event(
    event:Dict
)->Dict:

```

*Route webhook event to appropriate handler.*

Handles both subscription and one-time payment events.

Args: event: Parsed Stripe event dict

Returns: Dict with â€˜statusâ€™ (â€˜successâ€™, â€˜warningâ€™, â€˜errorâ€™, â€˜ignoredâ€™)
and â€˜messageâ€™ describing the result

------------------------------------------------------------------------

## ğŸ’° Pricing Plans

Database-backed pricing tiers for multi-tier subscription management.
Store your Stripe price IDs in the database for admin-configurable
pricing without code changes.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L740"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_pricing_plans

``` python

def get_pricing_plans(
    host_db:HostDatabase=None, active_only:bool=True
)->List:

```

*Get all pricing plans from the database.*

Retrieves pricing plan configurations stored in the `core_pricing_plans`
table. Plans define available subscription tiers with their Stripe price
IDs, amounts, features, and display settings.

Args: host_db: Optional HostDatabase instance. Uses from_env() if not
provided. active_only: If True (default), only returns plans where
is_active=True. Set to False to include inactive/archived plans.

Returns: List of PricingPlan objects sorted by sort_order, then by
tier_level. Empty list if no plans are configured.

Example: \>\>\> \# Get all active plans for pricing page \>\>\> plans =
get_pricing_plans() \>\>\> for plan in plans: â€¦ print(fâ€{plan.name}:
${plan.amount_monthly/100}/moâ€) Basic Plan: $7.99/mo Pro Plan: $19.99/mo
Enterprise Plan: $49.99/mo

    >>> # Get specific plan for checkout
    >>> plans = get_pricing_plans()
    >>> pro_plan = next((p for p in plans if p.id == 'pro'), None)
    >>> if pro_plan:
    ...     price_id = pro_plan.stripe_price_monthly

    >>> # Setting up plans (typically in admin or migration)
    >>> from fh_saas.db_host import HostDatabase, PricingPlan, gen_id, timestamp
    >>> host_db = HostDatabase.from_env()
    >>> 
    >>> plans_data = [
    ...     {
    ...         'id': 'basic',
    ...         'name': 'Basic Plan',
    ...         'description': 'Essential features for individuals',
    ...         'stripe_price_monthly': 'price_basic_monthly_xxx',
    ...         'stripe_price_yearly': 'price_basic_yearly_xxx',
    ...         'amount_monthly': 799,   # $7.99
    ...         'amount_yearly': 7990,   # $79.90 (save ~17%)
    ...         'tier_level': 1,
    ...         'features': '["basic_reports", "email_support"]',
    ...         'sort_order': 1,
    ...     },
    ...     {
    ...         'id': 'pro',
    ...         'name': 'Pro Plan', 
    ...         'description': 'Advanced features for teams',
    ...         'stripe_price_monthly': 'price_pro_monthly_xxx',
    ...         'stripe_price_yearly': 'price_pro_yearly_xxx',
    ...         'amount_monthly': 1999,  # $19.99
    ...         'amount_yearly': 19990,  # $199.90
    ...         'tier_level': 2,
    ...         'features': '["basic_reports", "advanced_analytics", "api_access", "priority_support"]',
    ...         'sort_order': 2,
    ...     },
    ...     {
    ...         'id': 'enterprise',
    ...         'name': 'Enterprise Plan',
    ...         'description': 'Full platform access with custom solutions',
    ...         'stripe_price_monthly': 'price_ent_monthly_xxx',
    ...         'stripe_price_yearly': 'price_ent_yearly_xxx',
    ...         'amount_monthly': 4999,  # $49.99
    ...         'amount_yearly': 49990,  # $499.90
    ...         'tier_level': 3,
    ...         'features': '["all_features", "dedicated_support", "custom_integrations", "sla"]',
    ...         'sort_order': 3,
    ...     },
    ... ]
    >>> 
    >>> for plan_data in plans_data:
    ...     plan = PricingPlan(**plan_data, created_at=timestamp())
    ...     host_db.pricing_plans.insert(plan)
    >>> host_db.commit()

Note: - Create your Stripe Products and Prices in the Stripe Dashboard
first - Copy the price IDs (price_xxx) into your database records - The
`tier_level` field is used by
[`check_feature_access()`](https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#check_feature_access)
for feature gating - The `features` field should be a JSON array of
feature keys

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L845"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_pricing_plan

``` python

def get_pricing_plan(
    plan_id:str, host_db:HostDatabase=None
)->Optional:

```

*Get a specific pricing plan by ID.*

Args: plan_id: The plan identifier (e.g., â€˜basicâ€™, â€˜proâ€™, â€˜enterpriseâ€™)
host_db: Optional HostDatabase instance

Returns: PricingPlan object if found, None otherwise

Example: \>\>\> plan = get_pricing_plan(â€˜proâ€™) \>\>\> if plan: â€¦
checkout = service.create_subscription_checkout( â€¦
price_id=plan.stripe_price_monthly, â€¦ â€¦ â€¦ )

------------------------------------------------------------------------

## ğŸ” Access Control

Functions to gate features based on subscription status with grace
period support.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L877"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_active_subscription

``` python

def get_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->Optional:

```

*Get active subscription for a tenant with grace period support.*

Returns subscription if: - Status is â€˜activeâ€™ or â€˜trialingâ€™ - Status is
â€˜past_dueâ€™ but within grace period from current_period_end

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase, uses
from_env() if not provided grace_period_days: Days to allow access after
payment failure (default: 3)

Returns: Active Subscription object, or None if no valid subscription

Example: \>\>\> sub = get_active_subscription(â€˜tnt_123â€™) \>\>\> if sub:
â€¦ print(fâ€Active until {sub.current_period_end}â€œ)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L937"
target="_blank" style="float:right; font-size:smaller">source</a>

### has_active_subscription

``` python

def has_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->bool:

```

*Check if tenant has an active subscription.*

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days to allow access after payment failure

Returns: True if tenant has valid subscription, False otherwise

Example: \>\>\> if has_active_subscription(â€˜tnt_123â€™): â€¦
show_premium_features()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L959"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_active_subscription

``` python

def require_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3, redirect_url:str=None
)->Optional:

```

*Require active subscription, returning 402 if not found.*

Use in route handlers to gate premium features.

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days to allow access after payment failure
redirect_url: Optional URL to redirect instead of 402

Returns: None if subscription is valid (allow access) Response(402) or
RedirectResponse if subscription required

Example: \>\>\> @app.get(â€˜/premium-featureâ€™) \>\>\> def
premium_feature(request): â€¦ error =
require_active_subscription(request.state.tenant_id) â€¦ if error: â€¦
return error â€¦ return render_premium_content()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1000"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_subscription_status

``` python

def get_subscription_status(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->Dict:

```

*Get detailed subscription status for UI display.*

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days for grace period calculation

Returns: Dict with subscription details for UI: - has_subscription:
bool - status: str (â€˜activeâ€™, â€˜trialingâ€™, â€˜past_dueâ€™, â€˜canceledâ€™,
â€˜noneâ€™) - plan_tier: str or None - is_trial: bool - trial_ends_at: str
(ISO) or None - current_period_end: str (ISO) or None - days_remaining:
int or None - in_grace_period: bool - cancel_at_period_end: bool

Example: \>\>\> status = get_subscription_status(â€˜tnt_123â€™) \>\>\> if
status\[â€˜is_trialâ€™\]: â€¦ show_trial_banner(status\[â€˜days_remainingâ€™\])

------------------------------------------------------------------------

## ğŸ“Š Feature Gating

Control access to features based on subscription plan tier.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1109"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_feature_access

``` python

def check_feature_access(
    tenant_id:str, feature:str, feature_tiers:Dict=None, host_db:HostDatabase=None, grace_period_days:int=3
)->bool:

```

*Check if tenantâ€™s plan tier allows access to a feature.*

Args: tenant_id: Tenant ID to check feature: Feature name to check
access for feature_tiers: Optional mapping of feature -\> required tier.
Defaults to {â€˜advanced_analyticsâ€™: â€˜yearlyâ€™, â€¦} host_db: Optional
HostDatabase grace_period_days: Days for grace period

Returns: True if tenantâ€™s plan allows the feature, False otherwise

Example: \>\>\> if check_feature_access(â€˜tnt_123â€™,
â€˜advanced_analyticsâ€™): â€¦ return render_analytics() \>\>\> else: â€¦ return
render_upgrade_prompt()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1161"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_feature_access

``` python

def require_feature_access(
    tenant_id:str, feature:str, feature_tiers:Dict=None, host_db:HostDatabase=None, redirect_url:str=None
)->Optional:

```

*Require feature access, returning 403 if not allowed.*

Args: tenant_id: Tenant ID to check feature: Feature name to check
feature_tiers: Optional feature -\> tier mapping host_db: Optional
HostDatabase redirect_url: Optional URL to redirect instead of 403

Returns: None if access allowed, Response(403) or redirect otherwise

Example: \>\>\> @app.get(â€˜/analyticsâ€™) \>\>\> def analytics(request): â€¦
error = require_feature_access( â€¦ request.state.tenant_id, â€¦
â€˜advanced_analyticsâ€™, â€¦ redirect_url=â€˜/upgradeâ€™ â€¦ ) â€¦ if error: â€¦ return
error â€¦ return render_analytics()

------------------------------------------------------------------------

## ğŸ›¤ï¸ Route Helpers

Ready-to-use FastHTML route factories for Stripe integration.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1205"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_webhook_route

``` python

def create_webhook_route(
    app, service:StripeService, path:str='/stripe/webhook'
):

```

*Create a POST route handler for Stripe webhooks.*

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path for webhook endpoint

Returns: The registered route handler

Example: \>\>\> from fh_saas.utils_stripe import StripeService,
StripeConfig, create_webhook_route \>\>\> config =
StripeConfig.from_env() \>\>\> service = StripeService(config) \>\>\>
create_webhook_route(app, service) \>\>\> \# Webhook now available at
POST /stripe/webhook

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1246"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_subscription_checkout_route

``` python

def create_subscription_checkout_route(
    app, service:StripeService, path:str='/checkout/{plan_type}'
):

```

*Create a GET route for subscription checkout redirect.*

Expects authenticated user with tenant_id in request.state.

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path pattern with {plan_type}
placeholder

Returns: The registered route handler

Example: \>\>\> create_subscription_checkout_route(app, service) \>\>\>
\# Checkout available at GET /checkout/monthly or /checkout/yearly

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1293"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_one_time_checkout_route

``` python

def create_one_time_checkout_route(
    app, service:StripeService, products:Dict, path:str='/buy/{product_id}'
):

```

*Create a GET route for one-time payment checkout.*

Args: app: FastHTML application instance service: Configured
StripeService instance products: Dict mapping product_id to {â€˜nameâ€™:
str, â€˜amount_centsâ€™: int} path: URL path pattern with {product_id}
placeholder

Returns: The registered route handler

Example: \>\>\> products = { â€¦ â€˜reportâ€™: {â€˜nameâ€™: â€˜Premium Reportâ€™,
â€˜amount_centsâ€™: 4999}, â€¦ â€˜creditsâ€™: {â€˜nameâ€™: â€˜100 Creditsâ€™,
â€˜amount_centsâ€™: 1999}, â€¦ } \>\>\> create_one_time_checkout_route(app,
service, products) \>\>\> \# Checkout available at GET /buy/report or
/buy/credits

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1346"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_portal_route

``` python

def create_portal_route(
    app, service:StripeService, path:str='/billing-portal'
):

```

*Create a GET route for Stripe Customer Portal redirect.*

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path for portal endpoint

Returns: The registered route handler

Example: \>\>\> create_portal_route(app, service) \>\>\> \# Portal
available at GET /billing-portal

------------------------------------------------------------------------

## ğŸ­ Service Factory

Singleton pattern for easy service access across the application.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1415"
target="_blank" style="float:right; font-size:smaller">source</a>

### reset_stripe_service

``` python

def reset_stripe_service(
    
):

```

*Reset singleton instance (for testing only).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1392"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_stripe_service

``` python

def get_stripe_service(
    config:StripeConfig=None
)->StripeService:

```

*Get or create singleton StripeService instance.*

Args: config: Optional StripeConfig. Uses from_env() on first call if
not provided.

Returns: StripeService singleton instance

Example: \>\>\> service = get_stripe_service() \>\>\> checkout =
service.create_subscription_checkout(â€¦)

------------------------------------------------------------------------

## ğŸš€ Quick Start

### 1. Set Environment Variables

``` bash
# Required
export CONFIG_STRIPE_SECRETKEY="sk_test_..."
export CONFIG_STRIPE_WEBHOOKSECRET="whsec_..."

# Create prices in Stripe Dashboard, then set IDs
export CONFIG_STRIPE_MONTHLY_PRICE_ID="price_..."
export CONFIG_STRIPE_YEARLY_PRICE_ID="price_..."

# Application URL
export CONFIG_STRIPE_BASE_URL="https://yourapp.com"
```

### 2. Initialize Service & Routes

``` python
from fasthtml.common import FastHTML
from fh_saas.utils_stripe import (
    get_stripe_service,
    create_webhook_route,
    create_subscription_checkout_route,
    create_portal_route,
)

app = FastHTML()
service = get_stripe_service()

# Register routes
create_webhook_route(app, service)
create_subscription_checkout_route(app, service)
create_portal_route(app, service)

# Now available:
# POST /stripe/webhook       - Stripe webhook handler
# GET  /checkout/monthly     - Monthly subscription checkout
# GET  /checkout/yearly      - Yearly subscription checkout
# GET  /billing-portal       - Customer self-service portal
```

### 3. Gate Premium Features

``` python
from fh_saas.utils_stripe import require_active_subscription

@app.get('/premium')
def premium_feature(request):
    error = require_active_subscription(request.state.tenant_id)
    if error:
        return error  # 402 Payment Required
    return render_premium_content()
```

### 4. Integrate with Auth Beforeware

``` python
from fh_saas.utils_auth import create_auth_beforeware

# Optional: Add require_subscription=True to beforeware
# See utils_auth for integration examples
```


========================================

FILE: _proc/17_utils_migrate.html.md

# utils_migrate


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

See [utils_migrate.py](../fh_saas/utils_migrate.py) for the source code.


========================================

FILE: _proc/05_utils_email.html.md

# ğŸ“§ Email Sending


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 36%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>âš™ï¸ Config</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config"><code>get_smtp_config</code></a></td>
<td>Load SMTP settings from env</td>
</tr>
<tr>
<td>ğŸ“ Templates</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path"><code>get_template_path</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template"><code>load_template</code></a></td>
<td>Manage markdown templates</td>
</tr>
<tr>
<td>âœ‰ï¸ Sending</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email"><code>send_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Core send functions</td>
</tr>
<tr>
<td>ğŸ Convenience</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email"><code>send_welcome_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email"><code>send_invitation_email</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email"><code>send_password_reset_email</code></a></td>
<td>Pre-built templates</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Email Sending Flow                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. Load SMTP config from environment variables                 â”‚
    â”‚  2. Load markdown template from templates/ directory            â”‚
    â”‚  3. Substitute template variables (user_name, etc.)             â”‚
    â”‚  4. Convert markdown to HTML via markdown_merge                 â”‚
    â”‚  5. Send via SMTP (Azure, SendGrid, AWS SES, etc.)             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸ“‹ Environment Variables

<table>
<thead>
<tr>
<th>Variable</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SMTP_HOST</code></td>
<td>âœ…</td>
<td>-</td>
<td>SMTP server hostname</td>
</tr>
<tr>
<td><code>SMTP_PORT</code></td>
<td>âŒ</td>
<td>587</td>
<td>SMTP server port</td>
</tr>
<tr>
<td><code>SMTP_USER</code></td>
<td>âœ…</td>
<td>-</td>
<td>Auth username</td>
</tr>
<tr>
<td><code>SMTP_PASSWORD</code></td>
<td>âœ…</td>
<td>-</td>
<td>Auth password</td>
</tr>
<tr>
<td><code>SMTP_MAIL_FROM</code></td>
<td>âœ…</td>
<td>-</td>
<td>Sender email</td>
</tr>
<tr>
<td><code>SMTP_STARTTLS</code></td>
<td>âŒ</td>
<td>True</td>
<td>Use STARTTLS</td>
</tr>
<tr>
<td><code>SMTP_SSL</code></td>
<td>âŒ</td>
<td>False</td>
<td>Use SSL (disables TLS)</td>
</tr>
</tbody>
</table>

## âš™ï¸ SMTP Configuration

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_smtp_config"><code>get_smtp_config</code></a></td>
<td>Load SMTP config from environment vars</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_smtp_config

``` python

def get_smtp_config(
    
)->Dict[str, Any]:

```

*Load SMTP configuration from environment variables.*

## ğŸ“ Template Management

**Built-in Templates:**  
We ship 3 production-ready markdown templates: - `welcome.md` - New user
onboarding - `invitation.md` - Invite users to tenant  
- `password_reset.md` - Password recovery

**Custom Templates:**  
You can provide your own templates by passing `custom_template_path` to
any email function.

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#get_template_path"><code>get_template_path</code></a></td>
<td>Resolve path to template file (built-in or custom)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#load_template"><code>load_template</code></a></td>
<td>Read template content as string</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L82"
target="_blank" style="float:right; font-size:smaller">source</a>

### load_template

``` python

def load_template(
    template_name:str, # Template basename (e.g., 'welcome')
    custom_template_path:Optional[str | Path]=None, # Custom path overrides package templates
)->str:

```

*Load markdown email template as string.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L58"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_template_path

``` python

def get_template_path(
    template_name:str, # Template basename (e.g., 'welcome', 'invitation')
    custom_template_path:Optional[str | Path]=None, # Custom path overrides package templates
)->Path:

```

*Get absolute path to email template file.*

## âœ‰ï¸ Email Sending

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_email"><code>send_email</code></a></td>
<td>Send single email with template</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Send to multiple recipients</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L91"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_email

``` python

def send_email(
    to_email:str, # Recipient email address
    to_name:str, # Recipient display name
    subject:str, # Email subject line
    template_name:str, # Template name: 'welcome', 'invitation', 'password_reset'
    template_vars:Dict[str, str], # Variables to substitute in template
    test:bool=False, # If True, prints email instead of sending
    smtp_config:Optional[Dict[str, Any]]=None, # Custom SMTP config (defaults to env vars)
    custom_template_path:Optional[str | Path]=None, # Custom template path
)->Dict[str, Any]:

```

*Send single email using markdown template with variable substitution.*

## ğŸ“¦ Batch Sending

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_batch_emails"><code>send_batch_emails</code></a></td>
<td>Send personalized emails to multiple recipients</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L170"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_batch_emails

``` python

def send_batch_emails(
    recipients:List[Dict[str, str]], # List of dicts with 'email' and 'name' keys
    subject:str, # Email subject line
    template_name:str, # Template name: 'welcome', 'invitation', 'password_reset'
    template_vars_list:List[Dict[str, str]], # List of variable dicts, one per recipient
    test:bool=False, # If True, prints emails instead of sending
    pause:float=0.2, # Seconds between emails (rate limiting)
    smtp_config:Optional[Dict[str, Any]]=None, # Custom SMTP config
    custom_template_path:Optional[str | Path]=None, # Custom template path
)->List[Dict[str, Any]]:

```

*Send personalized emails to multiple recipients.*

## ğŸ Convenience Functions

Pre-built functions for common email types. All support
`custom_template_path` for using your own templates.

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 34%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Template</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_welcome_email"><code>send_welcome_email</code></a></td>
<td><code>welcome.md</code></td>
<td>New user onboarding</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_invitation_email"><code>send_invitation_email</code></a></td>
<td><code>invitation.md</code></td>
<td>Invite to tenant</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_email.html#send_password_reset_email"><code>send_password_reset_email</code></a></td>
<td><code>password_reset.md</code></td>
<td>Password recovery</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L254"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_welcome_email

``` python

def send_welcome_email(
    to_email:str, # Recipient email address
    to_name:str, # Recipient display name
    user_name:str, # User's name for personalization
    tenant_name:str, # Tenant/organization name
    dashboard_url:str, # URL to user's dashboard
    test:bool=False, # If True, prints email instead of sending
    custom_template_path:Optional[str | Path]=None, # Custom welcome.md template path
)->Dict[str, Any]:

```

*Send welcome email to new user. Template vars: {user_name},
{tenant_name}, {dashboard_url}, {to_email}*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L280"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_invitation_email

``` python

def send_invitation_email(
    to_email:str, # Recipient email address
    to_name:str, # Recipient display name
    inviter_name:str, # Name of person sending invitation
    tenant_name:str, # Tenant/organization name
    invitation_url:str, # URL to accept invitation
    test:bool=False, # If True, prints email instead of sending
    custom_template_path:Optional[str | Path]=None, # Custom invitation.md template path
)->Dict[str, Any]:

```

*Send invitation email. Template vars: {inviter_name}, {tenant_name},
{invitation_url}, {to_email}*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_email.py#L306"
target="_blank" style="float:right; font-size:smaller">source</a>

### send_password_reset_email

``` python

def send_password_reset_email(
    to_email:str, # Recipient email address
    to_name:str, # Recipient display name
    user_name:str, # User's name for personalization
    reset_url:str, # Secure password reset URL
    test:bool=False, # If True, prints email instead of sending
    custom_template_path:Optional[str | Path]=None, # Custom password_reset.md template path
)->Dict[str, Any]:

```

*Send password reset email. Template vars: {user_name}, {reset_url},
{to_email}*

## ğŸ“ Template Customization

### Built-in Templates

The package ships with 3 production-ready templates in
`fh_saas/templates/`:

<table>
<colgroup>
<col style="width: 47%" />
<col style="width: 52%" />
</colgroup>
<thead>
<tr>
<th>Template</th>
<th>Variables</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>welcome.md</code></td>
<td><code>{user_name}</code>, <code>{tenant_name}</code>,
<code>{dashboard_url}</code>, <code>{to_email}</code></td>
</tr>
<tr>
<td><code>invitation.md</code></td>
<td><code>{inviter_name}</code>, <code>{tenant_name}</code>,
<code>{invitation_url}</code>, <code>{to_email}</code></td>
</tr>
<tr>
<td><code>password_reset.md</code></td>
<td><code>{user_name}</code>, <code>{reset_url}</code>,
<code>{to_email}</code></td>
</tr>
</tbody>
</table>

### Creating Custom Templates

1.  Copy a built-in template as a starting point
2.  Modify the markdown and keep variable names in `{brackets}`
3.  Pass `custom_template_path='/path/to/template.md'` to any function

Templates use **markdown_merge** format - standard markdown with
`{variable}` placeholders.


========================================

FILE: _proc/11_utils_blog.html.md

# ğŸ“ Blog Publishing


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Class</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#postloader"><code>PostLoader</code></a></td>
<td>Load markdown posts from filesystem</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_blog.html#markdownengine"><code>MarkdownEngine</code></a></td>
<td>Render markdown to SEO-friendly HTML</td>
</tr>
</tbody>
</table>

## ğŸ“‚ PostLoader

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.load_posts()</code></td>
<td>Load all posts sorted by date</td>
</tr>
<tr>
<td><code>.get_post()</code></td>
<td>Get single post by slug</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L34"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader

``` python

def PostLoader(
    posts_dir:str, # Directory containing .md files
):

```

*Load and parse markdown blog posts from filesystem*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L41"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader.load_posts

``` python

def load_posts(
    
)->List[Dict]:

```

*Load all markdown posts from directory.*

Returns list of post dicts sorted by date (newest first). Each post
contains: title, date, slug, body, categories, author, series.

Example: \`\`\`python loader = PostLoader(â€˜blog/postsâ€™) posts =
loader.load_posts()

    for post in posts:
        print(f"{post['title']} - {post['slug']}")
    ```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### PostLoader.get_post

``` python

def get_post(
    slug:str
)->Optional[Dict]: # URL slug (e.g., 'my-post')

```

*Get single post by slug.*

Example:
`python     post = loader.get_post('bg0010')     if post:         print(post['title'])`

## ğŸ¨ MarkdownEngine

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.render()</code></td>
<td>Convert markdown to HTML</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L96"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine

``` python

def MarkdownEngine(
    
):

```

*Render markdown to HTML with SEO extensions*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L117"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine.render

``` python

def render(
    content:str
)->str: # Markdown content

```

*Convert markdown to HTML.*

        Returns HTML string with proper semantic tags for SEO.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Hello

This is **bold**.â€™) print(html) \#
<h1>

Hello
</h1>

<p>

This is <strong>bold</strong>.
</p>

            ```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_blog.py#L133"
target="_blank" style="float:right; font-size:smaller">source</a>

### MarkdownEngine.get_toc

``` python

def get_toc(
    
)->str:

```

*Get table of contents HTML from last render.*

        Must call render() first. Returns empty string if no headings.

        Example:
            ```python
            engine = MarkdownEngine()
            html = engine.render('# Title

## Section 1

## Section 2â€™)

            toc = engine.get_toc()
            print(toc)  # <ul><li><a href="#section-1">Section 1</a>...</li></ul>
            ```

## FastHTML Integration Example

Basic pattern for server-side rendering with FastHTML:

``` python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog')
def blog_index():
    posts = loader.load_posts()
    return Titled('Blog',
        *[Article(
            H2(A(p['title'], href=f"/blog/{p['slug']}")),
            P(p['description']),
            Small(p['date'].strftime('%Y-%m-%d') if p['date'] else '')
        ) for p in posts]
    )

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    html_content = engine.render(post['body'])
    toc = engine.get_toc()
    
    return Titled(post['title'],
        Article(
            NotStr(toc),  # Table of contents
            NotStr(html_content)  # Rendered markdown
        )
    )
```


========================================

FILE: _proc/12_utils_seo.html.md

# ğŸ” SEO & Sitemaps


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags"><code>generate_head_tags</code></a></td>
<td>Meta tags for social sharing</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml"><code>generate_sitemap_xml</code></a></td>
<td>XML sitemap for crawlers</td>
</tr>
<tr>
<td><code>generate_json_ld</code></td>
<td>Structured data (Article schema)</td>
</tr>
</tbody>
</table>

## ğŸ·ï¸ Meta Tags

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_head_tags"><code>generate_head_tags</code></a></td>
<td>OpenGraph, Twitter Card, canonical</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L16"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_head_tags

``` python

def generate_head_tags(
    title:str, # Page title
    description:str, # Page description (150-160 chars optimal)
    url:str, # Canonical URL
    image_url:Optional[str]=None, # OpenGraph image URL
    article_published:Optional[datetime]=None, # Publication date
    article_modified:Optional[datetime]=None, # Last modified date
    author:Optional[str]=None, # Author name
)->List[tuple]:

```

*Generate meta tags for SEO.*

Returns list of (tag_name, attributes_dict) tuples for FastHTML
components. Includes standard, OpenGraph, and Twitter Card tags.

Example: \`\`\`python from fasthtml.common import \*

    tags = generate_head_tags(
        title='My Blog Post',
        description='Learn about Python',
        url='https://example.com/blog/my-post',
        image_url='https://example.com/image.jpg'
    )

    # Use in FastHTML app
    @app.get('/blog/my-post')
    def post():
        return Html(
            Head(
                *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
                  for tag, attrs in tags]
            ),
            Body('...')
        )
    ```

## ğŸ—ºï¸ Sitemap

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_seo.html#generate_sitemap_xml"><code>generate_sitemap_xml</code></a></td>
<td>XML sitemap for search crawlers</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L103"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_sitemap_xml

``` python

def generate_sitemap_xml(
    posts:List[Dict], # List of posts from PostLoader
    base_url:str, # Base URL (e.g., 'https://example.com')
    blog_path:str='/blog', # Blog path prefix
)->str:

```

*Generate XML sitemap for blog posts.*

Returns sitemap XML string with proper structure and lastmod dates.

Example: \`\`\`python from fasthtml.common import \* from
fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/sitemap.xml')
    def sitemap():
        posts = loader.load_posts()
        xml = generate_sitemap_xml(
            posts=posts,
            base_url='https://example.com',
            blog_path='/blog'
        )
        return Response(xml, media_type='application/xml')
    ```

## rss feed generator

Generate RSS 2.0 feed for blog subscribers.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_seo.py#L162"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_rss_xml

``` python

def generate_rss_xml(
    posts:List[Dict], # List of posts from PostLoader
    blog_title:str, # Blog title
    blog_description:str, # Blog description
    base_url:str, # Base URL
    blog_path:str='/blog', # Blog path prefix
)->str:

```

*Generate RSS 2.0 feed for blog posts.*

Returns RSS XML string for feed readers (Feedly, etc.).

Example: \`\`\`python from fasthtml.common import \* from
fh_saas.utils_blog import PostLoader

    app = FastHTML()
    loader = PostLoader('blog/posts')

    @app.get('/rss.xml')
    def rss():
        posts = loader.load_posts()[:20]  # Latest 20 posts
        xml = generate_rss_xml(
            posts=posts,
            blog_title='My Blog',
            blog_description='Tech tutorials and insights',
            base_url='https://example.com'
        )
        return Response(xml, media_type='application/xml')
    ```

## FastHTML Integration Example

Complete SEO setup with FastHTML:

``` python
from fasthtml.common import *
from fh_saas.utils_blog import PostLoader, MarkdownEngine
from fh_saas.utils_seo import generate_head_tags, generate_sitemap_xml, generate_rss_xml

app = FastHTML()
loader = PostLoader('blog/posts')
engine = MarkdownEngine()

@app.get('/blog/{slug}')
def blog_post(slug: str):
    post = loader.get_post(slug)
    if not post:
        return 'Post not found', 404
    
    # Generate SEO tags
    tags = generate_head_tags(
        title=post['title'],
        description=post['description'] or post['body'][:160],
        url=f"https://example.com/blog/{slug}",
        image_url=post.get('image'),
        article_published=post['date'],
        author=post.get('author')
    )
    
    # Render markdown
    html_content = engine.render(post['body'])
    
    return Html(
        Head(
            Title(post['title']),
            *[Meta(**attrs) if tag == 'meta' else Link(**attrs) 
              for tag, attrs in tags]
        ),
        Body(
            Article(NotStr(html_content))
        )
    )

@app.get('/sitemap.xml')
def sitemap():
    posts = loader.load_posts()
    xml = generate_sitemap_xml(posts, 'https://example.com')
    return Response(xml, media_type='application/xml')

@app.get('/rss.xml')
def rss():
    posts = loader.load_posts()[:20]
    xml = generate_rss_xml(
        posts=posts,
        blog_title='My Blog',
        blog_description='Tech tutorials',
        base_url='https://example.com'
    )
    return Response(xml, media_type='application/xml')
```


========================================

FILE: _proc/13_utils_workflow.html.md

# ğŸ”§ Workflow Engine


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Class</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_workflow.html#workflow"><code>Workflow</code></a></td>
<td>Execute callable steps sequentially</td>
</tr>
</tbody>
</table>

## ğŸ”§ Workflow Class

<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Workflow(steps)</code></td>
<td>Initialize with list of callables</td>
</tr>
<tr>
<td><code>.execute()</code></td>
<td>Run all steps sequentially</td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import *
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L13"
target="_blank" style="float:right; font-size:smaller">source</a>

### Workflow

``` python

def Workflow(
    steps:List
):

```

*Execute a list of callables sequentially. Minimal wrapper for code
readability.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_workflow.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### Workflow.execute

``` python

def execute(
    
):

```

*Execute all steps in order*


========================================

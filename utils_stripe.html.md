# ğŸ’³ Stripe Utilities


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 37%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr>
<th>Category</th>
<th>Functions</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>âš™ï¸ Configuration</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeconfig"><code>StripeConfig</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeconfig.from_env"><code>StripeConfig.from_env()</code></a></td>
<td>Configure Stripe with env vars or explicit values</td>
</tr>
<tr>
<td>ğŸ’³ Service</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#stripeservice"><code>StripeService</code></a></td>
<td>Unified API for checkouts, subscriptions, webhooks</td>
</tr>
<tr>
<td>ğŸ›’ Checkout</td>
<td><code>create_subscription_checkout</code>,
<code>create_one_time_checkout</code></td>
<td>Generate Stripe checkout sessions</td>
</tr>
<tr>
<td>ğŸ”„ Subscriptions</td>
<td><code>get_subscription</code>, <code>cancel_subscription</code>,
<code>change_plan</code></td>
<td>Manage active subscriptions</td>
</tr>
<tr>
<td>ğŸª Webhooks</td>
<td><code>verify_signature</code>, <code>handle_event</code></td>
<td>Process Stripe webhook events</td>
</tr>
<tr>
<td>ğŸ” Access Control</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#get_active_subscription"><code>get_active_subscription</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#has_active_subscription"><code>has_active_subscription</code></a>,
<a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#require_active_subscription"><code>require_active_subscription</code></a></td>
<td>Gate features by payment status</td>
</tr>
<tr>
<td>ğŸ“Š Feature Gating</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#check_feature_access"><code>check_feature_access</code></a></td>
<td>Control features by plan tier</td>
</tr>
<tr>
<td>ğŸ›¤ï¸ Route Helpers</td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#create_webhook_route"><code>create_webhook_route</code></a>,
<code>create_checkout_route</code>, <a
href="https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#create_portal_route"><code>create_portal_route</code></a></td>
<td>FastHTML route factories</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Payment Flow                                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. User clicks "Subscribe" or "Buy"                           â”‚
    â”‚  2. StripeService.create_*_checkout() â†’ Stripe Session          â”‚
    â”‚  3. User completes payment on Stripe                            â”‚
    â”‚  4. Stripe sends webhook â†’ handle_event()                       â”‚
    â”‚  5. Subscription saved to core_subscriptions                    â”‚
    â”‚  6. Access control checks subscription status                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Access Control                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  require_active_subscription(tenant_id)                         â”‚
    â”‚    â”œâ”€ status = 'active' â†’ âœ… Access granted                    â”‚
    â”‚    â”œâ”€ status = 'trialing' â†’ âœ… Access granted                  â”‚
    â”‚    â”œâ”€ status = 'past_due' + within grace â†’ âš ï¸ Access granted   â”‚
    â”‚    â””â”€ Otherwise â†’ ğŸš« 402 Payment Required                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

## ğŸŒ Environment Variables

<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 30%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>Variable</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CONFIG_STRIPE_SECRETKEY</code></td>
<td>âœ…</td>
<td>Stripe secret API key (sk_live_* or sk_test_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_WEBHOOKSECRET</code></td>
<td>âœ…</td>
<td>Webhook endpoint signing secret (whsec_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_MONTHLY_PRICE_ID</code></td>
<td>âš ï¸</td>
<td>Pre-created monthly price ID (price_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_YEARLY_PRICE_ID</code></td>
<td>âš ï¸</td>
<td>Pre-created yearly price ID (price_*)</td>
</tr>
<tr>
<td><code>CONFIG_STRIPE_BASE_URL</code></td>
<td>âš ï¸</td>
<td>Application base URL for callbacks</td>
</tr>
</tbody>
</table>

> âš ï¸ Price IDs are required for subscription checkouts. Create them in
> Stripe Dashboard first.

------------------------------------------------------------------------

``` python
from nbdev.showdoc import show_doc
```

## âš™ï¸ Configuration

Configure Stripe integration with sensible defaults and environment
variable support.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L30"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeConfig

``` python

def StripeConfig(
    secret_key:str, webhook_secret:str=None, monthly_price_id:str=None, yearly_price_id:str=None, trial_days:int=30,
    grace_period_days:int=3, base_url:str='http://localhost:5001', success_path:str='/payment-success',
    cancel_path:str='/settings/payment', allow_promotions:bool=True, is_development:bool=False,
    feature_tiers:Dict=<factory>
)->None:

```

*Configuration for Stripe integration.*

Supports both subscription and one-time payment modes with configurable
trial periods, grace periods, and callback URLs.

Attributes: secret_key: Stripe secret API key webhook_secret: Webhook
signing secret for signature verification monthly_price_id: Pre-created
Stripe price ID for monthly subscriptions yearly_price_id: Pre-created
Stripe price ID for yearly subscriptions trial_days: Number of days for
free trial (default: 30) grace_period_days: Days to allow access after
payment failure (default: 3) base_url: Application base URL for redirect
callbacks success_path: Path for successful payment redirect
cancel_path: Path for canceled payment redirect allow_promotions: Enable
Stripe promotion codes in checkout is_development: Enable development
mode (skip signature verification)

Example: \>\>\> config = StripeConfig.from_env() \>\>\> service =
StripeService(config)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L74"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeConfig.from_env

``` python

def from_env(
    
)->StripeConfig:

```

*Create StripeConfig from environment variables.*

Reads CONFIG_STRIPE\_\* environment variables with sensible defaults.

Returns: Configured StripeConfig instance

Raises: ValueError: If CONFIG_STRIPE_SECRETKEY is not set

Example: \>\>\> \# Set environment variables first \>\>\>
os.environ\[â€˜CONFIG_STRIPE_SECRETKEYâ€™\] = â€˜sk_test\_â€¦â€™ \>\>\> config =
StripeConfig.from_env()

------------------------------------------------------------------------

## ğŸ’³ Stripe Service

Unified service class for all Stripe operations: checkouts,
subscriptions, and webhooks.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService

``` python

def StripeService(
    config:StripeConfig, host_db:HostDatabase=None
):

```

*Unified Stripe service for payments, subscriptions, and webhooks.*

Consolidates checkout creation, subscription management, and webhook
handling into a single service with consistent patterns.

Attributes: config: StripeConfig instance api: FastStripe API wrapper
host_db: HostDatabase for subscription persistence

Example: \>\>\> config = StripeConfig.from_env() \>\>\> service =
StripeService(config) \>\>\> checkout =
service.create_subscription_checkout( â€¦ plan_type=â€˜monthlyâ€™, â€¦
tenant_id=â€˜tnt_123â€™, â€¦ user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\>
print(checkout.url) \# Redirect user here

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L162"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_subscription_checkout

``` python

def create_subscription_checkout(
    plan_type:str, tenant_id:str, user_email:str, metadata:Dict=None
)->Any:

```

*Create a subscription checkout session with trial.*

Args: plan_type: â€˜monthlyâ€™ or â€˜yearlyâ€™ tenant_id: Tenant ID to associate
subscription with user_email: Customer email for Stripe metadata:
Additional metadata to store with subscription

Returns: Stripe Checkout Session with â€˜urlâ€™ and â€˜idâ€™ attributes

Raises: ValueError: If plan_type is invalid or price ID not configured

Example: \>\>\> checkout = service.create_subscription_checkout( â€¦
plan_type=â€˜monthlyâ€™, â€¦ tenant_id=â€˜tnt_abc123â€™, â€¦
user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\> return
RedirectResponse(checkout.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L230"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_one_time_checkout

``` python

def create_one_time_checkout(
    amount_cents:int, product_name:str, tenant_id:str, user_email:str, currency:str='usd', metadata:Dict=None
)->Any:

```

*Create a one-time payment checkout session.*

Args: amount_cents: Payment amount in cents (e.g., 1999 for $19.99)
product_name: Name displayed on checkout tenant_id: Tenant ID for record
keeping user_email: Customer email for Stripe currency: ISO currency
code (default: â€˜usdâ€™) metadata: Additional metadata to store

Returns: Stripe Checkout Session with â€˜urlâ€™ and â€˜idâ€™ attributes

Example: \>\>\> checkout = service.create_one_time_checkout( â€¦
amount_cents=4999, â€¦ product_name=â€˜Premium Reportâ€™, â€¦
tenant_id=â€˜tnt_abc123â€™, â€¦ user_email=â€˜user@example.comâ€™ â€¦ ) \>\>\>
return RedirectResponse(checkout.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L298"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.create_customer_portal_session

``` python

def create_customer_portal_session(
    customer_id:str, return_url:str=None
)->Any:

```

*Create a Stripe Customer Portal session for self-service billing.*

Args: customer_id: Stripe customer ID (cus\_\*) return_url: URL to
redirect after portal session (default: base_url)

Returns: Portal session with â€˜urlâ€™ attribute

Example: \>\>\> portal =
service.create_customer_portal_session(â€˜cus_123â€™) \>\>\> return
RedirectResponse(portal.url)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L342"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.cancel_subscription

``` python

def cancel_subscription(
    subscription_id:str, at_period_end:bool=True
)->Any:

```

*Cancel a subscription.*

Args: subscription_id: Stripe subscription ID at_period_end: If True,
cancel at end of billing period (default) If False, cancel immediately

Returns: Updated Stripe Subscription object

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L441"
target="_blank" style="float:right; font-size:smaller">source</a>

### StripeService.handle_event

``` python

def handle_event(
    event:Dict
)->Dict:

```

*Route webhook event to appropriate handler.*

Handles both subscription and one-time payment events.

Args: event: Parsed Stripe event dict

Returns: Dict with â€˜statusâ€™ (â€˜successâ€™, â€˜warningâ€™, â€˜errorâ€™, â€˜ignoredâ€™)
and â€˜messageâ€™ describing the result

------------------------------------------------------------------------

## ğŸ’° Pricing Plans

Database-backed pricing tiers for multi-tier subscription management.
Store your Stripe price IDs in the database for admin-configurable
pricing without code changes.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L740"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_pricing_plans

``` python

def get_pricing_plans(
    host_db:HostDatabase=None, active_only:bool=True
)->List:

```

*Get all pricing plans from the database.*

Retrieves pricing plan configurations stored in the `core_pricing_plans`
table. Plans define available subscription tiers with their Stripe price
IDs, amounts, features, and display settings.

Args: host_db: Optional HostDatabase instance. Uses from_env() if not
provided. active_only: If True (default), only returns plans where
is_active=True. Set to False to include inactive/archived plans.

Returns: List of PricingPlan objects sorted by sort_order, then by
tier_level. Empty list if no plans are configured.

Example: \>\>\> \# Get all active plans for pricing page \>\>\> plans =
get_pricing_plans() \>\>\> for plan in plans: â€¦ print(fâ€{plan.name}:
${plan.amount_monthly/100}/moâ€) Basic Plan: $7.99/mo Pro Plan: $19.99/mo
Enterprise Plan: $49.99/mo

    >>> # Get specific plan for checkout
    >>> plans = get_pricing_plans()
    >>> pro_plan = next((p for p in plans if p.id == 'pro'), None)
    >>> if pro_plan:
    ...     price_id = pro_plan.stripe_price_monthly

    >>> # Setting up plans (typically in admin or migration)
    >>> from fh_saas.db_host import HostDatabase, PricingPlan, gen_id, timestamp
    >>> host_db = HostDatabase.from_env()
    >>> 
    >>> plans_data = [
    ...     {
    ...         'id': 'basic',
    ...         'name': 'Basic Plan',
    ...         'description': 'Essential features for individuals',
    ...         'stripe_price_monthly': 'price_basic_monthly_xxx',
    ...         'stripe_price_yearly': 'price_basic_yearly_xxx',
    ...         'amount_monthly': 799,   # $7.99
    ...         'amount_yearly': 7990,   # $79.90 (save ~17%)
    ...         'tier_level': 1,
    ...         'features': '["basic_reports", "email_support"]',
    ...         'sort_order': 1,
    ...     },
    ...     {
    ...         'id': 'pro',
    ...         'name': 'Pro Plan', 
    ...         'description': 'Advanced features for teams',
    ...         'stripe_price_monthly': 'price_pro_monthly_xxx',
    ...         'stripe_price_yearly': 'price_pro_yearly_xxx',
    ...         'amount_monthly': 1999,  # $19.99
    ...         'amount_yearly': 19990,  # $199.90
    ...         'tier_level': 2,
    ...         'features': '["basic_reports", "advanced_analytics", "api_access", "priority_support"]',
    ...         'sort_order': 2,
    ...     },
    ...     {
    ...         'id': 'enterprise',
    ...         'name': 'Enterprise Plan',
    ...         'description': 'Full platform access with custom solutions',
    ...         'stripe_price_monthly': 'price_ent_monthly_xxx',
    ...         'stripe_price_yearly': 'price_ent_yearly_xxx',
    ...         'amount_monthly': 4999,  # $49.99
    ...         'amount_yearly': 49990,  # $499.90
    ...         'tier_level': 3,
    ...         'features': '["all_features", "dedicated_support", "custom_integrations", "sla"]',
    ...         'sort_order': 3,
    ...     },
    ... ]
    >>> 
    >>> for plan_data in plans_data:
    ...     plan = PricingPlan(**plan_data, created_at=timestamp())
    ...     host_db.pricing_plans.insert(plan)
    >>> host_db.commit()

Note: - Create your Stripe Products and Prices in the Stripe Dashboard
first - Copy the price IDs (price_xxx) into your database records - The
`tier_level` field is used by
[`check_feature_access()`](https://abhisheksreesaila.github.io/fh-saas/utils_stripe.html#check_feature_access)
for feature gating - The `features` field should be a JSON array of
feature keys

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L845"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_pricing_plan

``` python

def get_pricing_plan(
    plan_id:str, host_db:HostDatabase=None
)->Optional:

```

*Get a specific pricing plan by ID.*

Args: plan_id: The plan identifier (e.g., â€˜basicâ€™, â€˜proâ€™, â€˜enterpriseâ€™)
host_db: Optional HostDatabase instance

Returns: PricingPlan object if found, None otherwise

Example: \>\>\> plan = get_pricing_plan(â€˜proâ€™) \>\>\> if plan: â€¦
checkout = service.create_subscription_checkout( â€¦
price_id=plan.stripe_price_monthly, â€¦ â€¦ â€¦ )

------------------------------------------------------------------------

## ğŸ” Access Control

Functions to gate features based on subscription status with grace
period support.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L877"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_active_subscription

``` python

def get_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->Optional:

```

*Get active subscription for a tenant with grace period support.*

Returns subscription if: - Status is â€˜activeâ€™ or â€˜trialingâ€™ - Status is
â€˜past_dueâ€™ but within grace period from current_period_end

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase, uses
from_env() if not provided grace_period_days: Days to allow access after
payment failure (default: 3)

Returns: Active Subscription object, or None if no valid subscription

Example: \>\>\> sub = get_active_subscription(â€˜tnt_123â€™) \>\>\> if sub:
â€¦ print(fâ€Active until {sub.current_period_end}â€œ)

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L937"
target="_blank" style="float:right; font-size:smaller">source</a>

### has_active_subscription

``` python

def has_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->bool:

```

*Check if tenant has an active subscription.*

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days to allow access after payment failure

Returns: True if tenant has valid subscription, False otherwise

Example: \>\>\> if has_active_subscription(â€˜tnt_123â€™): â€¦
show_premium_features()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L959"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_active_subscription

``` python

def require_active_subscription(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3, redirect_url:str=None
)->Optional:

```

*Require active subscription, returning 402 if not found.*

Use in route handlers to gate premium features.

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days to allow access after payment failure
redirect_url: Optional URL to redirect instead of 402

Returns: None if subscription is valid (allow access) Response(402) or
RedirectResponse if subscription required

Example: \>\>\> @app.get(â€˜/premium-featureâ€™) \>\>\> def
premium_feature(request): â€¦ error =
require_active_subscription(request.state.tenant_id) â€¦ if error: â€¦
return error â€¦ return render_premium_content()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1000"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_subscription_status

``` python

def get_subscription_status(
    tenant_id:str, host_db:HostDatabase=None, grace_period_days:int=3
)->Dict:

```

*Get detailed subscription status for UI display.*

Args: tenant_id: Tenant ID to check host_db: Optional HostDatabase
grace_period_days: Days for grace period calculation

Returns: Dict with subscription details for UI: - has_subscription:
bool - status: str (â€˜activeâ€™, â€˜trialingâ€™, â€˜past_dueâ€™, â€˜canceledâ€™,
â€˜noneâ€™) - plan_tier: str or None - is_trial: bool - trial_ends_at: str
(ISO) or None - current_period_end: str (ISO) or None - days_remaining:
int or None - in_grace_period: bool - cancel_at_period_end: bool

Example: \>\>\> status = get_subscription_status(â€˜tnt_123â€™) \>\>\> if
status\[â€˜is_trialâ€™\]: â€¦ show_trial_banner(status\[â€˜days_remainingâ€™\])

------------------------------------------------------------------------

## ğŸ“Š Feature Gating

Control access to features based on subscription plan tier.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1109"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_feature_access

``` python

def check_feature_access(
    tenant_id:str, feature:str, feature_tiers:Dict=None, host_db:HostDatabase=None, grace_period_days:int=3
)->bool:

```

*Check if tenantâ€™s plan tier allows access to a feature.*

Args: tenant_id: Tenant ID to check feature: Feature name to check
access for feature_tiers: Optional mapping of feature -\> required tier.
Defaults to {â€˜advanced_analyticsâ€™: â€˜yearlyâ€™, â€¦} host_db: Optional
HostDatabase grace_period_days: Days for grace period

Returns: True if tenantâ€™s plan allows the feature, False otherwise

Example: \>\>\> if check_feature_access(â€˜tnt_123â€™,
â€˜advanced_analyticsâ€™): â€¦ return render_analytics() \>\>\> else: â€¦ return
render_upgrade_prompt()

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1161"
target="_blank" style="float:right; font-size:smaller">source</a>

### require_feature_access

``` python

def require_feature_access(
    tenant_id:str, feature:str, feature_tiers:Dict=None, host_db:HostDatabase=None, redirect_url:str=None
)->Optional:

```

*Require feature access, returning 403 if not allowed.*

Args: tenant_id: Tenant ID to check feature: Feature name to check
feature_tiers: Optional feature -\> tier mapping host_db: Optional
HostDatabase redirect_url: Optional URL to redirect instead of 403

Returns: None if access allowed, Response(403) or redirect otherwise

Example: \>\>\> @app.get(â€˜/analyticsâ€™) \>\>\> def analytics(request): â€¦
error = require_feature_access( â€¦ request.state.tenant_id, â€¦
â€˜advanced_analyticsâ€™, â€¦ redirect_url=â€˜/upgradeâ€™ â€¦ ) â€¦ if error: â€¦ return
error â€¦ return render_analytics()

------------------------------------------------------------------------

## ğŸ›¤ï¸ Route Helpers

Ready-to-use FastHTML route factories for Stripe integration.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1205"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_webhook_route

``` python

def create_webhook_route(
    app, service:StripeService, path:str='/stripe/webhook'
):

```

*Create a POST route handler for Stripe webhooks.*

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path for webhook endpoint

Returns: The registered route handler

Example: \>\>\> from fh_saas.utils_stripe import StripeService,
StripeConfig, create_webhook_route \>\>\> config =
StripeConfig.from_env() \>\>\> service = StripeService(config) \>\>\>
create_webhook_route(app, service) \>\>\> \# Webhook now available at
POST /stripe/webhook

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1246"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_subscription_checkout_route

``` python

def create_subscription_checkout_route(
    app, service:StripeService, path:str='/checkout/{plan_type}'
):

```

*Create a GET route for subscription checkout redirect.*

Expects authenticated user with tenant_id in request.state.

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path pattern with {plan_type}
placeholder

Returns: The registered route handler

Example: \>\>\> create_subscription_checkout_route(app, service) \>\>\>
\# Checkout available at GET /checkout/monthly or /checkout/yearly

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1293"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_one_time_checkout_route

``` python

def create_one_time_checkout_route(
    app, service:StripeService, products:Dict, path:str='/buy/{product_id}'
):

```

*Create a GET route for one-time payment checkout.*

Args: app: FastHTML application instance service: Configured
StripeService instance products: Dict mapping product_id to {â€˜nameâ€™:
str, â€˜amount_centsâ€™: int} path: URL path pattern with {product_id}
placeholder

Returns: The registered route handler

Example: \>\>\> products = { â€¦ â€˜reportâ€™: {â€˜nameâ€™: â€˜Premium Reportâ€™,
â€˜amount_centsâ€™: 4999}, â€¦ â€˜creditsâ€™: {â€˜nameâ€™: â€˜100 Creditsâ€™,
â€˜amount_centsâ€™: 1999}, â€¦ } \>\>\> create_one_time_checkout_route(app,
service, products) \>\>\> \# Checkout available at GET /buy/report or
/buy/credits

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1346"
target="_blank" style="float:right; font-size:smaller">source</a>

### create_portal_route

``` python

def create_portal_route(
    app, service:StripeService, path:str='/billing-portal'
):

```

*Create a GET route for Stripe Customer Portal redirect.*

Args: app: FastHTML application instance service: Configured
StripeService instance path: URL path for portal endpoint

Returns: The registered route handler

Example: \>\>\> create_portal_route(app, service) \>\>\> \# Portal
available at GET /billing-portal

------------------------------------------------------------------------

## ğŸ­ Service Factory

Singleton pattern for easy service access across the application.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1415"
target="_blank" style="float:right; font-size:smaller">source</a>

### reset_stripe_service

``` python

def reset_stripe_service(
    
):

```

*Reset singleton instance (for testing only).*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_stripe.py#L1392"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_stripe_service

``` python

def get_stripe_service(
    config:StripeConfig=None
)->StripeService:

```

*Get or create singleton StripeService instance.*

Args: config: Optional StripeConfig. Uses from_env() on first call if
not provided.

Returns: StripeService singleton instance

Example: \>\>\> service = get_stripe_service() \>\>\> checkout =
service.create_subscription_checkout(â€¦)

------------------------------------------------------------------------

## ğŸš€ Quick Start

### 1. Set Environment Variables

``` bash
# Required
export CONFIG_STRIPE_SECRETKEY="sk_test_..."
export CONFIG_STRIPE_WEBHOOKSECRET="whsec_..."

# Create prices in Stripe Dashboard, then set IDs
export CONFIG_STRIPE_MONTHLY_PRICE_ID="price_..."
export CONFIG_STRIPE_YEARLY_PRICE_ID="price_..."

# Application URL
export CONFIG_STRIPE_BASE_URL="https://yourapp.com"
```

### 2. Initialize Service & Routes

``` python
from fasthtml.common import FastHTML
from fh_saas.utils_stripe import (
    get_stripe_service,
    create_webhook_route,
    create_subscription_checkout_route,
    create_portal_route,
)

app = FastHTML()
service = get_stripe_service()

# Register routes
create_webhook_route(app, service)
create_subscription_checkout_route(app, service)
create_portal_route(app, service)

# Now available:
# POST /stripe/webhook       - Stripe webhook handler
# GET  /checkout/monthly     - Monthly subscription checkout
# GET  /checkout/yearly      - Yearly subscription checkout
# GET  /billing-portal       - Customer self-service portal
```

### 3. Gate Premium Features

``` python
from fh_saas.utils_stripe import require_active_subscription

@app.get('/premium')
def premium_feature(request):
    error = require_active_subscription(request.state.tenant_id)
    if error:
        return error  # 402 Payment Required
    return render_premium_content()
```

### 4. Integrate with Auth Beforeware

``` python
from fh_saas.utils_auth import create_auth_beforeware

# Optional: Add require_subscription=True to beforeware
# See utils_auth for integration examples
```

# ğŸ—„ï¸ Tenant Databases


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

Each tenant gets their own **isolated database** containing:

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td>Local user profiles linked to global identity</td>
</tr>
<tr>
<td>ğŸ” <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td>Fine-grained resource permissions</td>
</tr>
<tr>
<td>âš™ï¸ <a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td>Tenant-wide configuration</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      ğŸ  HOST DATABASE                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
    â”‚  â”‚ TenantCatalog â”‚ â”€â”€â–º Maps tenant_id â†’ database URL           â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚  get_or_create_tenant_db(tenant_id)
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    ğŸ—„ï¸ TENANT DATABASE                           â”‚
    â”‚                    (Isolated per tenant)                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ‘¤ TenantUser      â†’ Local profile (links to GlobalUser.id)   â”‚
    â”‚  ğŸ” TenantPermission â†’ Resource-level access control           â”‚
    â”‚  âš™ï¸ TenantSettings   â†’ Timezone, currency, feature flags       â”‚
    â”‚  ğŸª WebhookEvent     â†’ Idempotent webhook processing           â”‚
    â”‚  ğŸ”‘ WebhookSecret    â†’ HMAC secrets per webhook source         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  ğŸ“Š [Your App Tables] â†’ Transactions, budgets, etc.            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** Tenant data is completely isolated â†’ No cross-tenant
data leakage possible

## ğŸ”Œ Tenant Connection

> âš ï¸ **Naming Convention**: Use **underscores** (not hyphens) in
> `tenant_id` values.
>
> Database names are derived from `tenant_id` (e.g., `tenant_acme_001` â†’
> `t_tenant_acme_001_db`). PostgreSQL and SQLite identifiers work best
> with alphanumeric characters and underscores.
>
> âœ… Good: `tenant_acme_001`, `tenant_finxplorer_prod` âŒ Avoid:
> `tenant-acme-001`, `tenant.finxplorer.prod`

``` python
from nbdev.showdoc import show_doc
```

[`get_or_create_tenant_db()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#get_or_create_tenant_db)
handles the full lifecycle:

1.  ğŸ” **Check** if tenant exists in host database
2.  ğŸ—„ï¸ **Create** physical database if new (PostgreSQL)
3.  ğŸ“ **Register** tenant in
    [`TenantCatalog`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog)
4.  ğŸ”Œ **Return** connection to tenant database

<table>
<colgroup>
<col style="width: 45%" />
<col style="width: 54%" />
</colgroup>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tenant_id</code></td>
<td>Unique tenant identifier (from <a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a>)</td>
</tr>
<tr>
<td><code>tenant_name</code></td>
<td>Optional display name (defaults to tenant_id)</td>
</tr>
</tbody>
</table>

**Returns:** `Database` connection to the tenantâ€™s isolated database

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_or_create_tenant_db

``` python

def get_or_create_tenant_db(
    tenant_id:str, tenant_name:str=None
):

```

*Get or create a tenant database connection by tenant ID.*

âš ï¸ IMPORTANT: Caller is responsible for closing the returned Database
connection by calling `db.conn.close()` and `db.engine.dispose()` when
done.

------------------------------------------------------------------------

## ğŸ“¦ Core Tenant Models

These models provide the infrastructure every tenant needs. Your
app-specific models (transactions, budgets, etc.) build on top of these.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantSettings

``` python

def TenantSettings(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Tenant-wide configuration and feature flags.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L113"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantPermission

``` python

def TenantPermission(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Fine-grained resource permission for a tenant user.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L104"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantUser

``` python

def TenantUser(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Local user profile linked to GlobalUser in host database.*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser"><code>TenantUser</code></a></td>
<td><code>core_tenant_users</code></td>
<td><code>id</code></td>
<td>Links to <code>GlobalUser.id</code>, stores local role &amp;
preferences</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantpermission"><code>TenantPermission</code></a></td>
<td><code>core_permissions</code></td>
<td><code>id</code></td>
<td>Resource + action permissions (RBAC)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantsettings"><code>TenantSettings</code></a></td>
<td><code>core_settings</code></td>
<td><code>id</code></td>
<td>Timezone, currency, feature flags</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”§ Schema Initialization

[`init_tenant_core_schema()`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#init_tenant_core_schema)
creates all infrastructure tables in a tenant database:

    tenant_db = get_or_create_tenant_db("tenant_abc")
    tables = init_tenant_core_schema(tenant_db)

    # Access tables via returned dict
    tables['tenant_users'].insert(user)
    tables['settings'].insert(settings)

**Returns:** Dictionary of table accessors for all core models

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_tenant.py#L132"
target="_blank" style="float:right; font-size:smaller">source</a>

### init_tenant_core_schema

``` python

def init_tenant_core_schema(
    tenant_db:Database
):

```

*Create all core tenant tables and return table accessors.*

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_tenant import get_or_create_tenant_db, init_tenant_core_schema, TenantUser
from fh_saas.db_host import gen_id, timestamp

# Get or create tenant database
tenant_db = get_or_create_tenant_db("tenant_abc123", "Acme Corp")

# Initialize core schema
tables = init_tenant_core_schema(tenant_db)

# Add a tenant user (linked to GlobalUser.id)
user = TenantUser(
    id="global_user_xyz",  # Must match GlobalUser.id
    display_name="John Doe",
    local_role="admin",
    created_at=timestamp()
)
tables['tenant_users'].insert(user)
tenant_db.conn.commit()
```

ğŸ’¡ **Tip:** The `id` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
**must match** the `GlobalUser.id` from the host database to maintain
identity linking.

------------------------------------------------------------------------

## ğŸ” Role-Based Access Control (RBAC)

Every tenant has a **three-tier role system** for controlling access:

### Role Hierarchy

<table>
<thead>
<tr>
<th>Role</th>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin</code></td>
<td>3</td>
<td>Full access to all resources and settings</td>
</tr>
<tr>
<td><code>editor</code></td>
<td>2</td>
<td>Can view and modify data, but not settings</td>
</tr>
<tr>
<td><code>viewer</code></td>
<td>1</td>
<td>Read-only access to data</td>
</tr>
</tbody>
</table>

### Role Assignment Rules

1.  **Tenant owner** (from host `Membership.role='owner'`) â†’
    automatically gets `admin` role
2.  **Other users** â†’ assigned explicitly by admin via
    `TenantUser.local_role`
3.  **No defaults** â†’ admins must explicitly assign roles when inviting
    users

### TenantUser.local_role

The `local_role` field in
[`TenantUser`](https://abhisheksreesaila.github.io/fh-saas/db_tenant.html#tenantuser)
stores the userâ€™s role within the tenant:

``` python
# Example: Admin adds a new user as editor
new_user = TenantUser(
    id=global_user_id,      # Must match GlobalUser.id
    display_name="Jane Doe",
    local_role="editor",    # Assigned by admin
    created_at=timestamp()
)
tables['tenant_users'].insert(new_user)
```

### Fine-Grained Permissions (Optional)

For advanced use cases, the `core_permissions` table allows
resource-level control:

``` python
# Example: Grant user edit access to transactions only
permission = TenantPermission(
    id=gen_id(),
    user_id=tenant_user.id,
    resource="transactions",
    action="edit",
    granted=True,
    created_at=timestamp()
)
tables['permissions'].insert(permission)
```

<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>resource</code></td>
<td>What the permission applies to (e.g., â€œtransactionsâ€,
â€œbudgetsâ€)</td>
</tr>
<tr>
<td><code>action</code></td>
<td>What action is allowed (e.g., â€œviewâ€, â€œeditâ€, â€œdeleteâ€)</td>
</tr>
<tr>
<td><code>granted</code></td>
<td>True = allowed, False = explicitly denied</td>
</tr>
</tbody>
</table>

> ğŸ’¡ **Tip:** Most apps only need the `local_role` field. Use
> `core_permissions` when you need per-resource control (e.g., â€œUser X
> can view transactions but not budgetsâ€).

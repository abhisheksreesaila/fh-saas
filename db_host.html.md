# ğŸ  Multi-Tenant Setup


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

The **Host Database** is the backbone of a multi-tenant architecture. It
answers the critical questions:

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 26%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th>Model</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>ğŸ‘¤ <strong>Who is this person?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td>Identity &amp; authentication</td>
</tr>
<tr>
<td>ğŸ¢ <strong>Where is their data?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td>Database routing</td>
</tr>
<tr>
<td>ğŸ”‘ <strong>What can they access?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td>Access control</td>
</tr>
<tr>
<td>ğŸ’³ <strong>Are they paying?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td>Billing status</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>What happened?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td>Security audit trail</td>
</tr>
<tr>
<td>âš™ï¸ <strong>Background work?</strong></td>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td>Async operations</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚         ğŸ  HOST DATABASE            â”‚
                        â”‚  (Single source of truth)           â”‚
                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚  ğŸ‘¤ GlobalUser    â†’ Identity        â”‚
                        â”‚  ğŸ¢ TenantCatalog â†’ DB Routing      â”‚
                        â”‚  ğŸ”‘ Membership    â†’ Access Control  â”‚
                        â”‚  ğŸ’³ Subscription  â†’ Billing         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                   â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ—„ï¸ Tenant A   â”‚   â”‚ ğŸ—„ï¸ Tenant B   â”‚   â”‚ ğŸ—„ï¸ Tenant C   â”‚
        â”‚   Database    â”‚   â”‚   Database    â”‚   â”‚   Database    â”‚
        â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚   â”‚  (isolated)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Key Principle:** User authenticates once â†’ Host routes to correct
tenant â†’ Tenant data is isolated

## ğŸ› ï¸ Utilities

Helper functions used throughout the host database operations.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L20"
target="_blank" style="float:right; font-size:smaller">source</a>

### gen_id

``` python

def gen_id(
    
):

```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L19"
target="_blank" style="float:right; font-size:smaller">source</a>

### timestamp

``` python

def timestamp(
    
):

```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L23"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_db_uri

``` python

def get_db_uri(
    db
)->str:

```

*Extract SQLAlchemy connection URI from a Database object.*

Safely renders the URL with the actual password (required for utilities
like
[`map_and_upsert`](https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert)
that create new connections).

**Why this is needed:** - `str(db.conn.engine.url)` masks the password
as `***` - This causes â€œpassword authentication failedâ€ errors -
`render_as_string(hide_password=False)` reveals the actual password

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>db</code></td>
<td>fastsql/minidataapi Database object or HostDatabase instance</td>
</tr>
</tbody>
</table>

**Returns:** Full connection URI string with password

**Example:**

``` python
from fh_saas.db_host import get_db_uri, HostDatabase
from fh_saas.utils_polars_mapper import map_and_upsert

host_db = HostDatabase.from_env()
db_uri = get_db_uri(host_db.db)

# Now safe to use with map_and_upsert
map_and_upsert(df, 'my_table', 'id', db_uri)
```

<table>
<colgroup>
<col style="width: 43%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#timestamp"><code>timestamp()</code></a></td>
<td>ğŸ• Returns current UTC time in ISO format</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#gen_id"><code>gen_id()</code></a></td>
<td>ğŸ†” Generates a unique 32-character hex ID</td>
</tr>
<tr>
<td><code>get_db_uri(db)</code></td>
<td>ğŸ”— Extract full connection URI with password from Database
object</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ“¦ Core Models

These dataclasses define the host database schema. Each model maps to a
table with the `core_` or `sys_` prefix.

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L116"
target="_blank" style="float:right; font-size:smaller">source</a>

### PricingPlan

``` python

def PricingPlan(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Pricing: Available subscription tiers with Stripe price IDs.*

Stores pricing configuration in database for admin-configurable tiers.
Each plan can have monthly and/or yearly billing intervals.

Attributes: id: Unique plan identifier (e.g., â€˜basicâ€™, â€˜proâ€™,
â€˜enterpriseâ€™) name: Display name for UI (e.g., â€˜Basic Planâ€™)
description: Plan description for pricing page stripe_price_monthly:
Stripe Price ID for monthly billing (price_xxx) stripe_price_yearly:
Stripe Price ID for yearly billing (price_xxx) amount_monthly: Monthly
price in cents (for display, e.g., 799 = $7.99) amount_yearly: Yearly
price in cents (for display, e.g., 7900 = $79.00) currency: ISO currency
code (default: â€˜usdâ€™) trial_days: Free trial period in days (default:
30) features: JSON array of feature keys enabled for this plan
tier_level: Numeric level for feature gating (higher = more access)
is_active: Whether plan is available for new subscriptions sort_order:
Display order on pricing page created_at: Record creation timestamp

Example: \>\>\> plan = PricingPlan( â€¦ id=â€˜proâ€™, â€¦ name=â€˜Pro Planâ€™, â€¦
stripe_price_monthly=â€˜price_1234â€™, â€¦ stripe_price_yearly=â€˜price_5678â€™, â€¦
amount_monthly=1999, â€¦ amount_yearly=19900, â€¦ tier_level=2, â€¦
features=â€˜\[â€œapi_accessâ€, â€œexportsâ€, â€œpriority_supportâ€\]â€™, â€¦ )

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L110"
target="_blank" style="float:right; font-size:smaller">source</a>

### SystemJob

``` python

def SystemJob(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Maintenance: Provisioning & Cleanups*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L104"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostAuditLog

``` python

def HostAuditLog(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Security: Who changed the system?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L92"
target="_blank" style="float:right; font-size:smaller">source</a>

### Subscription

``` python

def Subscription(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Billing: Are they allowed to use the app?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L86"
target="_blank" style="float:right; font-size:smaller">source</a>

### Membership

``` python

def Membership(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Router: Which tenants can they access?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### TenantCatalog

``` python

def TenantCatalog(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Registry: Where is the database?*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L75"
target="_blank" style="float:right; font-size:smaller">source</a>

### GlobalUser

``` python

def GlobalUser(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Identity: Who is this person?*

### ğŸ“ Model Details

<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 26%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Model</th>
<th>Table Name</th>
<th>Primary Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#globaluser"><code>GlobalUser</code></a></td>
<td><code>core_users</code></td>
<td><code>id</code></td>
<td>OAuth identity, email, optional password hash, Stripe customer
ID</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#tenantcatalog"><code>TenantCatalog</code></a></td>
<td><code>core_tenants</code></td>
<td><code>id</code></td>
<td>Maps tenant ID to database URL, tracks plan tier and status</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#membership"><code>Membership</code></a></td>
<td><code>core_memberships</code></td>
<td><code>id</code></td>
<td>Links users to tenants with roles (<code>owner</code>,
<code>admin</code>, <code>member</code>)</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#subscription"><code>Subscription</code></a></td>
<td><code>core_subscriptions</code></td>
<td><code>id</code></td>
<td>Stripe subscription state for billing enforcement</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#pricingplan"><code>PricingPlan</code></a></td>
<td><code>core_pricing_plans</code></td>
<td><code>id</code></td>
<td>Available subscription tiers with Stripe price IDs</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostauditlog"><code>HostAuditLog</code></a></td>
<td><code>sys_audit_logs</code></td>
<td><code>id</code></td>
<td>Immutable security log for compliance</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/db_host.html#systemjob"><code>SystemJob</code></a></td>
<td><code>sys_jobs</code></td>
<td><code>id</code></td>
<td>Background task queue for provisioning, cleanup</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ”Œ HostDatabase Singleton

The
[`HostDatabase`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase)
class provides a **singleton** connection manager for the host database.

âœ… **Why Singleton?** - Single connection pool shared across the
application - Consistent transaction management - Easy dependency
injection for testing

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Application Start                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  HostDatabase.from_env() â”‚  â† Reads DB_* env vars
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   Creates tables if    â”‚
             â”‚   they don't exist     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Returns singleton     â”‚  â† Same instance everywhere
             â”‚  instance              â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L166"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase

``` python

def HostDatabase(
    db_url:str=None
):

```

*Singleton connection manager for the host database.*

### ğŸ”§ Methods

<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from_env()</code></td>
<td>ğŸ­ Factory method - creates instance from environment variables</td>
</tr>
<tr>
<td><code>commit()</code></td>
<td>âœ… Commit the current database transaction</td>
</tr>
<tr>
<td><code>rollback()</code></td>
<td>â†©ï¸ï¸ Rollback the current transaction on error</td>
</tr>
<tr>
<td><code>reset_instance()</code></td>
<td>ğŸ§ª Reset singleton (testing only)</td>
</tr>
</tbody>
</table>

#### ğŸŒ Environment Variables for `from_env()`

<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_TYPE</code></td>
<td><code>POSTGRESQL</code></td>
<td>Database type (<code>POSTGRESQL</code> or <code>SQLITE</code>)</td>
</tr>
<tr>
<td><code>DB_USER</code></td>
<td><code>postgres</code></td>
<td>Database username</td>
</tr>
<tr>
<td><code>DB_PASS</code></td>
<td><em>(required)</em></td>
<td>Database password</td>
</tr>
<tr>
<td><code>DB_HOST</code></td>
<td><code>localhost</code></td>
<td>Database host</td>
</tr>
<tr>
<td><code>DB_PORT</code></td>
<td><code>5432</code></td>
<td>Database port</td>
</tr>
<tr>
<td><code>DB_NAME</code></td>
<td><code>app_host</code></td>
<td>Database name</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L205"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.from_env

``` python

def from_env(
    
):

```

*Create HostDatabase from DB\_* environment variables.\*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L224"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.commit

``` python

def commit(
    
):

```

*Commit current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L228"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.rollback

``` python

def rollback(
    
):

```

*Rollback current transaction.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/db_host.py#L248"
target="_blank" style="float:right; font-size:smaller">source</a>

### HostDatabase.reset_instance

``` python

def reset_instance(
    
):

```

*Reset singleton instance (testing only).*

âš ï¸ Call close() first to release database connections!

------------------------------------------------------------------------

## ğŸš€ Quick Start

``` python
from fh_saas.db_host import HostDatabase, GlobalUser, gen_id, timestamp

# Initialize singleton from environment
host_db = HostDatabase.from_env()

# Create a user
user = GlobalUser(
    id=gen_id(),
    email="user@example.com",
    oauth_id="google_123",
    created_at=timestamp()
)
host_db.global_users.insert(user)
host_db.commit()

# Query users
all_users = host_db.global_users()
```

ğŸ’¡ **Tip:** The singleton ensures you always get the same connection, so
you can call
[`HostDatabase.from_env()`](https://abhisheksreesaila.github.io/fh-saas/db_host.html#hostdatabase.from_env)
anywhere in your app.

# ğŸ»â€â„ï¸ Data Transforms


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#map_and_upsert"><code>map_and_upsert</code></a></td>
<td>Bulk JSONâ†’DB upsert via staging table</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_polars_mapper.html#apply_schema"><code>apply_schema</code></a></td>
<td>Type conversions (dates, booleans, numbers)</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Staging Table Pattern                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  1. df.write_database(staging_table) â†’ fast bulk INSERT        â”‚
    â”‚  2. INSERT ... ON CONFLICT SELECT FROM staging â†’ vectorized    â”‚
    â”‚  3. DROP TABLE staging â†’ cleanup                                â”‚
    â”‚                                                                 â”‚
    â”‚  âš¡ 10-100x faster than row-by-row upserts                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ“¥ Map & Upsert

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame from JSON</td>
</tr>
<tr>
<td><code>table_name</code></td>
<td>Target database table (must exist)</td>
</tr>
<tr>
<td><code>key_col</code></td>
<td>Primary key for ON CONFLICT resolution</td>
</tr>
<tr>
<td><code>db_uri</code></td>
<td>Database connection string</td>
</tr>
<tr>
<td><code>column_map</code></td>
<td>Optional rename map <code>{json_col: db_col}</code></td>
</tr>
<tr>
<td><code>unnest_cols</code></td>
<td>Optional list of nested columns to flatten</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Optional type casting map <code>{col: pl.DataType}</code></td>
</tr>
</tbody>
</table>

**Returns:** `int` - Number of rows affected by the upsert operation

**Staging Table Pattern (10-100x faster than row-by-row):** 1. Write to
temporary staging table (fast bulk insert) 2. Execute
`INSERT ... ON CONFLICT` (database-native, vectorized) 3. Drop staging
table (cleanup)

**Type Casting with `type_map`:**

When API data contains `None` values, Polars may infer incorrect types
(e.g., `String` instead of `Int64`). This causes PostgreSQL type
mismatch errors like:

    column "balance" is of type integer but expression is of type text

Use `type_map` to explicitly cast columns before writing:

``` python
rows = map_and_upsert(
    df=df,
    table_name='accounts',
    key_col='id',
    db_uri=db_uri,
    type_map={
        'balance_current': pl.Int64,
        'balance_available': pl.Int64,
        'balance_limit': pl.Int64
    }
)
print(f"Upserted {rows} rows")
```

**Basic Example:**

``` python
import polars as pl

# JSON from API
json_data = [
    {'user_id_val': 1, 'ABC_1': 'Alice', 'extra': 'ignore'},
    {'user_id_val': 2, 'ABC_1': 'Bob', 'extra': 'ignore'}
]

df = pl.DataFrame(json_data)

rows_affected = map_and_upsert(
    df=df,
    table_name='users',
    key_col='user_id',
    db_uri='sqlite:///app.db',
    column_map={'user_id_val': 'user_id', 'ABC_1': 'name'}
)
print(f"Upserted {rows_affected} users")
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L21"
target="_blank" style="float:right; font-size:smaller">source</a>

### map_and_upsert

``` python

def map_and_upsert(
    df:pl.DataFrame, # The raw Polars DataFrame from JSON
    table_name:str, # Target database table name
    key_col:str, # Primary key column for conflict resolution
    db_uri:str, # SQLAlchemy connection string (e.g., 'sqlite:///db.db' or 'postgresql://...')
    column_map:dict=None, # Optional rename map {json_key: db_col}
    unnest_cols:list[str]=None, # List of Struct columns to flatten
    type_map:dict=None, # Optional type casting map {col_name: pl.DataType}
)->int:

```

*Map JSON data to database columns and upsert using staging table
pattern.*

**Returns:** Number of rows affected by the upsert operation

**Type Casting:** When columns have `None` values, Polars may infer
incorrect types (e.g., String instead of Int64). This causes PostgreSQL
type mismatch errors. Use `type_map` to explicitly cast columns before
writing to the database.

## ğŸ”§ Schema Transformations

<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>df</code></td>
<td>Polars DataFrame</td>
</tr>
<tr>
<td><code>type_map</code></td>
<td>Dict mapping column names to Polars dtypes</td>
</tr>
</tbody>
</table>

**Supported conversions:**

<table>
<thead>
<tr>
<th>Type</th>
<th>Handling</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pl.Date</code></td>
<td>Parses <code>YYYY-MM-DD</code> strings</td>
</tr>
<tr>
<td><code>pl.Datetime</code></td>
<td>Parses datetime strings</td>
</tr>
<tr>
<td><code>pl.Boolean</code></td>
<td>Converts <code>"true"</code>/<code>"false"</code> strings</td>
</tr>
<tr>
<td>Other</td>
<td>Uses <code>cast()</code> (works for numeric types)</td>
</tr>
</tbody>
</table>

**Example:**

``` python
df = pl.DataFrame({
    'created_at': ['2024-01-15', '2024-01-16'],
    'is_active': ['true', 'false'],
    'amount': ['123.45', '678.90']
})

df = apply_schema(df, {
    'created_at': pl.Date,
    'is_active': pl.Boolean,
    'amount': pl.Float64
})
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_polars_mapper.py#L133"
target="_blank" style="float:right; font-size:smaller">source</a>

### apply_schema

``` python

def apply_schema(
    df:pl.DataFrame, # Input DataFrame
    type_map:dict, # Column name -> Polars dtype (e.g., {'created_at': pl.Date, 'is_active': pl.Boolean})
)->pl.DataFrame:

```

*Apply explicit type conversions to DataFrame columns.*

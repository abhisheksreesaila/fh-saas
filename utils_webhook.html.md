# ğŸª Webhooks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## ğŸ¯ Overview

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 signature verification</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Prevent duplicate processing</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

## ğŸ—ï¸ Architecture

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Webhook Processing Flow                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  Request â†’ Verify Signature â†’ Check Idempotency â†’ Log Event    â”‚
    â”‚     â†“           âœ…              âœ… (not duplicate)              â”‚
    â”‚  Execute Handler â†’ Update Status â†’ Return Response              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## ğŸ” Signature Verification

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#verify_webhook_signature"><code>verify_webhook_signature</code></a></td>
<td>HMAC-SHA256 with timing-safe comparison</td>
</tr>
</tbody>
</table>

``` python
from nbdev.showdoc import *
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

``` python

def verify_webhook_signature(
    payload:str, # Raw request body as string
    signature:str, # Signature from header (format: "sha256=<hex>")
    secret:Optional=None, # Secret key, defaults to WEBHOOK_SECRET env var
)->bool:

```

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

## ğŸ”„ Idempotency

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#check_idempotency"><code>check_idempotency</code></a></td>
<td>Check if event already processed</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

``` python

def check_idempotency(
    db:Database, # Tenant database connection
    idempotency_key:str, # Unique key for this webhook event
)->bool:

```

*Check if webhook event already processed. Returns True if duplicate.*

## ğŸ“ Event Logging

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#log_webhook_event"><code>log_webhook_event</code></a></td>
<td>Persist event to database</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#update_webhook_status"><code>update_webhook_status</code></a></td>
<td>Update status after processing</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

``` python

def log_webhook_event(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system (e.g., "stripe", "github")
    event_type:str, # Event type (e.g., "payment.success")
    payload:Dict, # Full webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    status:str='pending', # Status: pending, processing, completed, failed
):

```

*Log webhook event to database*

## Update Webhook Status

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

``` python

def update_webhook_status(
    db:Database, # Tenant database connection
    webhook_id:str, # Webhook ID to update
    status:str, # New status
    error_message:Optional=None, # Optional error message
):

```

*Update webhook event status and processed timestamp*

## âš¡ Process Webhook

<table>
<colgroup>
<col style="width: 52%" />
<col style="width: 47%" />
</colgroup>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#process_webhook"><code>process_webhook</code></a></td>
<td>Main orchestration function</td>
</tr>
<tr>
<td><a
href="https://abhisheksreesaila.github.io/fh-saas/utils_webhook.html#handle_webhook_request"><code>handle_webhook_request</code></a></td>
<td>FastHTML route handler</td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

``` python

def process_webhook(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system
    event_type:str, # Event type
    payload:Dict, # Webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    raw_body:str, # Raw request body for signature verification
    handler:Callable, # App-specific webhook handler function
    secret:Optional=None, # Optional webhook secret
)->Dict:

```

*Process webhook with verification, idempotency, and custom handler
execution*

``` python
from nbdev.showdoc import show_doc
```

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L25"
target="_blank" style="float:right; font-size:smaller">source</a>

### verify_webhook_signature

``` python

def verify_webhook_signature(
    payload:str, # Raw request body as string
    signature:str, # Signature from header (format: "sha256=<hex>")
    secret:Optional=None, # Secret key, defaults to WEBHOOK_SECRET env var
)->bool:

```

*Verify HMAC-SHA256 signature for webhook payload. Returns True if
valid.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### check_idempotency

``` python

def check_idempotency(
    db:Database, # Tenant database connection
    idempotency_key:str, # Unique key for this webhook event
)->bool:

```

*Check if webhook event already processed. Returns True if duplicate.*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L62"
target="_blank" style="float:right; font-size:smaller">source</a>

### log_webhook_event

``` python

def log_webhook_event(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system (e.g., "stripe", "github")
    event_type:str, # Event type (e.g., "payment.success")
    payload:Dict, # Full webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    status:str='pending', # Status: pending, processing, completed, failed
):

```

*Log webhook event to database*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L85"
target="_blank" style="float:right; font-size:smaller">source</a>

### update_webhook_status

``` python

def update_webhook_status(
    db:Database, # Tenant database connection
    webhook_id:str, # Webhook ID to update
    status:str, # New status
    error_message:Optional=None, # Optional error message
):

```

*Update webhook event status and processed timestamp*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L102"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_webhook

``` python

def process_webhook(
    db:Database, # Tenant database connection
    webhook_id:str, # Unique webhook ID
    source:str, # Source system
    event_type:str, # Event type
    payload:Dict, # Webhook payload
    signature:str, # Request signature
    idempotency_key:str, # Idempotency key
    raw_body:str, # Raw request body for signature verification
    handler:Callable, # App-specific webhook handler function
    secret:Optional=None, # Optional webhook secret
)->Dict:

```

*Process webhook with verification, idempotency, and custom handler
execution*

------------------------------------------------------------------------

<a
href="https://github.com/abhisheksreesaila/fh-saas/blob/main/fh_saas/utils_webhook.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### handle_webhook_request

``` python

def handle_webhook_request(
    request, # FastHTML request object
    db:Database, # Tenant database instance
    source:str, # Webhook source identifier
    handler:Callable, # App-specific handler function
    signature_header:str='X-Webhook-Signature', # Header containing signature
    idempotency_header:str='X-Idempotency-Key', # Header containing idempotency key
    event_type_field:str='type', # Field in payload containing event type
    secret:Optional=None, # Optional webhook secret
)->tuple: # Returns (response_dict, status_code)

```

*FastHTML route handler for webhook requests.*

Example: @app.post(â€˜/webhooks/stripeâ€™) async def
stripe_webhook(request): return await handle_webhook_request(
request=request, db=get_tenant_db(request), source=â€˜stripeâ€™,
handler=handle_stripe_event, signature_header=â€˜X-Stripe-Signatureâ€™,
run_in_background=True )
